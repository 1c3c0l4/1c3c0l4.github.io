<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>《逆向工程实战》 习题 - panic</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="panic"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="panic"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="首先是一个逆向"><meta property="og:type" content="blog"><meta property="og:title" content="《逆向工程实战》 习题"><meta property="og:url" content="http://example.com/2022/07/12/practical-reverse-engineering/"><meta property="og:site_name" content="panic"><meta property="og:description" content="首先是一个逆向"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/2022/07/12/practical-reverse-engineering/image-20220712140307648.png"><meta property="og:image" content="http://example.com/2022/07/12/practical-reverse-engineering/image-20220712144321620.png"><meta property="og:image" content="http://example.com/2022/07/12/practical-reverse-engineering/image-20220712145452405.png"><meta property="og:image" content="http://example.com/2022/07/12/practical-reverse-engineering/image-20220717093057393.png"><meta property="og:image" content="http://example.com/2022/07/12/practical-reverse-engineering/image-20220717093120303.png"><meta property="og:image" content="http://example.com/2022/07/12/practical-reverse-engineering/image-20220717093427863.png"><meta property="og:image" content="http://example.com/2022/07/12/practical-reverse-engineering/image-20220717093535297.png"><meta property="og:image" content="http://example.com/2022/07/12/practical-reverse-engineering/image-20220717101541342.png"><meta property="article:published_time" content="2022-07-12T05:56:35.000Z"><meta property="article:modified_time" content="2022-10-16T15:02:24.604Z"><meta property="article:author" content="lll"><meta property="article:tag" content="windows"><meta property="article:tag" content="notes"><meta property="article:tag" content="reverse-engineering"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/2022/07/12/practical-reverse-engineering/image-20220712140307648.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2022/07/12/practical-reverse-engineering/"},"headline":"《逆向工程实战》 习题","image":["http://example.com/2022/07/12/practical-reverse-engineering/image-20220712140307648.png","http://example.com/2022/07/12/practical-reverse-engineering/image-20220712144321620.png","http://example.com/2022/07/12/practical-reverse-engineering/image-20220712145452405.png","http://example.com/2022/07/12/practical-reverse-engineering/image-20220717093057393.png","http://example.com/2022/07/12/practical-reverse-engineering/image-20220717093120303.png","http://example.com/2022/07/12/practical-reverse-engineering/image-20220717093427863.png","http://example.com/2022/07/12/practical-reverse-engineering/image-20220717093535297.png","http://example.com/2022/07/12/practical-reverse-engineering/image-20220717101541342.png"],"datePublished":"2022-07-12T05:56:35.000Z","dateModified":"2022-10-16T15:02:24.604Z","author":{"@type":"Person","name":"lll"},"publisher":{"@type":"Organization","name":"panic","logo":{"@type":"ImageObject","url":"http://example.com/img/logo.svg"}},"description":"首先是一个逆向"}</script><link rel="canonical" href="http://example.com/2022/07/12/practical-reverse-engineering/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="panic" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/readings">Readings</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-07-12T05:56:35.000Z" title="2022/7/12 下午1:56:35">2022-07-12</time>发表</span><span class="level-item"><time dateTime="2022-10-16T15:02:24.604Z" title="2022/10/16 下午11:02:24">2022-10-16</time>更新</span><span class="level-item">3 小时读完 (大约23301个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">《逆向工程实战》 习题</h1><div class="content"><p>首先是一个逆向</p>
<span id="more"></span>

<h2 id="练习解答"><a href="#练习解答" class="headerlink" title="练习解答"></a>练习解答</h2><p>此部分为书中的练习题解答，不保证正确。（实际上可能错误很多</p>
<p>作者给出的编程题目尽量做了，放在了 Github 上，仅供参考。</p>
<p>如有师傅指正或者交流可以联系我，联系方式见 About。</p>
<h3 id="1-3"><a href="#1-3" class="headerlink" title="1.3"></a>1.3</h3><p><img src="/2022/07/12/practical-reverse-engineering/image-20220712140307648.png" alt="1.3"></p>
<p>[EBP+8] 和 [EBP+C] 的类型可以从 mov 指令的另一个操作数中看出，第一行目的操作数是 edi，所以 [EBP+8] 是 DWORD；第八行目的操作数是 AL，[EBP+C] 是 byte。</p>
<p>第1、2行，从栈上读取参数存入 EDI，并在 EDX 中备份。第三行清空 EAX，第四行将 ECX 设为 -1。</p>
<p>第五行 Scasb 为 Scan String Byte，将 AL（此处为0） 与 EDI 所指的字符串逐字节比较，每次比较后递增 EDI，并递减 ECX。repne 为 Repeat Not Equal，在不相等时重复。在 ECX 不为 0 且 EF 不为 0 时会重复执行后面的指令。在这里，就是查看 EDI 所指向的缓冲区的第一个字节是否为 0，如果是，退出循环，否则查看下一个字节。</p>
<p>第六行和第七行，由于 ECX 最初被设置为 -1，因此将 ECX 加 2 取负数后即为 repne 语句的执行次数，即在 EDI 所指向的缓冲区中第一次查找到 0 之前的字节数（去除结尾 0 之后的字符串长度）。</p>
<p>第八行读取栈上的参数存入 AL，第九行把在 EDX 中备份的 EDI 恢复。</p>
<p>第十行 rep 将执行 ECX 次，stosb 为 Store String Byte，将 AL 存入 EDI 所指的缓冲区，并递增 EDI，递减 ECX。因此本条将用 AL 填充 EDI 所指的缓冲区 0 之前的部分。</p>
<p>第十一行将备份的 EDI 作为返回值。</p>
<p>整个代码段的作用是用某个 BYTE 填充缓冲区中 0 之前的部分。例如缓冲区内容为<code>abc\0def</code>，使用 <code>2</code>填充后结果为<code>222\0def</code>。</p>
<h3 id="1-4"><a href="#1-4" class="headerlink" title="1,4"></a>1,4</h3><p><img src="/2022/07/12/practical-reverse-engineering/image-20220712144321620.png" alt="1.4"></p>
<p>（1）<code>call $+5, pop eax</code>，$+5 是距离当前指令 5 字节的地址，而 call $+5 本身占 5 字节，所以这条指令没有改变执行流，但是将下一条指令的地址（EIP，指向 pop eax 这条指令）压栈了，此时 pop eax，就读到了EIP 的值。x86 不允许直接操作 EIP。</p>
<p>（2）<code>push 0xaabbccdd, ret</code>，或者<code>call 0xaabbccdd</code>。</p>
<p>（3）addme</p>
<p><img src="/2022/07/12/practical-reverse-engineering/image-20220712145452405.png" alt="addme"></p>
<p>如果不 pop ebp，执行 ret 相当于 pop eip，会将 ebp 指向的内容作为代码执行，一般会崩溃。</p>
<p>（4）环境: gcc 11.3.0，WSL（kali）</p>
<p>a.c：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">lladd</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">lladd</span>(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译为 32 位，输出汇编文件，由于是 WSL，汇编是 AT&amp;T 的：</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -S -m<span class="number">32</span> -o a.s a.<span class="keyword">c</span></span><br><span class="line">$ cat a.s</span><br><span class="line"></span><br><span class="line">        .file   <span class="string">&quot;a.c&quot;</span></span><br><span class="line">        .text</span><br><span class="line">        .globl  lladd</span><br><span class="line">        .<span class="keyword">type</span>   lladd<span class="punctuation">,</span> <span class="title">@function</span></span><br><span class="line"><span class="symbol">lladd:</span></span><br><span class="line">.LFB<span class="number">0</span>:</span><br><span class="line">        .cfi_startproc</span><br><span class="line">        pushl   <span class="variable">%ebp</span></span><br><span class="line">        .cfi_def_cfa_offset <span class="number">8</span></span><br><span class="line">        .cfi_offset <span class="number">5</span><span class="punctuation">,</span> <span class="number">-8</span></span><br><span class="line">        movl    <span class="variable">%esp</span><span class="punctuation">,</span> <span class="variable">%ebp</span></span><br><span class="line">        .cfi_def_cfa_register <span class="number">5</span></span><br><span class="line">        <span class="keyword">call</span>    __x<span class="number">86</span>.get_pc_thunk.ax</span><br><span class="line">        addl    $_GLOBAL_OFFSET_TABLE_<span class="punctuation">,</span> <span class="variable">%eax</span></span><br><span class="line">        movl    <span class="number">8</span>(<span class="variable">%ebp</span>)<span class="punctuation">,</span> <span class="variable">%edx</span></span><br><span class="line">        movl    <span class="number">12</span>(<span class="variable">%ebp</span>)<span class="punctuation">,</span> <span class="variable">%eax</span></span><br><span class="line">        addl    <span class="variable">%edx</span><span class="punctuation">,</span> <span class="variable">%eax</span></span><br><span class="line">        cltd</span><br><span class="line">        popl    <span class="variable">%ebp</span></span><br><span class="line">        .cfi_restore <span class="number">5</span></span><br><span class="line">        .cfi_def_cfa <span class="number">4</span><span class="punctuation">,</span> <span class="number">4</span></span><br><span class="line">        <span class="keyword">ret</span></span><br><span class="line">        .cfi_endproc</span><br><span class="line">.LFE<span class="number">0</span>:</span><br><span class="line">        .size   lladd<span class="punctuation">,</span> .-lladd</span><br><span class="line">        .globl  main</span><br><span class="line">        .<span class="keyword">type</span>   main<span class="punctuation">,</span> <span class="title">@function</span></span><br><span class="line"><span class="symbol">main:</span></span><br><span class="line">.LFB<span class="number">1</span>:</span><br><span class="line">        .cfi_startproc</span><br><span class="line">        leal    <span class="number">4</span>(<span class="variable">%esp</span>)<span class="punctuation">,</span> <span class="variable">%ecx</span></span><br><span class="line">        .cfi_def_cfa <span class="number">1</span><span class="punctuation">,</span> <span class="number">0</span></span><br><span class="line">        andl    $<span class="number">-8</span><span class="punctuation">,</span> <span class="variable">%esp</span></span><br><span class="line">        pushl   <span class="number">-4</span>(<span class="variable">%ecx</span>)</span><br><span class="line">        pushl   <span class="variable">%ebp</span></span><br><span class="line">        movl    <span class="variable">%esp</span><span class="punctuation">,</span> <span class="variable">%ebp</span></span><br><span class="line">        .cfi_escape <span class="number">0x10</span><span class="punctuation">,</span><span class="number">0x5</span><span class="punctuation">,</span><span class="number">0x2</span><span class="punctuation">,</span><span class="number">0x75</span><span class="punctuation">,</span><span class="number">0</span></span><br><span class="line">        pushl   <span class="variable">%ecx</span></span><br><span class="line">        .cfi_escape <span class="number">0xf</span><span class="punctuation">,</span><span class="number">0x3</span><span class="punctuation">,</span><span class="number">0x75</span><span class="punctuation">,</span><span class="number">0x7c</span><span class="punctuation">,</span><span class="number">0x6</span></span><br><span class="line">        subl    $<span class="number">4</span><span class="punctuation">,</span> <span class="variable">%esp</span></span><br><span class="line">        <span class="keyword">call</span>    __x<span class="number">86</span>.get_pc_thunk.ax</span><br><span class="line">        addl    $_GLOBAL_OFFSET_TABLE_<span class="punctuation">,</span> <span class="variable">%eax</span></span><br><span class="line">        pushl   $<span class="number">2</span></span><br><span class="line">        pushl   $<span class="number">1</span></span><br><span class="line">        <span class="keyword">call</span>    lladd</span><br><span class="line">        addl    $<span class="number">8</span><span class="punctuation">,</span> <span class="variable">%esp</span></span><br><span class="line">        movl    $<span class="number">0</span><span class="punctuation">,</span> <span class="variable">%eax</span></span><br><span class="line">        movl    <span class="number">-4</span>(<span class="variable">%ebp</span>)<span class="punctuation">,</span> <span class="variable">%ecx</span></span><br><span class="line">        .cfi_def_cfa <span class="number">1</span><span class="punctuation">,</span> <span class="number">0</span></span><br><span class="line">        leave</span><br><span class="line">        .cfi_restore <span class="number">5</span></span><br><span class="line">        leal    <span class="number">-4</span>(<span class="variable">%ecx</span>)<span class="punctuation">,</span> <span class="variable">%esp</span></span><br><span class="line">        .cfi_def_cfa <span class="number">4</span><span class="punctuation">,</span> <span class="number">4</span></span><br><span class="line">        <span class="keyword">ret</span></span><br><span class="line">        .cfi_endproc</span><br><span class="line">.LFE<span class="number">1</span>:</span><br><span class="line">        .size   main<span class="punctuation">,</span> .-main</span><br><span class="line">        .<span class="keyword">section</span>        .text.__x<span class="number">86</span>.get_pc_thunk.ax<span class="punctuation">,</span><span class="string">&quot;axG&quot;</span><span class="punctuation">,</span><span class="title">@progbits</span><span class="punctuation">,</span>__x<span class="number">86</span>.get_pc_thunk.ax<span class="punctuation">,</span>comdat</span><br><span class="line">        .globl  __x<span class="number">86</span>.get_pc_thunk.ax</span><br><span class="line">        .<span class="keyword">hidden</span> __x<span class="number">86</span>.get_pc_thunk.ax</span><br><span class="line">        .<span class="keyword">type</span>   __x<span class="number">86</span>.get_pc_thunk.ax<span class="punctuation">,</span> <span class="title">@function</span></span><br><span class="line">__x<span class="number">86</span>.get_pc_thunk.ax:</span><br><span class="line">.LFB<span class="number">2</span>:</span><br><span class="line">        .cfi_startproc</span><br><span class="line">        movl    (<span class="variable">%esp</span>)<span class="punctuation">,</span> <span class="variable">%eax</span></span><br><span class="line">        <span class="keyword">ret</span></span><br><span class="line">        .cfi_endproc</span><br><span class="line">.LFE<span class="number">2</span>:</span><br><span class="line">        .ident  <span class="string">&quot;GCC: (Debian 11.3.0-3) 11.3.0&quot;</span></span><br><span class="line">        .<span class="keyword">section</span>        .note.GNU-stack<span class="punctuation">,</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span><span class="title">@progbits</span></span><br></pre></td></tr></table></figure>

<p>主要看 lladd 函数，内容用 Intel 汇编应该是这样：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">push</span>	<span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">mov</span>		<span class="built_in">ebp</span>,<span class="built_in">esp</span></span><br><span class="line"><span class="keyword">mov</span>		<span class="built_in">edx</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line"><span class="keyword">mov</span>		<span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">12</span>]</span><br><span class="line"><span class="keyword">cdq</span></span><br><span class="line"><span class="keyword">pop</span>		<span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">ret</span></span><br></pre></td></tr></table></figure>

<p>cdq 是将 EAX 扩展成 QWORD，高 32 位存储在 EDX。EDX 的内容使用 EAX 的符号位填充，当 EAX 为负数时，EDX 为 0xffffffff，EAX 为正数时，EDX 为 0。所以这里的结论就是使用 long long 类型作为返回值时，结果会保存在 EDX:EAX 中（高 32 位存在 EDX，低 32 位存在 EAX）。</p>
<h3 id="1-7"><a href="#1-7" class="headerlink" title="1.7"></a>1.7</h3><p><img src="/2022/07/12/practical-reverse-engineering/image-20220717093057393.png" alt="1.7-1"></p>
<p><img src="/2022/07/12/practical-reverse-engineering/image-20220717093120303.png" alt="1.7-2"></p>
<h4 id="1"><a href="#1" class="headerlink" title="1"></a>1</h4><p><img src="/2022/07/12/practical-reverse-engineering/image-20220717093427863.png" alt="1.6节内容"></p>
<p><img src="/2022/07/12/practical-reverse-engineering/image-20220717093535297.png" alt="1.6内容"></p>
<p>用到的文档：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/dlls/dllmain">DllMain entry point (Process.h) - Win32 apps | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot">CreateToolhelp32Snapshot function (tlhelp32.h) - Win32 apps | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-process32first">Process32First function (tlhelp32.h) - Win32 apps | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-process32next">Process32Next function (tlhelp32.h) - Win32 apps | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-process32next">Process32Next function (tlhelp32.h) - Win32 apps | Microsoft Docs</a></li>
</ul>
<p>栈布局：</p>
<p><img src="/2022/07/12/practical-reverse-engineering/image-20220717101541342.png" alt="栈布局"></p>
<h4 id="2"><a href="#2" class="headerlink" title="2"></a>2</h4><p>反编译：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _IDTR &#123;</span><br><span class="line">	DWORD base,</span><br><span class="line">	WORD limit</span><br><span class="line">&#125; IDTR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> tagPROCESSENTRY32 &#123;</span><br><span class="line">  DWORD     dwSize;</span><br><span class="line">  DWORD     cntUsage;</span><br><span class="line">  DWORD     th32ProcessID;</span><br><span class="line">  ULONG_PTR th32DefaultHeapID;</span><br><span class="line">  DWORD     th32ModuleID;</span><br><span class="line">  DWORD     cntThreads;</span><br><span class="line">  DWORD     th32ParentProcessID;</span><br><span class="line">  LONG      pcPriClassBase;</span><br><span class="line">  DWORD     dwFlags;</span><br><span class="line">  CHAR      szExeFile[MAX_PATH];</span><br><span class="line">&#125; PROCESSENTRY32;</span><br><span class="line"></span><br><span class="line"><span class="built_in">BOOL</span> WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)&#123;</span><br><span class="line">	</span><br><span class="line">	IDTR idt; </span><br><span class="line">	HANDLE hSnapshot;</span><br><span class="line">	PROCESSENTRY32 pe;</span><br><span class="line">	</span><br><span class="line">	__sidt(&amp;idt);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(idt.base &gt; <span class="number">0x8003f400</span> &amp;&amp; idt.base &lt; <span class="number">0x80047400</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	memset(&amp;pe, <span class="number">0</span>, <span class="keyword">sizeof</span>(pe));</span><br><span class="line">	</span><br><span class="line">	hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(hSnapshot == INVALID_HANDLE_VALUE) <span class="keyword">return</span> <span class="literal">FALSE</span>;</span><br><span class="line">	pe.dwSize = <span class="number">128</span>h;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(Process32First(hSnapshot ,&amp;pe) == <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">FALSE</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(stricmp(pe.szExeFile, <span class="number">0x10007c50</span>) != <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="keyword">while</span>(Process32Next(hSnapshot , &amp;pe) != <span class="number">0</span>)&#123;</span><br><span class="line">			<span class="keyword">if</span>(stricmp(pe.szExeFile, <span class="number">0x10007c50</span>) == <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(pe.th32ProcessId - pe.th32ParentProcessId == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">FALSE</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(fdwReason == DLL_PROCESS_ATTACH)&#123;</span><br><span class="line">		CreateThread(<span class="number">0</span>,<span class="number">0</span>,<span class="number">100</span>d32d0h,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">TRUE</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">FALSE</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3"><a href="#3" class="headerlink" title="3"></a>3</h4><p>这种情况是编译器所作的名称修饰（<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/cpp/build/reference/decorated-names?view=msvc-170">修饰名 | Microsoft Docs</a>），文档中描述的比较清晰，具体到 DllMain，由于采用了 STDCALL，所以需要前导下划线；参数列表中包含 12 字节的参数，所以<code>@12</code>。</p>
<h4 id="4"><a href="#4" class="headerlink" title="4"></a>4</h4><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.386</span>	</span><br><span class="line"><span class="meta">.model</span>	flat,c</span><br><span class="line"><span class="meta">public</span>	tttt,strlen1,strchr1</span><br><span class="line"><span class="meta">.code</span></span><br><span class="line">tttt PROC		<span class="comment">;test</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">eax</span>,<span class="number">10</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line"></span><br><span class="line">tttt ENDP	 </span><br><span class="line"></span><br><span class="line">strlen1 proc</span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ebp</span>,<span class="built_in">esp</span></span><br><span class="line"><span class="keyword">mov</span>	 <span class="built_in">edi</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line"><span class="keyword">xor</span> <span class="built_in">eax</span>,<span class="built_in">eax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ecx</span>,<span class="number">0ffffffffh</span></span><br><span class="line"><span class="keyword">repne</span> <span class="keyword">scasb</span></span><br><span class="line"><span class="keyword">add</span>	<span class="built_in">ecx</span>,<span class="number">2</span></span><br><span class="line"><span class="keyword">neg</span> <span class="built_in">ecx</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">eax</span>,<span class="built_in">ecx</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">esp</span>,<span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">ret</span>	</span><br><span class="line">strlen1 endp	</span><br><span class="line"></span><br><span class="line">strchr1 proc	</span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">mov</span>	<span class="built_in">ebp</span>,<span class="built_in">esp</span>	</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">edi</span>,[<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">eax</span>,[<span class="built_in">ebp</span>+<span class="number">12</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ecx</span>,<span class="number">0ffffffffh</span></span><br><span class="line"><span class="keyword">repne</span> <span class="keyword">scasb</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">ecx</span>,<span class="number">2</span></span><br><span class="line"><span class="keyword">neg</span> <span class="built_in">ecx</span>	</span><br><span class="line"><span class="keyword">dec</span> <span class="built_in">edi</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">eax</span>,<span class="built_in">edi</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">esp</span>,<span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">ret</span>	</span><br><span class="line">strchr1 endp</span><br><span class="line"></span><br><span class="line">memcpy1 proc	</span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ebp</span>,<span class="built_in">esp</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+<span class="number">16</span>]</span><br><span class="line"><span class="keyword">mov</span>	<span class="built_in">esi</span>, [<span class="built_in">ebp</span>+<span class="number">12</span>]</span><br><span class="line"><span class="keyword">mov</span>	<span class="built_in">edi</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line"><span class="keyword">push</span> <span class="built_in">edi</span></span><br><span class="line"><span class="symbol">memcpyloop:</span></span><br><span class="line">	<span class="keyword">lodsb</span></span><br><span class="line">	<span class="keyword">stosb</span></span><br><span class="line">	<span class="keyword">dec</span> <span class="built_in">ecx</span>	</span><br><span class="line">	<span class="keyword">jnz</span>	memcpyloop</span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">eax</span>	</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">esp</span>,<span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">ret</span>	</span><br><span class="line">memcpy1 endp</span><br><span class="line"></span><br><span class="line">memset1 proc</span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ebp</span>,<span class="built_in">esp</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ecx</span>,[<span class="built_in">ebp</span>+<span class="number">16</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">eax</span>,[<span class="built_in">ebp</span>+<span class="number">12</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">edi</span>,[<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line"><span class="keyword">push</span> <span class="built_in">edi</span></span><br><span class="line"><span class="keyword">rep</span> <span class="keyword">stosb</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">eax</span>	</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">esp</span>,<span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">ret</span>	</span><br><span class="line">memset1 endp	</span><br><span class="line"></span><br><span class="line">strcmp1 proc	</span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ebp</span>,<span class="built_in">esp</span></span><br><span class="line"><span class="keyword">xor</span> <span class="built_in">edx</span>,<span class="built_in">edx</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">edi</span>,[<span class="built_in">ebp</span>+<span class="number">12</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">esi</span>,[<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line"><span class="symbol">strcmploop:</span></span><br><span class="line"><span class="keyword">cmpsb</span></span><br><span class="line"><span class="keyword">ja</span> strcmpa</span><br><span class="line"><span class="keyword">jb</span> strcmpb</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dl</span>, [<span class="built_in">esi</span>]</span><br><span class="line"><span class="keyword">cmp</span> <span class="built_in">edx</span>,<span class="number">0</span></span><br><span class="line"><span class="keyword">je</span> strcmpe </span><br><span class="line"><span class="keyword">inc</span>	<span class="built_in">esi</span></span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">edi</span></span><br><span class="line"><span class="keyword">jmp</span>	strcmploop</span><br><span class="line"><span class="symbol">strcmpe:</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">eax</span>,<span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">esp</span>,<span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">ret</span>	</span><br><span class="line"><span class="symbol">strcmpb:</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">eax</span>,-<span class="number">1</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">esp</span>,<span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">ret</span>	</span><br><span class="line"><span class="symbol">strcmpa:</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">eax</span>,<span class="number">1</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">esp</span>,<span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">ret</span>	</span><br><span class="line">strcmp1 endp	</span><br><span class="line"></span><br><span class="line">strset1 proc</span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ebp</span>,<span class="built_in">esp</span>	</span><br><span class="line"><span class="keyword">xor</span> <span class="built_in">edx</span>,<span class="built_in">edx</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">eax</span>,[<span class="built_in">ebp</span>+<span class="number">12</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">edi</span>,[<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line"><span class="keyword">push</span> <span class="built_in">edi</span></span><br><span class="line"><span class="symbol">strsetloop:</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dl</span>,[<span class="built_in">edi</span>]</span><br><span class="line"><span class="keyword">cmp</span> <span class="built_in">edx</span>,<span class="number">0</span></span><br><span class="line"><span class="keyword">jz</span> strsetf</span><br><span class="line"><span class="keyword">stosb</span></span><br><span class="line"><span class="keyword">jmp</span> strsetloop</span><br><span class="line"><span class="symbol">strsetf:</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">eax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">esp</span>,<span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="keyword">ret</span>	</span><br><span class="line">strset1 endp</span><br><span class="line"></span><br><span class="line">END</span><br></pre></td></tr></table></figure>

<p>测试程序：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pureasm.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = <span class="built_in">tttt</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">char</span> str1[<span class="number">100</span>] = <span class="string">&quot;String 1, length: 20&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// size_t strlen(const char *str)</span></span><br><span class="line">    <span class="keyword">size_t</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;strlen(str1) is %d\n&quot;</span>, <span class="built_in">strlen1</span>(str1));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// char *strchr(const char *str, int c)</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;strchr(str1, &#x27;1&#x27;) is %s\n&quot;</span>, <span class="built_in">strchr1</span>(str1, <span class="string">&#x27;1&#x27;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// void *memcpy(void *dest, const void *src, size_t n)</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;memcpy(buffer, str1, 10) is %s\n&quot;</span>, <span class="built_in">memcpy1</span>(buffer, str1, <span class="number">10</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// void *memset(void *str, int c, size_t n)</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;memset(buffer, 97, 5) is %s\n&quot;</span>, <span class="built_in">memset1</span>(buffer, <span class="number">97</span>, <span class="number">5</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// int strcmp(const char *str1, const char *str2)</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;strcmp(str1,\&quot;String 1, length: 20\&quot;) is %d\n&quot;</span>, <span class="built_in">strcmp1</span>(str1, <span class="string">&quot;String 1, length: 20&quot;</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;strcmp(str1,buffer) is %d\n&quot;</span>, <span class="built_in">strcmp1</span>(str1, buffer));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// char *strset(char *str, char c);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;strset(str1,&#x27;C&#x27;) is %s&quot;</span>, <span class="built_in">strset1</span>(str1, <span class="string">&#x27;C&#x27;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5"><a href="#5" class="headerlink" title="5"></a>5</h4><p>无特殊说明，环境均为 Windows 7 SP1 x86，内核版本 7601 MP。</p>
<p>此部分有完善空间，可配合相应机制仔细研究。</p>
<h5 id="KeInitializeDpc"><a href="#KeInitializeDpc" class="headerlink" title="KeInitializeDpc"></a>KeInitializeDpc</h5><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">nt!KeInitializeDpc:</span><br><span class="line">828f0d25 8bff            <span class="keyword">mov</span>     <span class="built_in">edi</span>,<span class="built_in">edi</span></span><br><span class="line">828f0d27 <span class="number">55</span>              <span class="keyword">push</span>    <span class="built_in">ebp</span></span><br><span class="line">828f0d28 8bec            <span class="keyword">mov</span>     <span class="built_in">ebp</span>,<span class="built_in">esp</span></span><br><span class="line">828f0d2a 8b4508          <span class="keyword">mov</span>     <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">828f0d2d 33c9            <span class="keyword">xor</span>     <span class="built_in">ecx</span>,<span class="built_in">ecx</span></span><br><span class="line">828f0d2f 83601c00        <span class="keyword">and</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">1Ch</span>],<span class="number">0</span></span><br><span class="line">828f0d33 c60013          <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>],<span class="number">13h</span></span><br><span class="line">828f0d36 c6400101        <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">1</span>],<span class="number">1</span></span><br><span class="line">828f0d3a <span class="number">66894802</span>        <span class="keyword">mov</span>     <span class="built_in">word</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">2</span>],<span class="built_in">cx</span></span><br><span class="line">828f0d3e 8b4d0c          <span class="keyword">mov</span>     <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">0Ch</span>]</span><br><span class="line">828f0d41 89480c          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">0Ch</span>],<span class="built_in">ecx</span></span><br><span class="line">828f0d44 8b4d10          <span class="keyword">mov</span>     <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">10h</span>]</span><br><span class="line">828f0d47 <span class="number">894810</span>          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">10h</span>],<span class="built_in">ecx</span></span><br><span class="line">828f0d4a <span class="number">5d</span>              <span class="keyword">pop</span>     <span class="built_in">ebp</span></span><br><span class="line">828f0d4b c20c00          <span class="keyword">ret</span>     <span class="number">0Ch</span></span><br></pre></td></tr></table></figure>

<p>文档：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-keinitializedpc">KeInitializeDpc function (wdm.h) - Windows drivers | Microsoft Docs</a>，函数原型：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">void</span> KeInitializeDpc(</span><br><span class="line"><span class="string">  [out]</span>          __drv_aliasesMem PRKDPC Dpc,</span><br><span class="line"><span class="string">  [in]</span>           PKDEFERRED_ROUTINE      DeferredRoutine,</span><br><span class="line"><span class="string">  [in, optional]</span> __drv_aliasesMem PVOID  DeferredContext</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>KDPC 结构</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ntdll!_KDPC</span><br><span class="line">   +<span class="number">0</span>x000 <span class="keyword">Type</span>             <span class="type">: </span>UChar</span><br><span class="line">   +<span class="number">0</span>x001 Importance       : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x002 Number           : <span class="type">Uint2B</span></span><br><span class="line">   +<span class="number">0</span>x004 DpcListEntry     : _<span class="type">LIST_ENTRY</span></span><br><span class="line">   +<span class="number">0</span>x00c DeferredRoutine  : <span class="type">Ptr32</span>     void </span><br><span class="line">   +<span class="number">0</span>x010 DeferredContext  : <span class="type">Ptr32</span> Void</span><br><span class="line">   +<span class="number">0</span>x014 SystemArgument1  : <span class="type">Ptr32</span> Void</span><br><span class="line">   +<span class="number">0</span>x018 SystemArgument2  : <span class="type">Ptr32</span> Void</span><br><span class="line">   +<span class="number">0</span>x01c DpcData          : <span class="type">Ptr32</span> Void</span><br></pre></td></tr></table></figure>

<p>反编译：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">void __cdecl KeInitializeDpc(PKDPC Dpc, </span><br><span class="line">		PKDERFERED_ROUTINE DeferredRoutine,</span><br><span class="line">    	PVOID DeferredContext)&#123;</span><br><span class="line">    D<span class="function"><span class="title">pc</span>-&gt;</span>DpcData = <span class="number">0</span>;</span><br><span class="line">    D<span class="function"><span class="title">pc</span>-&gt;</span>Type = <span class="number">13</span>h;</span><br><span class="line">    D<span class="function"><span class="title">pc</span>-&gt;</span>Importance = <span class="number">1</span>;</span><br><span class="line">    D<span class="function"><span class="title">pc</span>-&gt;</span>Number = <span class="number">0</span>;</span><br><span class="line">    D<span class="function"><span class="title">pc</span>-&gt;</span>DeferredRoutine = DeferredRoutine;</span><br><span class="line">    D<span class="function"><span class="title">pc</span>-&gt;</span>DeferredContext = DeferredContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="KeInitializeApc"><a href="#KeInitializeApc" class="headerlink" title="KeInitializeApc"></a>KeInitializeApc</h5><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">nt!KeInitializeApc:</span><br><span class="line">828ffdf3 8bff            <span class="keyword">mov</span>     <span class="built_in">edi</span>,<span class="built_in">edi</span></span><br><span class="line">828ffdf5 <span class="number">55</span>              <span class="keyword">push</span>    <span class="built_in">ebp</span></span><br><span class="line">828ffdf6 8bec            <span class="keyword">mov</span>     <span class="built_in">ebp</span>,<span class="built_in">esp</span></span><br><span class="line">828ffdf8 8b4508          <span class="keyword">mov</span>     <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">828ffdfb 8b5510          <span class="keyword">mov</span>     <span class="built_in">edx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">10h</span>]</span><br><span class="line">828ffdfe 8b4d0c          <span class="keyword">mov</span>     <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">0Ch</span>]</span><br><span class="line">828ffe01 c60012          <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>],<span class="number">12h</span></span><br><span class="line">828ffe04 c6400230        <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">2</span>],<span class="number">30h</span></span><br><span class="line">828ffe08 83fa02          <span class="keyword">cmp</span>     <span class="built_in">edx</span>,<span class="number">2</span></span><br><span class="line">828ffe0b <span class="number">7506</span>            <span class="keyword">jne</span>     nt!KeInitializeApc+<span class="number">0x20</span> (828ffe13)  Branch</span><br><span class="line"></span><br><span class="line">nt!KeInitializeApc+<span class="number">0x1a</span>:</span><br><span class="line">828ffe0d 8a9134010000    <span class="keyword">mov</span>     <span class="built_in">dl</span>,<span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ecx</span>+<span class="number">134h</span>]</span><br><span class="line"></span><br><span class="line">nt!KeInitializeApc+<span class="number">0x20</span>:</span><br><span class="line">828ffe13 <span class="number">894808</span>          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">8</span>],<span class="built_in">ecx</span></span><br><span class="line">828ffe16 8b4d14          <span class="keyword">mov</span>     <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">14h</span>]</span><br><span class="line">828ffe19 <span class="number">894814</span>          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">14h</span>],<span class="built_in">ecx</span></span><br><span class="line">828ffe1c 8b4d18          <span class="keyword">mov</span>     <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">18h</span>]</span><br><span class="line">828ffe1f 88502c          <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">2Ch</span>],<span class="built_in">dl</span></span><br><span class="line">828ffe22 <span class="number">894818</span>          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">18h</span>],<span class="built_in">ecx</span></span><br><span class="line">828ffe25 8b4d1c          <span class="keyword">mov</span>     <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">1Ch</span>]</span><br><span class="line">828ffe28 33d2            <span class="keyword">xor</span>     <span class="built_in">edx</span>,<span class="built_in">edx</span></span><br><span class="line">828ffe2a 89481c          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">1Ch</span>],<span class="built_in">ecx</span></span><br><span class="line">828ffe2d 3bca            <span class="keyword">cmp</span>     <span class="built_in">ecx</span>,<span class="built_in">edx</span></span><br><span class="line">828ffe2f 740e            <span class="keyword">je</span>      nt!KeInitializeApc+<span class="number">0x4c</span> (828ffe3f)  Branch</span><br><span class="line"></span><br><span class="line">nt!KeInitializeApc+<span class="number">0x3e</span>:</span><br><span class="line">828ffe31 8a4d20          <span class="keyword">mov</span>     <span class="built_in">cl</span>,<span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">20h</span>]</span><br><span class="line">828ffe34 <span class="number">88482d</span>          <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">2Dh</span>],<span class="built_in">cl</span></span><br><span class="line">828ffe37 8b4d24          <span class="keyword">mov</span>     <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">24h</span>]</span><br><span class="line">828ffe3a <span class="number">894820</span>          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">20h</span>],<span class="built_in">ecx</span></span><br><span class="line">828ffe3d eb06            <span class="keyword">jmp</span>     nt!KeInitializeApc+<span class="number">0x52</span> (828ffe45)  Branch</span><br><span class="line"></span><br><span class="line">nt!KeInitializeApc+<span class="number">0x4c</span>:</span><br><span class="line">828ffe3f <span class="number">88502d</span>          <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">2Dh</span>],<span class="built_in">dl</span></span><br><span class="line">828ffe42 <span class="number">895020</span>          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">20h</span>],<span class="built_in">edx</span></span><br><span class="line"></span><br><span class="line">nt!KeInitializeApc+<span class="number">0x52</span>:</span><br><span class="line">828ffe45 88502e          <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">2Eh</span>],<span class="built_in">dl</span></span><br><span class="line">828ffe48 <span class="number">5d</span>              <span class="keyword">pop</span>     <span class="built_in">ebp</span></span><br><span class="line">828ffe49 c22000          <span class="keyword">ret</span>     <span class="number">20h</span></span><br></pre></td></tr></table></figure>

<p>没找到官方的文档，参考<a target="_blank" rel="noopener" href="https://www.codewarrior.cn/ntdoc/winnt/ke/KeInitializeApc.htm">KeInitializeApc (codewarrior.cn)</a>，函数原型：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">VOID</span><br><span class="line">KeInitializeApc(</span><br><span class="line">  <span class="keyword">IN</span>  PRKAPC Apc,</span><br><span class="line">  <span class="keyword">IN</span>  PRKTHREAD Thread,</span><br><span class="line">  <span class="keyword">IN</span>  KAPC_ENVIRONMENT Environment,</span><br><span class="line">  <span class="keyword">IN</span>  PKKERNEL_ROUTINE KernelRoutine,</span><br><span class="line">  <span class="keyword">IN</span>  PKRUNDOWN_ROUTINE RundownRoutine <span class="keyword">OPTIONAL</span>,</span><br><span class="line">  <span class="keyword">IN</span>  PKNORMAL_ROUTINE NormalRoutine <span class="keyword">OPTIONAL</span>,</span><br><span class="line">  <span class="keyword">IN</span>  KPROCESSOR_MODE ApcMode <span class="keyword">OPTIONAL</span>,</span><br><span class="line">  <span class="keyword">IN</span>  PVOID NormalContext <span class="keyword">OPTIONAL</span></span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<p>APC 结构：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ntdll!_KAPC</span><br><span class="line">   +<span class="number">0</span>x000 <span class="keyword">Type</span>             <span class="type">: </span>UChar</span><br><span class="line">   +<span class="number">0</span>x001 SpareByte0       : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x002 Size             : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x003 SpareByte1       : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x004 SpareLong0       : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x008 Thread           : <span class="type">Ptr32</span> _KTHREAD</span><br><span class="line">   +<span class="number">0</span>x00c ApcListEntry     : _<span class="type">LIST_ENTRY</span></span><br><span class="line">   +<span class="number">0</span>x014 KernelRoutine    : <span class="type">Ptr32</span>     void </span><br><span class="line">   +<span class="number">0</span>x018 RundownRoutine   : <span class="type">Ptr32</span>     void </span><br><span class="line">   +<span class="number">0</span>x01c NormalRoutine    : <span class="type">Ptr32</span>     void </span><br><span class="line">   +<span class="number">0</span>x020 NormalContext    : <span class="type">Ptr32</span> Void</span><br><span class="line">   +<span class="number">0</span>x024 SystemArgument1  : <span class="type">Ptr32</span> Void</span><br><span class="line">   +<span class="number">0</span>x028 SystemArgument2  : <span class="type">Ptr32</span> Void</span><br><span class="line">   +<span class="number">0</span>x02c ApcStateIndex    : <span class="type">Char</span></span><br><span class="line">   +<span class="number">0</span>x02d ApcMode          : <span class="type">Char</span></span><br><span class="line">   +<span class="number">0</span>x02e Inserted         : <span class="type">UChar</span></span><br></pre></td></tr></table></figure>

<p>KTHREAD 结构：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KTHREAD</span><br><span class="line">ntdll!_KTHREAD</span><br><span class="line">   +<span class="number">0</span>x000 Header           : _<span class="type">DISPATCHER_HEADER</span></span><br><span class="line">   +<span class="number">0</span>x010 CycleTime        : <span class="type">Uint8B</span></span><br><span class="line">   +<span class="number">0</span>x018 HighCycleTime    : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x020 QuantumTarget    : <span class="type">Uint8B</span></span><br><span class="line">   +<span class="number">0</span>x028 InitialStack     : <span class="type">Ptr32</span> Void</span><br><span class="line">   +<span class="number">0</span>x02c StackLimit       : <span class="type">Ptr32</span> Void</span><br><span class="line">   +<span class="number">0</span>x030 KernelStack      : <span class="type">Ptr32</span> Void</span><br><span class="line">   +<span class="number">0</span>x034 ThreadLock       : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x038 WaitRegister     : _<span class="type">KWAIT_STATUS_REGISTER</span></span><br><span class="line">   +<span class="number">0</span>x039 Running          : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x03a Alerted          : [2] <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x03c KernelStackResident : <span class="type">Pos</span> <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x03c ReadyTransition  : <span class="type">Pos</span> <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x03c ProcessReadyQueue : <span class="type">Pos</span> <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x03c WaitNext         : <span class="type">Pos</span> <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x03c SystemAffinityActive : <span class="type">Pos</span> <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x03c Alertable        : <span class="type">Pos</span> <span class="number">5</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x03c GdiFlushActive   : <span class="type">Pos</span> <span class="number">6</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x03c UserStackWalkActive : <span class="type">Pos</span> <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x03c ApcInterruptRequest : <span class="type">Pos</span> <span class="number">8</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x03c ForceDeferSchedule : <span class="type">Pos</span> <span class="number">9</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x03c QuantumEndMigrate : <span class="type">Pos</span> <span class="number">10</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x03c UmsDirectedSwitchEnable : <span class="type">Pos</span> <span class="number">11</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x03c TimerActive      : <span class="type">Pos</span> <span class="number">12</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x03c SystemThread     : <span class="type">Pos</span> <span class="number">13</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x03c Reserved         : <span class="type">Pos</span> <span class="number">14</span>, <span class="number">18</span> Bits</span><br><span class="line">   +<span class="number">0</span>x03c MiscFlags        : <span class="type">Int4B</span></span><br><span class="line">   +<span class="number">0</span>x040 ApcState         : _<span class="type">KAPC_STATE</span></span><br><span class="line">   +<span class="number">0</span>x040 ApcStateFill     : [23] <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x057 Priority         : <span class="type">Char</span></span><br><span class="line">   +<span class="number">0</span>x058 NextProcessor    : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x05c DeferredProcessor : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x060 ApcQueueLock     : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x064 ContextSwitches  : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x068 State            : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x069 NpxState         : <span class="type">Char</span></span><br><span class="line">   +<span class="number">0</span>x06a WaitIrql         : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x06b WaitMode         : <span class="type">Char</span></span><br><span class="line">   +<span class="number">0</span>x06c WaitStatus       : <span class="type">Int4B</span></span><br><span class="line">   +<span class="number">0</span>x070 WaitBlockList    : <span class="type">Ptr32</span> _KWAIT_BLOCK</span><br><span class="line">   +<span class="number">0</span>x074 WaitListEntry    : _<span class="type">LIST_ENTRY</span></span><br><span class="line">   +<span class="number">0</span>x074 SwapListEntry    : _<span class="type">SINGLE_LIST_ENTRY</span></span><br><span class="line">   +<span class="number">0</span>x07c Queue            : <span class="type">Ptr32</span> _KQUEUE</span><br><span class="line">   +<span class="number">0</span>x080 WaitTime         : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x084 KernelApcDisable : <span class="type">Int2B</span></span><br><span class="line">   +<span class="number">0</span>x086 SpecialApcDisable : <span class="type">Int2B</span></span><br><span class="line">   +<span class="number">0</span>x084 CombinedApcDisable : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x088 Teb              : <span class="type">Ptr32</span> Void</span><br><span class="line">   +<span class="number">0</span>x090 Timer            : _<span class="type">KTIMER</span></span><br><span class="line">   +<span class="number">0</span>x0b8 AutoAlignment    : <span class="type">Pos</span> <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x0b8 DisableBoost     : <span class="type">Pos</span> <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x0b8 EtwStackTraceApc1Inserted : <span class="type">Pos</span> <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x0b8 EtwStackTraceApc2Inserted : <span class="type">Pos</span> <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x0b8 CalloutActive    : <span class="type">Pos</span> <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x0b8 ApcQueueable     : <span class="type">Pos</span> <span class="number">5</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x0b8 EnableStackSwap  : <span class="type">Pos</span> <span class="number">6</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x0b8 GuiThread        : <span class="type">Pos</span> <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x0b8 UmsPerformingSyscall : <span class="type">Pos</span> <span class="number">8</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x0b8 VdmSafe          : <span class="type">Pos</span> <span class="number">9</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x0b8 UmsDispatched    : <span class="type">Pos</span> <span class="number">10</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x0b8 ReservedFlags    : <span class="type">Pos</span> <span class="number">11</span>, <span class="number">21</span> Bits</span><br><span class="line">   +<span class="number">0</span>x0b8 ThreadFlags      : <span class="type">Int4B</span></span><br><span class="line">   +<span class="number">0</span>x0bc ServiceTable     : <span class="type">Ptr32</span> Void</span><br><span class="line">   +<span class="number">0</span>x0c0 WaitBlock        : [4] _<span class="type">KWAIT_BLOCK</span></span><br><span class="line">   +<span class="number">0</span>x120 QueueListEntry   : _<span class="type">LIST_ENTRY</span></span><br><span class="line">   +<span class="number">0</span>x128 TrapFrame        : <span class="type">Ptr32</span> _KTRAP_FRAME</span><br><span class="line">   +<span class="number">0</span>x12c FirstArgument    : <span class="type">Ptr32</span> Void</span><br><span class="line">   +<span class="number">0</span>x130 CallbackStack    : <span class="type">Ptr32</span> Void</span><br><span class="line">   +<span class="number">0</span>x130 CallbackDepth    : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x134 ApcStateIndex    : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x135 BasePriority     : <span class="type">Char</span></span><br><span class="line">   +<span class="number">0</span>x136 PriorityDecrement : <span class="type">Char</span></span><br><span class="line">   +<span class="number">0</span>x136 ForegroundBoost  : <span class="type">Pos</span> <span class="number">0</span>, <span class="number">4</span> Bits</span><br><span class="line">   +<span class="number">0</span>x136 UnusualBoost     : <span class="type">Pos</span> <span class="number">4</span>, <span class="number">4</span> Bits</span><br><span class="line">   +<span class="number">0</span>x137 Preempted        : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x138 AdjustReason     : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x139 AdjustIncrement  : <span class="type">Char</span></span><br><span class="line">   +<span class="number">0</span>x13a PreviousMode     : <span class="type">Char</span></span><br><span class="line">   +<span class="number">0</span>x13b Saturation       : <span class="type">Char</span></span><br><span class="line">   +<span class="number">0</span>x13c SystemCallNumber : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x140 FreezeCount      : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x144 UserAffinity     : _<span class="type">GROUP_AFFINITY</span></span><br><span class="line">   +<span class="number">0</span>x150 Process          : <span class="type">Ptr32</span> _KPROCESS</span><br><span class="line">   +<span class="number">0</span>x154 Affinity         : _<span class="type">GROUP_AFFINITY</span></span><br><span class="line">   +<span class="number">0</span>x160 IdealProcessor   : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x164 UserIdealProcessor : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x168 ApcStatePointer  : [2] <span class="type">Ptr32</span> _KAPC_STATE</span><br><span class="line">   +<span class="number">0</span>x170 SavedApcState    : _<span class="type">KAPC_STATE</span></span><br><span class="line">   +<span class="number">0</span>x170 SavedApcStateFill : [23] <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x187 WaitReason       : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x188 SuspendCount     : <span class="type">Char</span></span><br><span class="line">   +<span class="number">0</span>x189 Spare1           : <span class="type">Char</span></span><br><span class="line">   +<span class="number">0</span>x18a OtherPlatformFill : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x18c Win32Thread      : <span class="type">Ptr32</span> Void</span><br><span class="line">   +<span class="number">0</span>x190 StackBase        : <span class="type">Ptr32</span> Void</span><br><span class="line">   +<span class="number">0</span>x194 SuspendApc       : _<span class="type">KAPC</span></span><br><span class="line">   +<span class="number">0</span>x194 SuspendApcFill0  : [1] <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x195 ResourceIndex    : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x194 SuspendApcFill1  : [3] <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x197 QuantumReset     : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x194 SuspendApcFill2  : [4] <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x198 KernelTime       : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x194 SuspendApcFill3  : [36] <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x1b8 WaitPrcb         : <span class="type">Ptr32</span> _KPRCB</span><br><span class="line">   +<span class="number">0</span>x194 SuspendApcFill4  : [40] <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x1bc LegoData         : <span class="type">Ptr32</span> Void</span><br><span class="line">   +<span class="number">0</span>x194 SuspendApcFill5  : [47] <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x1c3 LargeStack       : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x1c4 UserTime         : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x1c8 SuspendSemaphore : _<span class="type">KSEMAPHORE</span></span><br><span class="line">   +<span class="number">0</span>x1c8 SuspendSemaphorefill : [20] <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x1dc SListFaultCount  : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x1e0 ThreadListEntry  : _<span class="type">LIST_ENTRY</span></span><br><span class="line">   +<span class="number">0</span>x1e8 MutantListHead   : _<span class="type">LIST_ENTRY</span></span><br><span class="line">   +<span class="number">0</span>x1f0 SListFaultAddress : <span class="type">Ptr32</span> Void</span><br><span class="line">   +<span class="number">0</span>x1f4 ThreadCounters   : <span class="type">Ptr32</span> _KTHREAD_COUNTERS</span><br><span class="line">   +<span class="number">0</span>x1f8 XStateSave       : <span class="type">Ptr32</span> _XSTATE_SAVE</span><br></pre></td></tr></table></figure>

<p>反编译：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">VOID __cdecl</span><br><span class="line">    KeInitializeApc(</span><br><span class="line">      IN  PRKAPC Apc,</span><br><span class="line">      IN  PRKTHREAD Thread,</span><br><span class="line">      IN  KAPC_ENVIRONMENT Environment,</span><br><span class="line">      IN  PKKERNEL_ROUTINE KernelRoutine,</span><br><span class="line">      IN  PKRUNDOWN_ROUTINE RundownRoutine OPTIONAL,</span><br><span class="line">      IN  PKNORMAL_ROUTINE NormalRoutine OPTIONAL,</span><br><span class="line">      IN  KPROCESSOR_MODE ApcMode OPTIONAL,</span><br><span class="line">      IN  PVOID NormalContext OPTIONAL</span><br><span class="line">      )&#123;</span><br><span class="line">    KAPC_ENVIRONMENT Env = Environment; <span class="comment">// edx</span></span><br><span class="line">    Byte ApcStateIndex; <span class="comment">// dl</span></span><br><span class="line">    PRKTHREAD Th = Thread; <span class="comment">// ecx</span></span><br><span class="line">	A<span class="function"><span class="title">pc</span>-&gt;</span>Type = <span class="number">12</span>h;</span><br><span class="line">	A<span class="function"><span class="title">pc</span>-&gt;</span>Size = <span class="number">30</span>;</span><br><span class="line">	<span class="keyword">if</span>(Env == <span class="number">2</span>)&#123;</span><br><span class="line">		A<span class="function"><span class="title">pcStateIndex</span> =  Thread-&gt;</span>ApcStateIndex;</span><br><span class="line">	&#125;</span><br><span class="line">	A<span class="function"><span class="title">pc</span>-&gt;</span>Thread = Th;</span><br><span class="line">	A<span class="function"><span class="title">pc</span>-&gt;</span>KernelRoutine = KernelRoutine;</span><br><span class="line">	A<span class="function"><span class="title">pc</span>-&gt;</span>RundownRoutine = RundownRoutine;</span><br><span class="line">	A<span class="function"><span class="title">pc</span>-&gt;</span>ApcStateIndex = ApcStateIndex;</span><br><span class="line">	A<span class="function"><span class="title">pc</span>-&gt;</span>NormalRoutine = NormalRoutine;</span><br><span class="line">	<span class="keyword">if</span>(NormalRoutine != <span class="number">0</span>)&#123;</span><br><span class="line">		A<span class="function"><span class="title">pc</span>-&gt;</span>ApcMode = ApcMode;</span><br><span class="line">		A<span class="function"><span class="title">pc</span>-&gt;</span>NormalContext = NormalContext; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		A<span class="function"><span class="title">pc</span>-&gt;</span>ApcMode = <span class="number">0</span>;</span><br><span class="line">		A<span class="function"><span class="title">pc</span>-&gt;</span>NormalContext = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	A<span class="function"><span class="title">pc</span>-&gt;</span>Inserted = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ObFastDereferenceObject"><a href="#ObFastDereferenceObject" class="headerlink" title="ObFastDereferenceObject"></a>ObFastDereferenceObject</h5><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">nt!ObFastDereferenceObject:</span><br><span class="line">828d0a2c 8bff            <span class="keyword">mov</span>     <span class="built_in">edi</span>,<span class="built_in">edi</span></span><br><span class="line">828d0a2e <span class="number">55</span>              <span class="keyword">push</span>    <span class="built_in">ebp</span></span><br><span class="line">828d0a2f 8bec            <span class="keyword">mov</span>     <span class="built_in">ebp</span>,<span class="built_in">esp</span></span><br><span class="line">828d0a31 <span class="number">51</span>              <span class="keyword">push</span>    <span class="built_in">ecx</span></span><br><span class="line">828d0a32 8b0a            <span class="keyword">mov</span>     <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">edx</span>]</span><br><span class="line">828d0a34 <span class="number">56</span>              <span class="keyword">push</span>    <span class="built_in">esi</span></span><br><span class="line">828d0a35 <span class="number">57</span>              <span class="keyword">push</span>    <span class="built_in">edi</span></span><br><span class="line">828d0a36 8bc1            <span class="keyword">mov</span>     <span class="built_in">eax</span>,<span class="built_in">ecx</span></span><br><span class="line">828d0a38 eb13            <span class="keyword">jmp</span>     nt!ObFastDereferenceObject+<span class="number">0x21</span> (828d0a4d)  Branch</span><br><span class="line"></span><br><span class="line">nt!ObFastDereferenceObject+<span class="number">0xe</span>:</span><br><span class="line">828d0a3a 8d4101          <span class="keyword">lea</span>     <span class="built_in">eax</span>,[<span class="built_in">ecx</span>+<span class="number">1</span>]</span><br><span class="line">828d0a3d 8bf0            <span class="keyword">mov</span>     <span class="built_in">esi</span>,<span class="built_in">eax</span></span><br><span class="line">828d0a3f 8bfa            <span class="keyword">mov</span>     <span class="built_in">edi</span>,<span class="built_in">edx</span></span><br><span class="line">828d0a41 8bc1            <span class="keyword">mov</span>     <span class="built_in">eax</span>,<span class="built_in">ecx</span></span><br><span class="line">828d0a43 f00fb137        <span class="keyword">lock</span> <span class="keyword">cmpxchg</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">edi</span>],<span class="built_in">esi</span></span><br><span class="line">828d0a47 3bc1            <span class="keyword">cmp</span>     <span class="built_in">eax</span>,<span class="built_in">ecx</span></span><br><span class="line">828d0a49 <span class="number">7412</span>            <span class="keyword">je</span>      nt!ObFastDereferenceObject+<span class="number">0x31</span> (828d0a5d)  Branch</span><br><span class="line"></span><br><span class="line">nt!ObFastDereferenceObject+<span class="number">0x1f</span>:</span><br><span class="line">828d0a4b 8bc8            <span class="keyword">mov</span>     <span class="built_in">ecx</span>,<span class="built_in">eax</span></span><br><span class="line"></span><br><span class="line">nt!ObFastDereferenceObject+<span class="number">0x21</span>:</span><br><span class="line">828d0a4d <span class="number">334508</span>          <span class="keyword">xor</span>     <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">828d0a50 83f807          <span class="keyword">cmp</span>     <span class="built_in">eax</span>,<span class="number">7</span></span><br><span class="line">828d0a53 72e5            <span class="keyword">jb</span>      nt!ObFastDereferenceObject+<span class="number">0xe</span> (828d0a3a)  Branch</span><br><span class="line"></span><br><span class="line">nt!ObFastDereferenceObject+<span class="number">0x29</span>:</span><br><span class="line">828d0a55 8b4d08          <span class="keyword">mov</span>     <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">828d0a58 e86672ffff      <span class="keyword">call</span>    nt!ObfDereferenceObject (828c7cc3)</span><br><span class="line"></span><br><span class="line">nt!ObFastDereferenceObject+<span class="number">0x31</span>:</span><br><span class="line">828d0a5d 5f              <span class="keyword">pop</span>     <span class="built_in">edi</span></span><br><span class="line">828d0a5e 5e              <span class="keyword">pop</span>     <span class="built_in">esi</span></span><br><span class="line">828d0a5f <span class="number">59</span>              <span class="keyword">pop</span>     <span class="built_in">ecx</span></span><br><span class="line">828d0a60 <span class="number">5d</span>              <span class="keyword">pop</span>     <span class="built_in">ebp</span></span><br><span class="line">828d0a61 c20400          <span class="keyword">ret</span>     <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>反编译：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">VOID</span> FASTCALL ObFastDereferenceObject (IN PEX_FAST_REF FastRef, IN PVOID Object)&#123;</span><br><span class="line">	PEX_FAST_REF Ref = FastRef<span class="comment">; // edx</span></span><br><span class="line">	DWORD <span class="built_in">v1</span> = *Ref<span class="comment">;	// ecx</span></span><br><span class="line">	DWORD <span class="built_in">v2</span> = <span class="built_in">v1</span><span class="comment">;		// eax</span></span><br><span class="line">	DWORD <span class="built_in">v3</span><span class="comment">;			// esi</span></span><br><span class="line">	do &#123;</span><br><span class="line">		<span class="built_in">v2</span> = <span class="built_in">v2</span>^Object<span class="comment">;</span></span><br><span class="line">		<span class="meta">if</span>(<span class="built_in">v2</span> &gt;= <span class="number">7</span>) &#123;</span><br><span class="line">			break<span class="comment">;</span></span><br><span class="line">		&#125;</span><br><span class="line">	<span class="built_in">v2</span> = *(<span class="built_in">v1</span> + <span class="number">1</span>)<span class="comment">;</span></span><br><span class="line">	<span class="built_in">v3</span> = <span class="built_in">v2</span><span class="comment">;</span></span><br><span class="line">	<span class="built_in">v2</span> = <span class="built_in">v1</span><span class="comment">;</span></span><br><span class="line">	<span class="meta">if</span>(<span class="built_in">v2</span> == *Object)&#123; Object = <span class="built_in">v3</span><span class="comment">; &#125;</span></span><br><span class="line">	<span class="meta">else</span> &#123; <span class="built_in">v2</span> = *Object<span class="comment">; &#125;</span></span><br><span class="line">	<span class="meta">if</span>(<span class="built_in">v1</span> == <span class="built_in">v2</span>)&#123; return<span class="comment">; &#125;</span></span><br><span class="line">	<span class="meta">else</span>&#123; <span class="built_in">v1</span> = <span class="built_in">v2</span> &#125;</span><br><span class="line">	&#125; <span class="meta">while</span>(True)<span class="comment">;</span></span><br><span class="line">	ObfDereferenceObject(Object)<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="KeInitializeQueue"><a href="#KeInitializeQueue" class="headerlink" title="KeInitializeQueue"></a>KeInitializeQueue</h5><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">nt!KeInitializeQueue:</span><br><span class="line">8290487b 8bff            <span class="keyword">mov</span>     <span class="built_in">edi</span>,<span class="built_in">edi</span></span><br><span class="line"><span class="number">8290487d</span> <span class="number">55</span>              <span class="keyword">push</span>    <span class="built_in">ebp</span></span><br><span class="line">8290487e 8bec            <span class="keyword">mov</span>     <span class="built_in">ebp</span>,<span class="built_in">esp</span></span><br><span class="line"><span class="number">82904880</span> 8b4508          <span class="keyword">mov</span>     <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line"><span class="number">82904883</span> c60004          <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>],<span class="number">4</span></span><br><span class="line"><span class="number">82904886</span> c640020a        <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">2</span>],<span class="number">0Ah</span></span><br><span class="line">8290488a 33d2            <span class="keyword">xor</span>     <span class="built_in">edx</span>,<span class="built_in">edx</span></span><br><span class="line">8290488c <span class="number">885001</span>          <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">1</span>],<span class="built_in">dl</span></span><br><span class="line">8290488f <span class="number">895004</span>          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">4</span>],<span class="built_in">edx</span></span><br><span class="line"><span class="number">82904892</span> 8d4808          <span class="keyword">lea</span>     <span class="built_in">ecx</span>,[<span class="built_in">eax</span>+<span class="number">8</span>]</span><br><span class="line"><span class="number">82904895</span> <span class="number">894904</span>          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ecx</span>+<span class="number">4</span>],<span class="built_in">ecx</span></span><br><span class="line"><span class="number">82904898</span> <span class="number">8909</span>            <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ecx</span>],<span class="built_in">ecx</span></span><br><span class="line">8290489a 8d4810          <span class="keyword">lea</span>     <span class="built_in">ecx</span>,[<span class="built_in">eax</span>+<span class="number">10h</span>]</span><br><span class="line"><span class="number">8290489d</span> <span class="number">894904</span>          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ecx</span>+<span class="number">4</span>],<span class="built_in">ecx</span></span><br><span class="line">829048a0 <span class="number">8909</span>            <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ecx</span>],<span class="built_in">ecx</span></span><br><span class="line">829048a2 8d4820          <span class="keyword">lea</span>     <span class="built_in">ecx</span>,[<span class="built_in">eax</span>+<span class="number">20h</span>]</span><br><span class="line">829048a5 <span class="number">894904</span>          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ecx</span>+<span class="number">4</span>],<span class="built_in">ecx</span></span><br><span class="line">829048a8 <span class="number">8909</span>            <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ecx</span>],<span class="built_in">ecx</span></span><br><span class="line">829048aa 8b4d0c          <span class="keyword">mov</span>     <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">0Ch</span>]</span><br><span class="line">829048ad <span class="number">895018</span>          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">18h</span>],<span class="built_in">edx</span></span><br><span class="line">829048b0 3bca            <span class="keyword">cmp</span>     <span class="built_in">ecx</span>,<span class="built_in">edx</span></span><br><span class="line">829048b2 <span class="number">7506</span>            <span class="keyword">jne</span>     nt!KeInitializeQueue+<span class="number">0x3f</span> (829048ba)  Branch</span><br><span class="line"></span><br><span class="line">nt!KeInitializeQueue+<span class="number">0x39</span>:</span><br><span class="line">829048b4 8b0d6c999b82    <span class="keyword">mov</span>     <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [nt!KeNumberProcessors (829b996c)]</span><br><span class="line"></span><br><span class="line">nt!KeInitializeQueue+<span class="number">0x3f</span>:</span><br><span class="line">829048ba 89481c          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">1Ch</span>],<span class="built_in">ecx</span></span><br><span class="line">829048bd <span class="number">5d</span>              <span class="keyword">pop</span>     <span class="built_in">ebp</span></span><br><span class="line">829048be c20800          <span class="keyword">ret</span>     <span class="number">8</span></span><br></pre></td></tr></table></figure>

<p>文档：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-keinitializequeue">KeInitializeQueue function (ntifs.h) - Windows drivers | Microsoft Docs</a>，函数原型：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">void</span> KeInitializeQueue(</span><br><span class="line"><span class="string">  [out]</span> PRKQUEUE Queue,</span><br><span class="line"><span class="string">  [in]</span>  ULONG    Count</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>第一个参数是指向 KQUEUE 的指针，KQUEUE 结构：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ntdll!_KQUEUE</span><br><span class="line">   +<span class="number">0</span>x000 Header           : _<span class="type">DISPATCHER_HEADER</span></span><br><span class="line">   +<span class="number">0</span>x010 EntryListHead    : _<span class="type">LIST_ENTRY</span></span><br><span class="line">   +<span class="number">0</span>x018 CurrentCount     : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x01c MaximumCount     : <span class="type">Uint4B</span></span><br><span class="line">   +<span class="number">0</span>x020 ThreadListHead   : _<span class="type">LIST_ENTRY</span></span><br></pre></td></tr></table></figure>

<p>其中 <code>_DISPATCHER_HEADER</code>结构：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">ntdll!_DISPATCHER_HEADER</span><br><span class="line">   +<span class="number">0</span>x000 <span class="keyword">Type</span>             <span class="type">: </span>UChar</span><br><span class="line">   +<span class="number">0</span>x001 TimerControlFlags : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x001 Absolute         : <span class="type">Pos</span> <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x001 Coalescable      : <span class="type">Pos</span> <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x001 KeepShifting     : <span class="type">Pos</span> <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x001 EncodedTolerableDelay : <span class="type">Pos</span> <span class="number">3</span>, <span class="number">5</span> Bits</span><br><span class="line">   +<span class="number">0</span>x001 Abandoned        : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x001 Signalling       : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x002 ThreadControlFlags : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x002 CpuThrottled     : <span class="type">Pos</span> <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x002 CycleProfiling   : <span class="type">Pos</span> <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x002 CounterProfiling : <span class="type">Pos</span> <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x002 Reserved         : <span class="type">Pos</span> <span class="number">3</span>, <span class="number">5</span> Bits</span><br><span class="line">   +<span class="number">0</span>x002 Hand             : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x002 Size             : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x003 TimerMiscFlags   : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x003 Index            : <span class="type">Pos</span> <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x003 Processor        : <span class="type">Pos</span> <span class="number">1</span>, <span class="number">5</span> Bits</span><br><span class="line">   +<span class="number">0</span>x003 Inserted         : <span class="type">Pos</span> <span class="number">6</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x003 Expired          : <span class="type">Pos</span> <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x003 DebugActive      : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x003 ActiveDR7        : <span class="type">Pos</span> <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x003 Instrumented     : <span class="type">Pos</span> <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x003 Reserved2        : <span class="type">Pos</span> <span class="number">2</span>, <span class="number">4</span> Bits</span><br><span class="line">   +<span class="number">0</span>x003 UmsScheduled     : <span class="type">Pos</span> <span class="number">6</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x003 UmsPrimary       : <span class="type">Pos</span> <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0</span>x003 DpcActive        : <span class="type">UChar</span></span><br><span class="line">   +<span class="number">0</span>x000 Lock             : <span class="type">Int4B</span></span><br><span class="line">   +<span class="number">0</span>x004 SignalState      : <span class="type">Int4B</span></span><br><span class="line">   +<span class="number">0</span>x008 WaitListHead     : _<span class="type">LIST_ENTRY</span></span><br></pre></td></tr></table></figure>

<p><code>_LIST_ENTRY</code>:</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ntdll!<span class="variable">_LIST_ENTRY</span></span><br><span class="line">   +<span class="number">0</span>x000 Flink            : Ptr32 <span class="variable">_LIST_ENTRY</span></span><br><span class="line">   +<span class="number">0</span>x004 Blink            : Ptr32 <span class="variable">_LIST_ENTRY</span></span><br></pre></td></tr></table></figure>

<p>反编译：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">void __cdecl KeInitializeQueue(PRKQUEUE Queue, ULONG Count)&#123;</span><br><span class="line">	Q<span class="function"><span class="title">ueue</span>-&gt;</span>Header.Type = <span class="number">4</span>;</span><br><span class="line">	Q<span class="function"><span class="title">ueue</span>-&gt;</span>Header.ThreadControlFlags = <span class="number">0</span>ah;</span><br><span class="line">	Q<span class="function"><span class="title">ueue</span>-&gt;</span>Header.TimerControlFlags = <span class="number">0</span>;</span><br><span class="line">	Q<span class="function"><span class="title">ueue</span>-&gt;</span>Header.SignalState = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	_LIST_ENTRY* <span class="function"><span class="title">head</span> = &amp;(Queue-&gt;</span>Header.WaitListHead);</span><br><span class="line">	<span class="function"><span class="title">head</span>-&gt;</span>Blink = head;</span><br><span class="line">	<span class="function"><span class="title">head</span>-&gt;</span>Flink = head;</span><br><span class="line">	</span><br><span class="line">	_LIST_ENTRY* <span class="function"><span class="title">head2</span> = &amp;(Queue-&gt;</span>ThreadListHead);</span><br><span class="line">	<span class="function"><span class="title">head2</span>-&gt;</span>Blink = head2</span><br><span class="line">	<span class="function"><span class="title">head2</span>-&gt;</span>Flink = head2;</span><br><span class="line">	</span><br><span class="line">	Q<span class="function"><span class="title">ueue</span>-&gt;</span>CurrentCount = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(Count == <span class="number">0</span>)&#123;</span><br><span class="line">		Q<span class="function"><span class="title">ueue</span>-&gt;</span>MaximumCount = KeNumberProcessors;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		Q<span class="function"><span class="title">ueue</span>-&gt;</span>MaximumCount = Count;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="KxWaitForLockChainValid-–"><a href="#KxWaitForLockChainValid-–" class="headerlink" title="KxWaitForLockChainValid –"></a>KxWaitForLockChainValid –</h5><p>我使用的 Win7 SP1 x86 中没有找到这个函数，待续。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>





<h5 id="KeReadyThread"><a href="#KeReadyThread" class="headerlink" title="KeReadyThread"></a>KeReadyThread</h5><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">nt</span>!KeReadyThread:</span><br><span class="line"><span class="attribute">828f11fc</span> <span class="number">8</span>bff            mov     edi,edi</span><br><span class="line"><span class="attribute">828f11fe</span> <span class="number">56</span>              push    esi</span><br><span class="line"><span class="attribute">828f11ff</span> <span class="number">8</span>bf<span class="number">0</span>            mov     esi,eax</span><br><span class="line"><span class="attribute">828f1201</span> <span class="number">8</span>b<span class="number">4650</span>          mov     eax,dword ptr<span class="meta"> [esi+50h]</span></span><br><span class="line"><span class="attribute">828f1204</span> <span class="number">8</span>b<span class="number">4874</span>          mov     ecx,dword ptr<span class="meta"> [eax+74h]</span></span><br><span class="line"><span class="attribute">828f1207</span> f<span class="number">6</span>c<span class="number">107</span>          test    cl,<span class="number">7</span></span><br><span class="line"><span class="attribute">828f120a</span> <span class="number">7409</span>            je      nt!KeReadyThread+<span class="number">0</span>x<span class="number">19</span> (<span class="number">828</span>f<span class="number">1215</span>)  Branch</span><br><span class="line"></span><br><span class="line"><span class="attribute">nt</span>!KeReadyThread+<span class="number">0</span>x<span class="number">10</span>:</span><br><span class="line"><span class="attribute">828f120c</span> e<span class="number">84751</span>f<span class="number">8</span>ff      call    nt!KiInSwapSingleProcess (<span class="number">82876358</span>)</span><br><span class="line"><span class="attribute">828f1211</span> <span class="number">84</span>c<span class="number">0</span>            test    al,al</span><br><span class="line"><span class="attribute">828f1213</span> <span class="number">7505</span>            jne     nt!KeReadyThread+<span class="number">0</span>x<span class="number">1</span>e (<span class="number">828</span>f<span class="number">121</span>a)  Branch</span><br><span class="line"></span><br><span class="line"><span class="attribute">nt</span>!KeReadyThread+<span class="number">0</span>x<span class="number">19</span>:</span><br><span class="line"><span class="attribute">828f1215</span> e<span class="number">868</span>ec<span class="number">0000</span>      call    nt!KiFastReadyThread (<span class="number">828</span>ffe<span class="number">82</span>)</span><br><span class="line"></span><br><span class="line"><span class="attribute">nt</span>!KeReadyThread+<span class="number">0</span>x<span class="number">1</span>e:</span><br><span class="line"><span class="attribute">828f121a</span> <span class="number">5</span>e              pop     esi</span><br><span class="line"><span class="attribute">828f121b</span> c<span class="number">3</span>              ret</span><br></pre></td></tr></table></figure>

<p>非官方文档：<a target="_blank" rel="noopener" href="https://www.codewarrior.cn/ntdoc/winnt/ke/KeReadyThread.htm">KeReadyThread (codewarrior.cn)</a>，函数原型：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">VOID</span></span><br><span class="line">KeReadyThread(</span><br><span class="line">  <span class="keyword">IN</span>  PKTHREAD <span class="keyword">Thread</span></span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<p>第一个参数是指向 KTHREAD 的指针，结构在<code>KeInitializeAPC</code>中已给出。反编译：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##### KiInitializeTSS</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>nt!KiInitializeTSS:<br>82851359 8bff            mov     edi,edi<br>8285135b 55              push    ebp<br>8285135c 8bec            mov     ebp,esp<br>8285135e 8b4508          mov     eax,dword ptr [ebp+8]<br>82851361 b9ac200000      mov     ecx,20ACh<br>82851366 66894866        mov     word ptr [eax+66h],cx<br>8285136a 33c9            xor     ecx,ecx<br>8285136c 6a10            push    10h<br>8285136e 66894864        mov     word ptr [eax+64h],cx<br>82851372 66894860        mov     word ptr [eax+60h],cx<br>82851376 59              pop     ecx<br>82851377 66894808        mov     word ptr [eax+8],cx<br>8285137b 5d              pop     ebp<br>8285137c c20400          ret     4</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">非官方文档：[KiInitializeTSS (codewarrior.cn)](https:<span class="regexp">//</span>www.codewarrior.cn<span class="regexp">/ntdoc/</span>winnt<span class="regexp">/ke/i</span>386/KiInitializeTSS.htm)，函数原型：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>VOID<br>KiInitializeTSS(<br>  IN  PKTSS Tss<br>  );</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attribute">KTSS</span> 结构：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ntdll!_KTSS<br>   +0x000 Backlink         : Uint2B<br>   +0x002 Reserved0        : Uint2B<br>   +0x004 Esp0             : Uint4B<br>   +0x008 Ss0              : Uint2B<br>   +0x00a Reserved1        : Uint2B<br>   +0x00c NotUsed1         : [4] Uint4B<br>   +0x01c CR3              : Uint4B<br>   +0x020 Eip              : Uint4B<br>   +0x024 EFlags           : Uint4B<br>   +0x028 Eax              : Uint4B<br>   +0x02c Ecx              : Uint4B<br>   +0x030 Edx              : Uint4B<br>   +0x034 Ebx              : Uint4B<br>   +0x038 Esp              : Uint4B<br>   +0x03c Ebp              : Uint4B<br>   +0x040 Esi              : Uint4B<br>   +0x044 Edi              : Uint4B<br>   +0x048 Es               : Uint2B<br>   +0x04a Reserved2        : Uint2B<br>   +0x04c Cs               : Uint2B<br>   +0x04e Reserved3        : Uint2B<br>   +0x050 Ss               : Uint2B<br>   +0x052 Reserved4        : Uint2B<br>   +0x054 Ds               : Uint2B<br>   +0x056 Reserved5        : Uint2B<br>   +0x058 Fs               : Uint2B<br>   +0x05a Reserved6        : Uint2B<br>   +0x05c Gs               : Uint2B<br>   +0x05e Reserved7        : Uint2B<br>   +0x060 LDT              : Uint2B<br>   +0x062 Reserved8        : Uint2B<br>   +0x064 Flags            : Uint2B<br>   +0x066 IoMapBase        : Uint2B<br>   +0x068 IoMaps           : [1] _KiIoAccessMap<br>   +0x208c IntDirectionMap  : [32] UChar</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">反编译：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>VOID __cdecl KiInitializeTSS(PKTSS Tss){<br>    Tss-&gt;ToMapBase = 20ACh;<br>    Tss-&gt;Flags = 0;<br>    Tss-&gt;LDT = 0;<br>    Tss-&gt;Ss0 = 10h;<br>}</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">##### RtlValidateUnicodeString --</span></span><br><span class="line"></span><br><span class="line">待续</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 6</span></span><br><span class="line"></span><br><span class="line">感谢万能的网友，书中给出的 Sample H 的 SHA1 值为 cb3b2403e1d777c250210d4ed4567cb527cab0f4，这个样本（我）找不到。有网页：[Malware Samples For Educative Purposes (grsecurity.net)](https:<span class="regexp">//g</span>rsecurity.net<span class="regexp">/malware_research/</span>)，提供了本书中样本的合集，但其中 Sample H 的 SHA1 不同，并且这个 Sample H 并没有书中所说的``sub_13846``等等函数。查到一篇博客：[Practical Reverse Engineering Solutions – Page <span class="number">35</span> (Part III) - my go at exercises <span class="number">6</span> on page <span class="number">35</span> (bin.re)](https:<span class="regexp">//</span>bin.re<span class="regexp">/blog/</span>practical-reverse-engineering-solutions-page-<span class="number">35</span>-part-iii/)，其中提到了书中对于 Sample H 给出的函数偏移始终比该 Sample H 大出 <span class="number">4</span> 字节，因此实际指的是``sub_13842``。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>.text:00013842 ; =============== S U B R O U T I N E =======================================<br>.text:00013842<br>.text:00013842<br>.text:00013842 sub_13842       proc near               ; CODE XREF: sub_1386E+2E8↓p<br>.text:00013842                                         ; sub_13BE2+84↓p …<br>.text:00013842                 mov     eax, [ecx+60h]<br>.text:00013845                 push    esi<br>.text:00013846                 mov     esi, [edx+8]<br>.text:00013849                 dec     byte ptr [ecx+23h]<br>.text:0001384C                 sub     eax, 24h ; ‘$’<br>.text:0001384F                 mov     [ecx+60h], eax<br>.text:00013852                 mov     [eax+14h], edx<br>.text:00013855                 movzx   eax, byte ptr [eax]<br>.text:00013858                 push    ecx<br>.text:00013859                 push    edx<br>.text:0001385A                 call    dword ptr [esi+eax*4+38h]<br>.text:0001385E                 pop     esi<br>.text:0001385F                 retn<br>.text:0001385F sub_13842       endp</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">首先该函数采用的是 fastcall 约定，读了 <span class="built_in">ecx</span> 和 <span class="built_in">edx</span>，没有读取通过栈传递的参数，因此该函数应该有两个参数。读取的方式都是基地址+偏移的方式，因此 <span class="built_in">ecx</span> 和 <span class="built_in">edx</span> 应该是两个结构体的指针。函数原型：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ret_type __fastcall sub_13842(pStruct1 pst1, pStruct2 pst2);</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">接下来逐行来看，反编译一下</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>mov eax,[ecx+60h]<br>var_type_1 v1 = pst1-&gt;off_60h;</p>
<p>push esi // 保存 esi</p>
<p>mov esi, [edx+8]<br>var_type_2 v2 = pst2-&gt;off_8h;</p>
<p>dec byte ptr [ecx+23h]<br>pst1-&gt;off_23h–; // off_23h 占 1 字节</p>
<p>sub eax,24h<br>v1 = (byte*)v1 - 24h;</p>
<p>mov [ecx+60h], eax<br>pst1-&gt;off_60h = v1;</p>
<p>mov [eax+14h],edx<br>v1-&gt;off_14h = pst2;</p>
<p>movzx eax, byte ptr [eax]<br>int v3 = <em>(byte</em>)v1</p>
<p>push ecx<br>push edx<br>call dword ptr [esi+eax<em>4+38h]<br>(v2 + v1</em>4 + 38h)(pst1,pst2)</p>
<p>pop esi<br>retn</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">尝试还原一下数据类型</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Struct1:<br>unknown<br>+0x23 v3 Byte<br>unknown<br>+0x60 v1 pStruct3</p>
<p>Struct2:<br>unknown<br>+0x8  pStruct4</p>
<p>Struct3:<br>unknown<br>+0x14 pStruct2</p>
<p>Struct4:<br>unknown<br>+0x38 pfnArray Array(function)</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">书中要求看完第三章后回头看这个数据类型。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 7</span></span><br><span class="line"></span><br><span class="line">同样是上面的网友给出了这个函数[practical-reverse-engineering<span class="regexp">/code.asm at master · baderj/</span>practical-reverse-engineering (github.com)](https:<span class="regexp">//gi</span>thub.com<span class="regexp">/baderj/</span>practical-reverse-engineering<span class="regexp">/blob/m</span>aster<span class="regexp">/chapter_1/</span>page_35<span class="regexp">/exercise_7/</span>code.asm)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<pre><code>mov     eax, [esp+4]
push    ebx
push    esi
mov     esi, [eax+3Ch]
add     esi, eax
movzx   eax, word ptr [esi+14h]
xor     ebx, ebx
cmp     [esi+6], bx
push    edi
lea     edi, [eax+esi+18h]
jbe     short loc_0_10BEB
</code></pre>
<p>loc_0_10BCE:<br>    push    [esp+0Ch+8]<br>    push    edi<br>    call    ds:dword_0_169A4<br>    test    eax, eax<br>    pop     ecx<br>    pop     ecx<br>    jz      short loc_0_10BF3<br>    movzx   eax, word ptr [esi+6]<br>    add     edi, 28h<br>    inc     ebx<br>    cmp     ebx, eax<br>    jb      short loc_0_10BCE</p>
<p>loc_0_10BEB:<br>    xor     eax, eax</p>
<p>loc_0_10BED:<br>    pop     edi<br>    pop     esi<br>    pop     ebx<br>    retn    8</p>
<p>loc_0_10BF3:<br>    mov     eax, edi<br>    jmp     short loc_0_10BED</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">反编译：</span><br></pre></td></tr></table></figure>
<p>ret_type sub_10BB6(arg_type_1 arg_1){<br>    var_type_1 v1 = arg_1-&gt;off_3Ch;<br>    v1 += arg_1;<br>    int i = 0; // ebx<br>    var_type_2 v2 = v1-&gt;off_14h;<br>    var_type_3 v3 = （type *）（v1 + v2 + 18h）;<br>    if(v1-&gt;off_6 &gt;= 0){<br>        return 0;<br>    }<br>    do{<br>        if( dword_0_169a4(v3, arg_n) == 0){// esp+0ch+8<br>            return v3;<br>        }<br>        v3 += 28h;<br>        i++;<br>    }while( i &lt; v1-&gt;off_6 );<br>}</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">差不多是这样。作者提示了这个函数是在搜索 PE 结构里的某些内容。首先粗略观察一下函数的开头，<span class="string">``</span>arg_1<span class="string">``</span>是某个结构体的指针，而<span class="string">``</span>v1<span class="string">``</span>也就是<span class="string">``</span>arg_1-&gt;off_3Ch<span class="string">``</span>应该是一个偏移量，因为稍后它又和<span class="string">``</span>arg_1<span class="string">``</span>相加了。</span><br><span class="line"></span><br><span class="line">接下来去 PE 结构里看看，哪个结构体偏移<span class="string">``</span><span class="number">3</span>Ch<span class="string">``</span>的地方保存着一个偏移量，第一眼看到的就是<span class="string">``</span>IMAGE_DOS_HEADER<span class="string">``</span>，它偏移<span class="string">``</span><span class="number">3</span>Ch<span class="string">``</span>的成员是<span class="string">``</span>e_lfanew<span class="string">``</span>，即<span class="string">``</span>IMAGE_NT_HEADERS<span class="string">``</span>的偏移，比较符合逻辑。那么先假设<span class="string">``</span>arg_type_1<span class="string">``</span>是<span class="string">``</span>pIMAGE_DOS_HEADER<span class="string">``</span>S。在此基础上，<span class="string">``</span>v2<span class="string">``</span>是 DWORD 类型的<span class="string">``</span>SizeOfOptionalHeader<span class="string">``</span>，<span class="string">``</span>v3<span class="string">``</span>是<span class="string">``</span>pIMAGE_NT_HEADERS + SizeOfOptionalHeader + <span class="number">18</span>h<span class="string">``</span>，其中 <span class="string">``</span><span class="number">18</span>h<span class="string">``</span>正是<span class="string">``</span>OptionalHeader<span class="string">``</span>相对于<span class="string">``</span>IMAGE_NT_HEADERS<span class="string">``</span>的偏移，所以 <span class="string">``</span>v3<span class="string">``</span>实际指向了第一个<span class="string">``</span>IMAGE_SECTION_HEADER<span class="string">``</span>。而<span class="string">``</span>v1-&gt;off_6<span class="string">``</span>指向的正是<span class="string">``</span>NumberOfSections<span class="string">``</span>，也就是<span class="string">``</span>IMAGE_SECTION_HEADER<span class="string">``</span>的个数。而出现在循环体里的常量<span class="string">``</span><span class="number">28</span>h<span class="string">``</span>是一个<span class="string">``</span>IMAGE_SECTION_HEADER<span class="string">``</span>的大小。由此看来，这个假设应该是成立的。</span><br><span class="line"></span><br><span class="line">综合来看，该函数接受一个<span class="string">``</span>pIMAGE_DOS_HEADER<span class="string">``</span>，在对应的 PE 文件的<span class="string">``</span>IMAGE_SECTION_HEADER<span class="string">``</span>数组中查找符合某条件（取决于<span class="string">``</span>dowrd_0_169a4<span class="string">``</span>函数）的某个<span class="string">``</span>IMAGE_SECTION_HEADER<span class="string">``</span>，如果查找到会返回该 <span class="function"><span class="keyword">Section</span> Header 的指针，否则返回 0。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 8</span></span><br><span class="line"></span><br><span class="line">根据上面提到的地址不同的问题，找到函数<span class="string">``</span>sub_1172E<span class="string">``</span>。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>.text:0001172E ; =============== S U B R O U T I N E =======================================<br>.text:0001172E<br>.text:0001172E<br>.text:0001172E sub_1172E       proc near               ; CODE XREF: sub_11798+115↓p<br>.text:0001172E                                         ; sub_11798+157↓p<br>.text:0001172E<br>.text:0001172E arg_0           = dword ptr  4<br>.text:0001172E<br>.text:0001172E                 push    esi<br>.text:0001172F                 mov     esi, [esp+4+arg_0]<br>.text:00011733                 dec     esi<br>.text:00011734                 jz      short loc_1175F<br>.text:00011736                 dec     esi<br>.text:00011737                 jz      short loc_11755<br>.text:00011739                 dec     esi<br>.text:0001173A                 jz      short loc_1174B<br>.text:0001173C                 sub     esi, 9<br>.text:0001173F                 jnz     short loc_1176B<br>.text:00011741                 mov     esi, [eax+8]<br>.text:00011744                 shr     esi, 1<br>.text:00011746                 add     eax, 0Ch<br>.text:00011749                 jmp     short loc_11767<br>.text:0001174B ; —————————————————————————<br>.text:0001174B<br>.text:0001174B loc_1174B:                              ; CODE XREF: sub_1172E+C↑j<br>.text:0001174B                 mov     esi, [eax+3Ch]<br>.text:0001174E                 shr     esi, 1<br>.text:00011750                 add     eax, 5Eh ; ‘^’<br>.text:00011753                 jmp     short loc_11767<br>.text:00011755 ; —————————————————————————<br>.text:00011755<br>.text:00011755 loc_11755:                              ; CODE XREF: sub_1172E+9↑j<br>.text:00011755                 mov     esi, [eax+3Ch]<br>.text:00011758                 shr     esi, 1<br>.text:0001175A                 add     eax, 44h ; ‘D’<br>.text:0001175D                 jmp     short loc_11767<br>.text:0001175F ; —————————————————————————<br>.text:0001175F<br>.text:0001175F loc_1175F:                              ; CODE XREF: sub_1172E+6↑j<br>.text:0001175F                 mov     esi, [eax+3Ch]<br>.text:00011762                 shr     esi, 1<br>.text:00011764                 add     eax, 40h ; ‘@’<br>.text:00011767<br>.text:00011767 loc_11767:                              ; CODE XREF: sub_1172E+1B↑j<br>.text:00011767                                         ; sub_1172E+25↑j …<br>.text:00011767                 mov     [ecx], esi<br>.text:00011769                 mov     [edx], eax<br>.text:0001176B<br>.text:0001176B loc_1176B:                              ; CODE XREF: sub_1172E+11↑j<br>.text:0001176B                 pop     esi<br>.text:0001176C                 retn    4<br>.text:0001176C sub_1172E       endp</p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">每次 <span class="string">``d</span>ec esi<span class="string">``</span>，等于 <span class="number">0</span> 后跳转到一个位置，执行完成后最终又回到同一个位置（<span class="string">``</span>loc_11767<span class="string">``</span>），是一个 <span class="keyword">switch</span> <span class="keyword">case</span> 的结构。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ret_type sub_1172E(arg_type_1 arg_1, arg_type_2 arg_2, arg_type 3 arg_3, arg_type_4 arg_4)    {// arg_1 eax<br>                            // arg_2 ecx<br>                            // arg_3 edx<br>                            // arg_4 stack<br>    var_type_1 v1 = arg_4; // esi<br>    switch(v1){<br>        case 1:<br>            v1 = arg_1-&gt;off_3Ch;<br>            v1 &gt;&gt; 1;<br>            arg_1 += 48h;<br>            break;<br>        case 2:<br>            v1 = arg_1-&gt;off_3Ch;<br>            v1 &gt;&gt; 1;<br>            arg_1 += 44h;<br>            break;<br>        case 3:<br>            v1 = arg_1-&gt;off_3Ch;<br>            v1 &gt;&gt; 1;<br>            arg_1 += 5eh<br>            break;<br>        case 12:<br>            v1 = arg_1-&gt;off_8;<br>            v1 &gt;&gt; 1;<br>            arg_1 += 0Ch;<br>            break;<br>        default:<br>            return arg_1;<br>    }<br>    *arg_2 = v1;<br>    *arg_3 = arg_1;<br>    return arg_1;<br>}</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### <span class="number">9</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>.text:1000CEA0 ; =============== S U B R O U T I N E =======================================<br>.text:1000CEA0<br>.text:1000CEA0 ; Attributes: bp-based frame<br>.text:1000CEA0<br>.text:1000CEA0 sub_1000CEA0    proc near               ; CODE XREF: sub_10007A4B+1D7↑p<br>.text:1000CEA0                                         ; sub_1000AD4D+3A↑p …<br>.text:1000CEA0<br>.text:1000CEA0 arg_0           = dword ptr  8<br>.text:1000CEA0 arg_4           = byte ptr  0Ch<br>.text:1000CEA0<br>.text:1000CEA0                 push    ebp<br>.text:1000CEA1                 mov     ebp, esp<br>.text:1000CEA3                 push    edi<br>.text:1000CEA4                 mov     edi, [ebp+arg_0]<br>.text:1000CEA7                 xor     eax, eax<br>.text:1000CEA9                 or      ecx, 0FFFFFFFFh<br>.text:1000CEAC                 repne scasb<br>.text:1000CEAE                 add     ecx, 1<br>.text:1000CEB1                 neg     ecx<br>.text:1000CEB3                 sub     edi, 1<br>.text:1000CEB6                 mov     al, [ebp+arg_4]<br>.text:1000CEB9                 std<br>.text:1000CEBA                 repne scasb<br>.text:1000CEBC                 add     edi, 1<br>.text:1000CEBF                 cmp     [edi], al<br>.text:1000CEC1                 jz      short loc_1000CEC7<br>.text:1000CEC3                 xor     eax, eax<br>.text:1000CEC5                 jmp     short loc_1000CEC9<br>.text:1000CEC7 ; —————————————————————————<br>.text:1000CEC7<br>.text:1000CEC7 loc_1000CEC7:                           ; CODE XREF: sub_1000CEA0+21↑j<br>.text:1000CEC7                 mov     eax, edi<br>.text:1000CEC9<br>.text:1000CEC9 loc_1000CEC9:                           ; CODE XREF: sub_1000CEA0+25↑j<br>.text:1000CEC9                 cld<br>.text:1000CECA                 pop     edi<br>.text:1000CECB                 leave<br>.text:1000CECC                 retn<br>.text:1000CECC sub_1000CEA0    endp</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">反编译</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ret_type sub_1000CEA0( char* arg_0, char arg_4 ){</p>
<pre><code>char* v1 = arg_0; // edi
dword v2 = sizeof(arg_0) // ecx
v1 += v2;
char v3 = arg_4;
do&#123;
    v2--;
    if(*v2 == v3)&#123;
        return v2;
    &#125;
&#125; while( v2&gt;=0 )
return 0;
</code></pre>
<p>}</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### <span class="number">12</span></span><br><span class="line"></span><br><span class="line">从 BeaEngine 的 [Releases](https:<span class="comment">//github.com/BeaEngine/beaengine/releases)中下载 5.3.0 版本，首先尝试编译其中的例子（examples.pdf），选择其中 ``How to decode a limited block of bytes`` 给出的源代码进行编译。</span></span><br><span class="line"></span><br><span class="line">源代码（disasm.c），buffer 中的字节取自 notepad 中的一段机器码：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>#include &lt;stdio.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include “beaengine-5.3.0\headers\BeaEngine.h”<br>void DisassembleCode(char *start_offset, int size)<br>{<br>    DISASM infos;<br>    int len;<br>    char *end_offset = (char <em>)start_offset + size;<br>    (void)memset(&amp;infos, 0, sizeof(DISASM));<br>    infos.EIP = (UInt64)start_offset;<br>    while (!infos.Error)<br>    {<br>        infos.SecurityBlock = (int)end_offset - infos.EIP;<br>        if (infos.SecurityBlock &lt;= 0)<br>            break;<br>        len = Disasm(&amp;infos);<br>        switch (infos.Error)<br>        {<br>        case OUT_OF_BLOCK:<br>            (void)printf(“disasm engine is not allowed to read more memory \n”);<br>            break;<br>        case UNKNOWN_OPCODE:<br>            (void)printf(“%s\n”, &amp;infos.CompleteInstr);<br>            infos.EIP += 1;<br>            infos.Error = 0;<br>            break;<br>        default:<br>            (void)printf(“%s\n”, &amp;infos.CompleteInstr);<br>            infos.EIP += len;<br>        }<br>    };<br>    return;<br>}<br>int main(void)<br>{<br>    /</em> 1 byte is missing at the end of this buffer */<br>    char *buffer = “\x48\x83\xc4\x38\xc3\xcc\xcc”;<br>    DisassembleCode(buffer, strlen(buffer));<br>    return 0;<br>}</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">编译：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>gcc .\disasm.c .\beaengine-5.3.0\dll_x64\BeaEngine.lib</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">将<span class="string">``</span>dll_x64<span class="string">``</span>目录下的 Beaengine.dll 放到与可执行文件同一目录，运行结果：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>.\a.exe<br>add rsp, 38h<br>ret<br>int3<br>int3</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">与 Windbg 比对可知反汇编成功：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>00007ffc<code>df4008b3 4883c438        add     rsp,38h 00007ffc</code>df4008b7 c3              ret<br>00007ffc<code>df4008b8 cc              int     3 00007ffc</code>df4008b9 cc              int     3</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">在 ``disasm.c ``上进行修改，获取 EntryPoint </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### <span class="number">1.9</span></span><br><span class="line"></span><br><span class="line">![<span class="number">1.9</span>](practical-reverse-engineering/image<span class="number">-20220809141148013.</span>png)</span><br><span class="line"></span><br><span class="line">#### <span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>mov rax, [rip]<br>// 或者<br>call $+5<br>pop  rax</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### <span class="number">3.2</span><span class="number">.3</span></span><br><span class="line"></span><br><span class="line">如无特殊说明，使用的环境为 Win <span class="number">8.1</span> x64。</span><br><span class="line"></span><br><span class="line">（我真服了，作者留的题也太多了吧</span><br><span class="line"></span><br><span class="line">#### <span class="number">1</span></span><br><span class="line"></span><br><span class="line">&gt; 在Windows <span class="number">8</span> x64上，下面这些内核函数中内联的 InitalizeListHead 至少出现了一次。指出这些例程中 InitializeListHead 在何处内联。</span><br><span class="line"></span><br><span class="line">根据书中描述，InitiallizeListHead 将 Flink 和 Blink 指向自身，对应代码如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>VOID InitializeListHead(PLIST_ENTRY ListHead){<br>    ListHead-&gt;Flink = ListHead-&gt;Blink = ListHead<br>}</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">对应汇编形如：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>// x86<br>lea        eax, [esi+2Ch]<br>mov        [eax+4], eax<br>mov        [eax], eax</p>
<p>// x64<br>lea        r11, [rbx+48h]<br>mov        [r11+8], r11<br>mov        [r11], r11</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>CcAllocateInitializeMbcb</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>  nt!CcAllocateInitializeMbcb:<br>  fffff801<code>5217edd8 4053            push    rbx   fffff801</code>5217edda 4883ec20        sub     rsp,20h<br>  fffff801<code>5217edde bac0000000      mov     edx,0C0h   fffff801</code>5217ede3 b900020000      mov     ecx,200h<br>  fffff801<code>5217ede8 41b843634d62    mov     r8d,624D6343h   fffff801</code>5217edee e8cd161900      call    nt!ExAllocatePoolWithTag (fffff801<code>523104c0)   fffff801</code>5217edf3 488bd8          mov     rbx,rax<br>  fffff801<code>5217edf6 4885c0          test    rax,rax   fffff801</code>5217edf9 7454            je      nt!CcAllocateInitializeMbcb+0x77 (fffff801`5217ee4f)  Branch</p>
<p>  nt!CcAllocateInitializeMbcb+0x23:<br>  fffff801<code>5217edfb 33d2            xor     edx,edx   fffff801</code>5217edfd 41b8c0000000    mov     r8d,0C0h<br>  fffff801<code>5217ee03 488bc8          mov     rcx,rax   fffff801</code>5217ee06 e8b5dc0500      call    nt!memset (fffff801<code>521dcac0)   fffff801</code>5217ee0b b8fb020000      mov     eax,2FBh<br>  fffff801<code>5217ee10 488d4b30        lea     rcx,[rbx+30h]   fffff801</code>5217ee14 668903          mov     word ptr [rbx],ax<br>  fffff801<code>5217ee17 488d4310        lea     rax,[rbx+10h]   fffff801</code>5217ee1b 48894008        mov     qword ptr [rax+8],rax<br>  fffff801<code>5217ee1f 488900          mov     qword ptr [rax],rax   fffff801</code>5217ee22 488901          mov     qword ptr [rcx],rax<br>  fffff801<code>5217ee25 48894108        mov     qword ptr [rcx+8],rax   fffff801</code>5217ee29 483900          cmp     qword ptr [rax],rax<br>  fffff801<code>5217ee2c 7523            jne     nt!CcAllocateInitializeMbcb+0x79 (fffff801</code>5217ee51)  Branch</p>
<p>  nt!CcAllocateInitializeMbcb+0x56:<br>  …<br>  <figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  在``fffff801`5217ee10``处即``nt!CcAllocateInitializeMbcb+<span class="number">0</span>x39``处开始，初始化了两个双向链表``[rbx+<span class="number">30</span>h]``和``[rbx+<span class="number">10</span>h]``。</span><br><span class="line"></span><br><span class="line">- CmpInitcallbacks</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  kd&gt; uf CmpInitcallbacks<br>  nt!InitializeSListHead:<br>  fffff801<code>5214c42c 4883ec28        sub     rsp,28h   fffff801</code>5214c430 f6c10f          test    cl,0Fh<br>  fffff801<code>5214c433 750e            jne     nt!InitializeSListHead+0x17 (fffff801</code>5214c443)  Branch</p>
<p>  nt!InitializeSListHead+0x9:<br>  fffff801<code>5214c435 33c0            xor     eax,eax   fffff801</code>5214c437 488901          mov     qword ptr [rcx],rax<br>  fffff801<code>5214c43a 48894108        mov     qword ptr [rcx+8],rax   fffff801</code>5214c43e 4883c428        add     rsp,28h<br>  fffff801<code>5214c442 c3              ret   <figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="string">``</span>nt!<span class="symbol">InitializeSListHead</span>+<span class="number">0x9</span><span class="string">``</span> 处将<span class="string">``</span>[rcx]<span class="string">``</span>初始化为 <span class="symbol">NULL</span>。</span><br><span class="line"></span><br><span class="line">- <span class="symbol">ExCreatecallback</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!ExCreateCallback+0x146:   fffff801</code>524165c2 c70143616c6c    mov     dword ptr [rcx],6C6C6143h<br>  fffff801<code>524165c8 44887120        mov     byte ptr [rcx+20h],r14b   fffff801</code>524165cc 488d4110        lea     rax,[rcx+10h]<br>  fffff801<code>524165d0 48894008        mov     qword ptr [rax+8],rax   fffff801</code>524165d4 488900          mov     qword ptr [rax],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>ExpInitSystemPhase0</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>ExpInitSystemPhase1</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>ExpTimerInitialization</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>InitBootProcessor</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>IoCreateDevice</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!IoCreateDevice+0x385:<br>  fffff801<code>524e3ad1 488b442450      mov     rax,qword ptr [rsp+50h]   fffff801</code>524e3ad6 4883c050        add     rax,50h<br>  fffff801<code>524e3ada 48894008        mov     qword ptr [rax+8],rax   fffff801</code>524e3ade 488900          mov     qword ptr [rax],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>IoInitializeIrp</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!IoInitializeIrp+0x41:<br>  fffff801<code>5215b121 b806000000      mov     eax,6   fffff801</code>5215b126 668903          mov     word ptr [rbx],ax<br>  fffff801<code>5215b129 8d4701          lea     eax,[rdi+1]   fffff801</code>5215b12c 884343          mov     byte ptr [rbx+43h],al<br>  fffff801<code>5215b12f 65488b042588010000 mov   rax,qword ptr gs:[188h]   fffff801</code>5215b138 8a8842020000    mov     cl,byte ptr [rax+242h]<br>  fffff801<code>5215b13e 488d4320        lea     rax,[rbx+20h]   fffff801</code>5215b142 884b46          mov     byte ptr [rbx+46h],cl<br>  nt!IoInitializeIrp+0x65:<br>  fffff801<code>5215b145 48894008        mov     qword ptr [rax+8],rax   fffff801</code>5215b149 488900          mov     qword ptr [rax],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>KeInitializeMutex</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!KiInitializeMutant+0x3f:<br>  fffff801<code>520a5c87 488b7c2448      mov     rdi,qword ptr [rsp+48h]   fffff801</code>520a5c8c 488d4308        lea     rax,[rbx+8]<br>  fffff801<code>520a5c90 48894008        mov     qword ptr [rax+8],rax   fffff801</code>520a5c94 488900          mov     qword ptr [rax],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>KeInitializeProcess</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!KeInitializeProcess+0x1c:<br>  fffff801<code>524d2b70 c64102b2        mov     byte ptr [rcx+2],0B2h   fffff801</code>524d2b74 488d4108        lea     rax,[rcx+8]<br>  fffff801<code>524d2b78 48894008        mov     qword ptr [rax+8],rax   fffff801</code>524d2b7c 488900          mov     qword ptr [rax],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>KeInitializeTimerEx</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!KeInitializeTimerEx:<br>  fffff801<code>520cb494 4533c0          xor     r8d,r8d   fffff801</code>520cb497 488d4108        lea     rax,[rcx+8]<br>  fffff801<code>520cb49b 80c208          add     dl,8   fffff801</code>520cb49e 4c8901          mov     qword ptr [rcx],r8<br>  fffff801<code>520cb4a1 8811            mov     byte ptr [rcx],dl   fffff801</code>520cb4a3 48894008        mov     qword ptr [rax+8],rax<br>  fffff801<code>520cb4a7 488900          mov     qword ptr [rax],rax   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>KeInitializeTimerTable</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!KeInitializeTimerTable+0x77:   fffff801</code>525769b3 668983b2500000  mov     word ptr [rbx+50B2h],ax<br>  fffff801<code>525769ba 488d8308300000  lea     rax,[rbx+3008h]   fffff801</code>525769c1 488360f800      and     qword ptr [rax-8],0<br>  fffff801<code>525769c6 48894008        mov     qword ptr [rax+8],rax   fffff801</code>525769ca 488900          mov     qword ptr [rax],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>KiInitializeProcessor</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!KiInitializeProcessor+0x104:<br>  fffff801<code>523efeb0 4903c1          add     rax,r9   fffff801</code>523efeb3 488bcb          mov     rcx,rbx<br>  fffff801<code>523efeb6 48897c2420      mov     qword ptr [rsp+20h],rdi   fffff801</code>523efebb 49f7f1          div     rax,r9<br>  fffff801<code>523efebe 493bc6          cmp     rax,r14   fffff801</code>523efec1 490f47c6        cmova   rax,r14<br>  fffff801<code>523efec5 898668500000    mov     dword ptr [rsi+5068h],eax   fffff801</code>523efecb 89866c500000    mov     dword ptr [rsi+506Ch],eax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>KiInitializeThread ?</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!KiInitializeThread+0xeb:<br>  fffff802<code>3fddf2fb 488b0576d3feff  mov     rax,qword ptr [nt!KiInitialProcess+0x478 (fffff802</code>3fdcc678)]<br>  fffff802<code>3fddf302 488d8b00040000  lea     rcx,[rbx+400h]   fffff802</code>3fddf309 488911          mov     qword ptr [rcx],rdx<br>  fffff802<code>3fddf30c 48894108        mov     qword ptr [rcx+8],rax   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>MiInitializeLoadedModuleList</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>MiInitializePrefetchHead</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!MiInitializePrefetchHead:   fffff802</code>3fba2ba0 488d4108        lea     rax,[rcx+8]<br>  fffff802<code>3fba2ba4 48894008        mov     qword ptr [rax+8],rax   fffff802</code>3fba2ba8 488900          mov     qword ptr [rax],rax<br>  fffff802<code>3fba2bab 488d4118        lea     rax,[rcx+18h]   fffff802</code>3fba2baf 48894008        mov     qword ptr [rax+8],rax<br>  fffff802<code>3fba2bb3 488900          mov     qword ptr [rax],raxnt!MiInitializePrefetchHead:   fffff802</code>3fba2ba0 488d4108        lea     rax,[rcx+8]<br>  fffff802<code>3fba2ba4 48894008        mov     qword ptr [rax+8],rax   fffff802</code>3fba2ba8 488900          mov     qword ptr [rax],rax<br>  fffff802<code>3fba2bab 488d4118        lea     rax,[rcx+18h]   fffff802</code>3fba2baf 48894008        mov     qword ptr [rax+8],rax<br>  fffff802<code>3fba2bb3 488900          mov     qword ptr [rax],rax   fffff802</code>3fba2bbe 488900          mov     qword ptr [rax],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  三处</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>PspAllocateProcess</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!PspAllocateProcess+0x1d9:<br>  fffff801<code>524d1335 498d8508060000  lea     rax,[r13+608h]   fffff801</code>524d133c 48894008        mov     qword ptr [rax+8],rax<br>  fffff801<code>524d1340 488900          mov     qword ptr [rax],rax   fffff801</code>524d1343 4d89b5d8020000  mov     qword ptr [r13+2D8h],r14<br>  fffff801<code>524d134a 4d89b5c8020000  mov     qword ptr [r13+2C8h],r14   fffff801</code>524d1351 498d8570040000  lea     rax,[r13+470h]<br>  fffff801<code>524d1358 48894008        mov     qword ptr [rax+8],rax   fffff801</code>524d135c 488900          mov     qword ptr [rax],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  两处</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>PspAllocateThread</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!PspAllocateThread+0x21e:<br>  fffff801<code>524c5256 498d8e30060000  lea     rcx,[r14+630h]   fffff801</code>524c525d 448bc3          mov     r8d,ebx<br>  fffff801<code>524c5260 33d2            xor     edx,edx   fffff801</code>524c5262 e8410cc9ff      call    nt!KeInitializeSemaphore (fffff801<code>52155ea8)   fffff801</code>524c5267 498d86d8050000  lea     rax,[r14+5D8h]<br>  fffff801<code>524c526e 48894008        mov     qword ptr [rax+8],rax   fffff801</code>524c5272 488900          mov     qword ptr [rax],rax<br>  fffff801<code>524c5275 498d86f8060000  lea     rax,[r14+6F8h]   nt!PspAllocateThread+0x244:   fffff801</code>524c527c 48894008        mov     qword ptr [rax+8],rax<br>  fffff801<code>524c5280 488900          mov     qword ptr [rax],rax   fffff801</code>524c5283 498d8608070000  lea     rax,[r14+708h]<br>  fffff801<code>524c528a 48894008        mov     qword ptr [rax+8],rax   fffff801</code>524c528e 488900          mov     qword ptr [rax],rax<br>  fffff801<code>524c5291 4989be18070000  mov     qword ptr [r14+718h],rdi   fffff801</code>524c5298 498d8658060000  lea     rax,[r14+658h]<br>  fffff801<code>524c529f 48894008        mov     qword ptr [rax+8],rax   nt!PspAllocateThread+0x26b:   fffff801</code>524c52a3 488900          mov     qword ptr [rax],rax<br>  fffff801<code>524c52a6 4989be20070000  mov     qword ptr [r14+720h],rdi   fffff801</code>524c52ad 4989be08060000  mov     qword ptr [r14+608h],rdi<br>  fffff801<code>524c52b4 498d8610060000  lea     rax,[r14+610h]   fffff801</code>524c52bb 48894008        mov     qword ptr [rax+8],rax<br>  fffff801`524c52bf 488900          mov     qword ptr [rax],rax<br>  <figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">#### <span class="number">2</span></span><br><span class="line"></span><br><span class="line">&gt;  在下面函数中重复前一个练习，指出 InsertHeadList 在何处内联。</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>VOID InsertHeadList(PLIST_ENTRY ListHead, PLIST_ENTRY Entry){<br>    PLIST_ENTRY Flink;<br>    Flink = ListHead-&gt;Flink;<br>    Entry-&gt;Flink = Flink<br>    Entry-&gt;Blink = ListHead;<br>    Flink-&gt;Blink = Entry;<br>    ListHead-&gt;Flink = Entry;<br>    return;<br>}</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">对应汇编：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>// x86<br>mov        edx, [ebx]<br>mov        [ecx], edx<br>mov        [ecx+4], ebx<br>mov        [edx+4], ecx<br>mov        [ebx], ecx</p>
<p>// x64<br>mov        rcx, [rdi]<br>mov        [rax+8], rdi<br>mov        [rax], rcx<br>mov        [rcx+8], rax<br>mov        [rdi], rax</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">观察 <span class="symbol">C</span> 代码，可以看到 <span class="symbol">Entry</span> 的 <span class="symbol">Flink</span> 和 <span class="symbol">Blink</span> 都被修改，将存储 <span class="symbol">Entry</span> 的寄存器记为 <span class="string">``</span>entry<span class="string">``</span>，则（x64 中）<span class="string">``</span>[entry]<span class="string">``</span>和<span class="string">``</span>[entry+<span class="number">8</span>]<span class="string">``</span>都将被修改，分别被修改为为<span class="string">``</span>flink<span class="string">``</span>和<span class="string">``</span>listhead<span class="string">``</span>；而 <span class="symbol">ListHead</span>-&gt;<span class="symbol">Flink</span> 和 <span class="symbol">Flink</span>-&gt;<span class="symbol">Blink</span> 都会被修改为 <span class="symbol">Entry</span>，即<span class="string">``</span>[listhead]<span class="string">``</span>和<span class="string">``</span>[flink+<span class="number">8</span>]<span class="string">``</span>都被修改为<span class="string">``</span>entry<span class="string">``</span>。</span><br><span class="line"></span><br><span class="line">- <span class="symbol">CcSetVacbInFreeList</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>  nt!CcSetVacbInFreeList:<br>  fffff801<code>5210bc30 4883ec28        sub     rsp,28h   fffff801</code>5210bc34 ff0d1e332100    dec     dword ptr [nt!CcNumberOfMappedVacbs (fffff801<code>5231ef58)]   fffff801</code>5210bc3a 4c8bc1          mov     r8,rcx<br>  fffff801<code>5210bc3d 84d2            test    dl,dl   fffff801</code>5210bc3f 0f85cf7e0f00    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x23664 (fffff801</code>52203b14)<br>  fffff801<code>5210bc45 488d4110        lea     rax,[rcx+10h]   fffff801</code>5210bc49 488b0dd0962400  mov     rcx,qword ptr [nt!CcVacbFreeList (fffff801<code>52355320)]   fffff801</code>5210bc50 488d15c9962400  lea     rdx,[nt!CcVacbFreeList (fffff801<code>52355320)]   1: kd&gt; u   nt!CcSetVacbInFreeList+0x27:   fffff801</code>5210bc57 488908          mov     qword ptr [rax],rcx<br>  fffff801<code>5210bc5a 48895008        mov     qword ptr [rax+8],rdx   fffff801</code>5210bc5e 48395108        cmp     qword ptr [rcx+8],rdx<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CmpDoSort</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>ExBurnMemory</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>ExFreePoolWithTag - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!ExFreePoolWithTag+0xf9f:<br>  fffff802<code>3fceafae 4883c114        add     rcx,14h   fffff802</code>3fceafb2 48c1e104        shl     rcx,4<br>  fffff802<code>3fceafb6 4903cc          add     rcx,r12   fffff802</code>3fceafb9 488b01          mov     rax,qword ptr [rcx]<br>  fffff802<code>3fceafbc 48894b08        mov     qword ptr [rbx+8],rcx   fffff802</code>3fceafc0 488903          mov     qword ptr [rbx],rax<br>  fffff802<code>3fceafc3 48394808        cmp     qword ptr [rax+8],rcx   fffff802</code>3fceafc7 7564            jne     nt!ExFreePoolWithTag+0x101e (fffff802<code>3fceb02d)   kd&gt;    nt!ExFreePoolWithTag+0xfba:   fffff802</code>3fceafc9 48895808        mov     qword ptr [rax+8],rbx<br>  fffff802<code>3fceafcd 488919          mov     qword ptr [rcx],rbx   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>IoPageRead - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!IoPageRead+0x1a0:   fffff802</code>3fae91f0 f0480fba2b00    lock bts qword ptr [rbx],0<br>  fffff802<code>3fae91f6 0f8233010000    jb      nt!IoPageRead+0x2df (fffff802</code>3fae932f)<br>  fffff802<code>3fae91fc 498b06          mov     rax,qword ptr [r14]   fffff802</code>3fae91ff 4c897608        mov     qword ptr [rsi+8],r14<br>  fffff802<code>3fae9203 488906          mov     qword ptr [rsi],rax   fffff802</code>3fae9206 4c397008        cmp     qword ptr [rax+8],r14<br>  fffff802<code>3fae920a 0f8526111600    jne     nt! ?? ::FNODOBFM::</code>string’+0xa17a (fffff802<code>3fc4a336)   fffff802</code>3fae9210 48897008        mov     qword ptr [rax+8],rsi<br>  fffff802<code>3fae9214 498936          mov     qword ptr [r14],rsi   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>IovpCallDriver1</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!IovpCallDriver1+0x440:   fffff802</code>400c4ac0 488b54d070      mov     rdx,qword ptr [rax+rdx*8+70h]<br>  fffff802<code>400c4ac5 488d4710        lea     rax,[rdi+10h]   fffff802</code>400c4ac9 48895728        mov     qword ptr [rdi+28h],rdx<br>  fffff802<code>400c4acd 0fba77041e      btr     dword ptr [rdi+4],1Eh   fffff802</code>400c4ad2 4c8b00          mov     r8,qword ptr [rax]<br>  fffff802<code>400c4ad5 498d5720        lea     rdx,[r15+20h]   fffff802</code>400c4ad9 4c8902          mov     qword ptr [rdx],r8<br>  fffff802<code>400c4adc 48894208        mov     qword ptr [rdx+8],rax   fffff802</code>400c4ae0 49394008        cmp     qword ptr [r8+8],rax<br>  fffff802<code>400c4ae4 7407            je      nt!IovpCallDriver1+0x46d (fffff802</code>400c4aed)<br>  fffff802<code>400c4ae6 b903000000      mov     ecx,3   fffff802</code>400c4aeb cd29            int     29h<br>  fffff802<code>400c4aed 49895008        mov     qword ptr [r8+8],rdx   fffff802</code>400c4af1 488910          mov     qword ptr [rax],rdx<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KeInitThread- win8</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!KeInitThread+0x15b:<br>  fffff802<code>3fdd92bb 4c33d8          xor     r11,rax   fffff802</code>3fdd92be 4c895b30        mov     qword ptr [rbx+30h],r11<br>  fffff802<code>3fdd92c2 488d87d0010000  lea     rax,[rdi+1D0h]   fffff802</code>3fdd92c9 c7401001020201  mov     dword ptr [rax+10h],1020201h<br>  fffff802<code>3fdd92d0 ba01000000      mov     edx,1   fffff802</code>3fdd92d5 4883c308        add     rbx,8<br>  fffff802<code>3fdd92d9 488b0b          mov     rcx,qword ptr [rbx]   fffff802</code>3fdd92dc 488908          mov     qword ptr [rax],rcx<br>  fffff802<code>3fdd92df 48895808        mov     qword ptr [rax+8],rbx   fffff802</code>3fdd92e3 48395908        cmp     qword ptr [rcx+8],rbx<br>  fffff802<code>3fdd92e7 0f856f230100    jne     nt! ?? ::OKHAJAOM::</code>string’+0x20a (fffff802<code>3fdeb65c)   fffff802</code>3fdd92ed 48894108        mov     qword ptr [rcx+8],rax<br>  fffff802<code>3fdd92f1 488903          mov     qword ptr [rbx],rax   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KiInsertQueueApc - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!KiInsertQueueApc+0x47:   fffff802</code>3fb4bce7 4803c8          add     rcx,rax<br>  fffff802<code>3fb4bcea 488b4108        mov     rax,qword ptr [rcx+8]   fffff802</code>3fb4bcee 483bc1          cmp     rax,rcx<br>  fffff802<code>3fb4bcf1 0f850a030000    jne     nt!KiInsertQueueApc+0x360 (fffff802</code>3fb4c001)<br>  fffff802<code>3fb4bcf7 4c8b00          mov     r8,qword ptr [rax]   fffff802</code>3fb4bcfa 488d4a10        lea     rcx,[rdx+10h]<br>  fffff802<code>3fb4bcfe 4c8901          mov     qword ptr [rcx],r8   fffff802</code>3fb4bd01 48894108        mov     qword ptr [rcx+8],rax<br>  fffff802<code>3fb4bd05 49394008        cmp     qword ptr [r8+8],rax   fffff802</code>3fb4bd09 0f85fb4e1000    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x145d0 (fffff802</code>3fc50c0a)<br>  fffff802<code>3fb4bd0f 49894808        mov     qword ptr [r8+8],rcx   fffff802</code>3fb4bd13 488908          mov     qword ptr [rax],rcx</p>
<p>  nt!KiInsertQueueApc+0x292:<br>  fffff802<code>3fb4bf34 488b01          mov     rax,qword ptr [rcx]   fffff802</code>3fb4bf37 49894808        mov     qword ptr [r8+8],rcx<br>  fffff802<code>3fb4bf3b 498900          mov     qword ptr [r8],rax   fffff802</code>3fb4bf3e 48394808        cmp     qword ptr [rax+8],rcx<br>  fffff802<code>3fb4bf42 0f85b44c1000    jne     nt! ?? ::FNODOBFM::</code>string’+0x145c2 (fffff802<code>3fc50bfc)   fffff802</code>3fb4bf48 4c894008        mov     qword ptr [rax+8],r8<br>  fffff802<code>3fb4bf4c 4c8901          mov     qword ptr [rcx],r8   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  两处</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KeInsertQueueDpc- win8</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!KeInsertQueueDpc+0x252:   fffff802</code>3fb1e1d3 4489942480000000 mov     dword ptr [rsp+80h],r10d<br>  fffff802<code>3fb1e1db e93afeffff      jmp     nt!KeInsertQueueDpc+0x9a (fffff802</code>3fb1e01a)<br>  fffff802<code>3fb1e1e0 cc              int     3   fffff802</code>3fb1e1e1 b102            mov     cl,2<br>  fffff802<code>3fb1e1e3 ff15e7a12a00    call    qword ptr [nt!_imp_HalRequestSoftwareInterrupt (fffff802</code>3fdc83d0)]<br>  fffff802<code>3fb1e1e9 e961ffffff      jmp     nt!KeInsertQueueDpc+0x1cf (fffff802</code>3fb1e14f)<br>  fffff802<code>3fb1e1ee 488b0f          mov     rcx,qword ptr [rdi]   fffff802</code>3fb1e1f1 48897808        mov     qword ptr [rax+8],rdi<br>  fffff802<code>3fb1e1f5 488908          mov     qword ptr [rax],rcx   fffff802</code>3fb1e1f8 48397908        cmp     qword ptr [rcx+8],rdi<br>  fffff802<code>3fb1e1fc 0f8511191300    jne     nt! ?? ::FNODOBFM::</code>string’+0x12087 (fffff802<code>3fc4fb13)   fffff802</code>3fb1e202 48894108        mov     qword ptr [rcx+8],rax<br>  fffff802<code>3fb1e206 488907          mov     qword ptr [rdi],rax   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>KiQueueReadyThread - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!KiQueueReadyThread+0x97:   fffff802</code>3fb35367 4881c3d8000000  add     rbx,0D8h<br>  fffff802<code>3fb3536e 48c1e104        shl     rcx,4   fffff802</code>3fb35372 8983dc000000    mov     dword ptr [rbx+0DCh],eax<br>  fffff802<code>3fb35378 4803cf          add     rcx,rdi   fffff802</code>3fb3537b 4084ed          test    bpl,bpl<br>  fffff802<code>3fb3537e 7444            je      nt!KiQueueReadyThread+0xf4 (fffff802</code>3fb353c4)<br>  fffff802<code>3fb35380 488b01          mov     rax,qword ptr [rcx]   fffff802</code>3fb35383 48894b08        mov     qword ptr [rbx+8],rcx<br>  fffff802<code>3fb35387 488903          mov     qword ptr [rbx],rax   fffff802</code>3fb3538a 48394808        cmp     qword ptr [rax+8],rcx<br>  fffff802<code>3fb3538e 0f8597c31100    jne     nt! ?? ::FNODOBFM::</code>string’+0x15448 (fffff802<code>3fc5172b)   fffff802</code>3fb35394 48895808        mov     qword ptr [rax+8],rbx<br>  fffff802<code>3fb35398 488919          mov     qword ptr [rcx],rbx   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>MiInsertInSystemSpace - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!MiInsertInSystemSpace+0x201:   fffff802</code>3faa999d 498b03          mov     rax,qword ptr [r11]<br>  fffff802<code>3faa99a0 4d895e08        mov     qword ptr [r14+8],r11   fffff802</code>3faa99a4 498906          mov     qword ptr [r14],rax<br>  fffff802<code>3faa99a7 4c395808        cmp     qword ptr [rax+8],r11   fffff802</code>3faa99ab 0f85f59a1100    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x19f67 (fffff802</code>3fbc34a6)<br>  fffff802<code>3faa99b1 4c897008        mov     qword ptr [rax+8],r14   fffff802</code>3faa99b5 4d8933          mov     qword ptr [r11],r14<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>MiUpdateWsle - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!MiUpdateWsle+0x279:<br>  fffff802<code>3fb3d409 488b4708        mov     rax,qword ptr [rdi+8]   fffff802</code>3fb3d40d 48397908        cmp     qword ptr [rcx+8],rdi<br>  fffff802<code>3fb3d411 0f85854ff6ff    jne     nt! ?? ::FNODOBFM::</code>string’+0x1d562 (fffff802<code>3faa239c)   fffff802</code>3fb3d417 483938          cmp     qword ptr [rax],rdi<br>  fffff802<code>3fb3d41a 0f857c4ff6ff    jne     nt! ?? ::FNODOBFM::</code>string’+0x1d562 (fffff802<code>3faa239c)   fffff802</code>3fb3d420 488908          mov     qword ptr [rax],rcx<br>  fffff802<code>3fb3d423 48894108        mov     qword ptr [rcx+8],rax   fffff802</code>3fb3d427 488b05f2942000  mov     rax,qword ptr [nt!MmWorkingSetExpansionHead (fffff802<code>3fd46920)]   fffff802</code>3fb3d42e 488d0deb942000  lea     rcx,[nt!MmWorkingSetExpansionHead (fffff802<code>3fd46920)]   fffff802</code>3fb3d435 488907          mov     qword ptr [rdi],rax<br>  fffff802<code>3fb3d438 48894f08        mov     qword ptr [rdi+8],rcx   fffff802</code>3fb3d43c 48394808        cmp     qword ptr [rax+8],rcx<br>  fffff802<code>3fb3d440 0f854f4ff6ff    jne     nt! ?? ::FNODOBFM::</code>string’+0x1d55b (fffff802<code>3faa2395)   fffff802</code>3fb3d446 48897808        mov     qword ptr [rax+8],rdi<br>  fffff802<code>3fb3d44a 48893dcf942000  mov     qword ptr [nt!MmWorkingSetExpansionHead (fffff802</code>3fd46920)],rdi<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>ObpInsertCallbackByAltitude - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!ObpInsertCallbackByAltitude+0x40:<br>  fffff802<code>3ff67380 f0480fba2b00    lock bts qword ptr [rbx],0   fffff802</code>3ff67386 0f8210761100    jb      nt! ?? ::NNGAKEGL::<code>string&#39;+0x3a8da (fffff802</code>4007e99c)<br>  fffff802<code>3ff6738c 4981c6c8000000  add     r14,0C8h   fffff802</code>3ff67393 498b3e          mov     rdi,qword ptr [r14]<br>  fffff802<code>3ff67396 493bfe          cmp     rdi,r14   fffff802</code>3ff67399 0f8593000000    jne     nt!ObpInsertCallbackByAltitude+0xf2 (fffff802<code>3ff67432)   fffff802</code>3ff6739f 488b4708        mov     rax,qword ptr [rdi+8]<br>  fffff802<code>3ff673a3 488b08          mov     rcx,qword ptr [rax]   kd&gt;    nt!ObpInsertCallbackByAltitude+0x66:   fffff802</code>3ff673a6 48894608        mov     qword ptr [rsi+8],rax<br>  fffff802<code>3ff673aa 48890e          mov     qword ptr [rsi],rcx   fffff802</code>3ff673ad 48394108        cmp     qword ptr [rcx+8],rax<br>  fffff802<code>3ff673b1 0f8522761100    jne     nt! ?? ::NNGAKEGL::</code>string’+0x3a917 (fffff802<code>4007e9d9)   fffff802</code>3ff673b7 48897108        mov     qword ptr [rcx+8],rsi<br>  fffff802`3ff673bb 488930          mov     qword ptr [rax],rsi<br>  <figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### <span class="number">3</span></span><br><span class="line"></span><br><span class="line">&gt; 在下面函数中重复前面练习，指出 InsertTailList 在何处内联。</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>VOID InsertTailList(PLIST_ENTRY ListHead, PLIST_ENTRY Entry){<br>    PLIST_ENTRY Blink;<br>    Blink = ListHead-&gt;Blink;<br>    Entry-&gt;Flink = ListHead;<br>    Entry-&gt;Blink = Blink;<br>    Blink-&gt;Flink = Entry;<br>    ListHead-&gt;Blink = Entry;<br>    return;<br>}</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">对应汇编：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>// x86<br>mov        ecx, [ebx+4]<br>mov     [eax], ebx<br>mov        [eax+4], ecx<br>mov        [ecx], eax<br>mov        [ebx+4], eax</p>
<p>// x64<br>mov        rcx, [rdi+8]<br>mov        [rax], rdi<br>mov        [rax+8], rcx<br>mov        [rcx], rax<br>mov        [rdi+8], rax</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>AlpcpCreateClientPort - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>  nt!AlpcpCreateClientPort+0x18f:<br>  fffff802<code>3fe7850f 4c8b65e0        mov     r12,qword ptr [rbp-20h]   fffff802</code>3fe78513 4981c448010000  add     r12,148h<br>  fffff802<code>3fe7851a f0490fba2c2400  lock bts qword ptr [r12],0   fffff802</code>3fe78521 0f82a6020000    jb      nt!AlpcpCreateClientPort+0x44d (fffff802<code>3fe787cd)   fffff802</code>3fe78527 488b4610        mov     rax,qword ptr [rsi+10h]<br>  fffff802<code>3fe7852b 488b4f10        mov     rcx,qword ptr [rdi+10h]   fffff802</code>3fe7852f 488b5020        mov     rdx,qword ptr [rax+20h]<br>  fffff802<code>3fe78533 4883c018        add     rax,18h   fffff802</code>3fe78537 4883c118        add     rcx,18h<br>  fffff802<code>3fe7853b 48895108        mov     qword ptr [rcx+8],rdx   fffff802</code>3fe7853f 488901          mov     qword ptr [rcx],rax<br>  fffff802<code>3fe78542 483902          cmp     qword ptr [rdx],rax   fffff802</code>3fe78545 0f852cb51f00    jne     nt! ?? ::NNGAKEGL::<code>string&#39;+0x2c1f9 (fffff802</code>40073a77)<br>  fffff802<code>3fe7854b 48890a          mov     qword ptr [rdx],rcx   fffff802</code>3fe7854e 48894808        mov     qword ptr [rax+8],rcx<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>AlpcpCreateSection - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!AlpcpCreateSection+0x161:<br>  fffff802<code>3fe906a1 4981c738010000  add     r15,138h   fffff802</code>3fe906a8 498b4708        mov     rax,qword ptr [r15+8]<br>  fffff802<code>3fe906ac 4c893e          mov     qword ptr [rsi],r15   fffff802</code>3fe906af 48894608        mov     qword ptr [rsi+8],rax<br>  fffff802<code>3fe906b3 4c3938          cmp     qword ptr [rax],r15   fffff802</code>3fe906b6 0f852d76f7ff    jne     nt! ?? ::NNGAKEGL::<code>string&#39;+0x2f5bf (fffff802</code>3fe07ce9)<br>  fffff802<code>3fe906bc 488930          mov     qword ptr [rax],rsi   fffff802</code>3fe906bf 49897708        mov     qword ptr [r15+8],rsi<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>AlpcpCreateView - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!AlpcpCreateView+0x1ec:<br>  fffff802<code>3fe847ec f0490fba2c2400  lock bts qword ptr [r12],0   fffff802</code>3fe847f3 0f825d010000    jb      nt!AlpcpCreateView+0x354 (fffff802<code>3fe84956)   fffff802</code>3fe847f9 4881c538010000  add     rbp,138h<br>  fffff802<code>3fe84800 488b4508        mov     rax,qword ptr [rbp+8]   fffff802</code>3fe84804 49892f          mov     qword ptr [r15],rbp<br>  fffff802<code>3fe84807 49894708        mov     qword ptr [r15+8],rax   fffff802</code>3fe8480b 483928          cmp     qword ptr [rax],rbp<br>  fffff802<code>3fe8480e 0f8503171f00    jne     nt! ?? ::NNGAKEGL::</code>string’+0x2f497 (fffff802<code>40075f17)   fffff802</code>3fe84814 4c8938          mov     qword ptr [rax],r15<br>  fffff802<code>3fe84817 4c897d08        mov     qword ptr [rbp+8],r15   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>AuthzBasepAddSecurityAttributeToLists - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!AuthzBasepAddSecurityAttributeToLists+0x17:   fffff802</code>3ff4106b 4d8b4808        mov     r9,qword ptr [r8+8]<br>  fffff802<code>3ff4106f 4c8900          mov     qword ptr [rax],r8   fffff802</code>3ff41072 4c894808        mov     qword ptr [rax+8],r9<br>  fffff802<code>3ff41076 4d3901          cmp     qword ptr [r9],r8   fffff802</code>3ff41079 7407            je      nt!AuthzBasepAddSecurityAttributeToLists+0x2e (fffff802<code>3ff41082)   fffff802</code>3ff4107b b903000000      mov     ecx,3<br>  fffff802<code>3ff41080 cd29            int     29h   fffff802</code>3ff41082 498901          mov     qword ptr [r9],rax<br>  fffff802`3ff41085 49894008        mov     qword ptr [r8+8],rax</p>
<p>  nt!AuthzBasepAddSecurityAttributeToLists+0x48:<br>  fffff802<code>3ff4109c 488d4108        lea     rax,[rcx+8]   fffff802</code>3ff410a0 4c8b4008        mov     r8,qword ptr [rax+8]<br>  fffff802<code>3ff410a4 488902          mov     qword ptr [rdx],rax   fffff802</code>3ff410a7 4c894208        mov     qword ptr [rdx+8],r8<br>  fffff802<code>3ff410ab 493900          cmp     qword ptr [r8],rax   fffff802</code>3ff410ae 7407            je      nt!AuthzBasepAddSecurityAttributeToLists+0x63 (fffff802<code>3ff410b7)   fffff802</code>3ff410b0 b903000000      mov     ecx,3<br>  fffff802<code>3ff410b5 cd29            int     29h   fffff802</code>3ff410b7 498910          mov     qword ptr [r8],rdx<br>  fffff802<code>3ff410ba 48895008        mov     qword ptr [rax+8],rdx   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  两处</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CcFlushCachePriv - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!CcFlushCachePriv+0xb36:   fffff802</code>3fb6f0c8 483901          cmp     qword ptr [rcx],rax<br>  fffff802<code>3fb6f0cb 757c            jne     nt!CcFlushCachePriv+0xbb7 (fffff802</code>3fb6f149)<br>  fffff802<code>3fb6f0cd 488911          mov     qword ptr [rcx],rdx   fffff802</code>3fb6f0d0 48894a08        mov     qword ptr [rdx+8],rcx<br>  fffff802<code>3fb6f0d4 488b158d3a1f00  mov     rdx,qword ptr [nt!CcDirtySharedCacheMapWithLogHandleList+0x8 (fffff802</code>3fd62b68)]<br>  fffff802<code>3fb6f0db 488d0d7e3a1f00  lea     rcx,[nt!CcDirtySharedCacheMapWithLogHandleList (fffff802</code>3fd62b60)]<br>  fffff802<code>3fb6f0e2 48895008        mov     qword ptr [rax+8],rdx   fffff802</code>3fb6f0e6 488908          mov     qword ptr [rax],rcx<br>  fffff802<code>3fb6f0e9 48390a          cmp     qword ptr [rdx],rcx   fffff802</code>3fb6f0ec 7554            jne     nt!CcFlushCachePriv+0xbb0 (fffff802<code>3fb6f142)   fffff802</code>3fb6f0ee 488902          mov     qword ptr [rdx],rax<br>  fffff802<code>3fb6f0f1 488905703a1f00  mov     qword ptr [nt!CcDirtySharedCacheMapWithLogHandleList+0x8 (fffff802</code>3fd62b68)],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CcInitializeCacheManager</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CcInsertVacbArray - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  fffff802<code>3fa84bcd 4c8d05ecde2d00  lea     r8,[nt!CcVacbFreeList (fffff802</code>3fd62ac0)]<br>  kd&gt;<br>  nt!CcInsertVacbArray+0x60:<br>  fffff802<code>3fa84bd4 4c8d0df5de2d00  lea     r9,[nt!CcVacbFreeHighPriorityList (fffff802</code>3fd62ad0)]<br>  fffff802<code>3fa84bdb 488378f000      cmp     qword ptr [rax-10h],0   fffff802</code>3fa84be0 7536            jne     nt!CcInsertVacbArray+0xa4 (fffff802<code>3fa84c18)   fffff802</code>3fa84be2 488b0ddfde2d00  mov     rcx,qword ptr [nt!CcVacbFreeList+0x8 (fffff802<code>3fd62ac8)]   fffff802</code>3fa84be9 4c8900          mov     qword ptr [rax],r8<br>  fffff802<code>3fa84bec 48894808        mov     qword ptr [rax+8],rcx   fffff802</code>3fa84bf0 4c3901          cmp     qword ptr [rcx],r8<br>  fffff802<code>3fa84bf3 7548            jne     nt!CcInsertVacbArray+0xc9 (fffff802</code>3fa84c3d)<br>  kd&gt;<br>  nt!CcInsertVacbArray+0x81:<br>  fffff802<code>3fa84bf5 488901          mov     qword ptr [rcx],rax   fffff802</code>3fa84bf8 ff059ade2d00    inc     dword ptr [nt!CcNumberOfFreeVacbs (fffff802<code>3fd62a98)]   fffff802</code>3fa84bfe 488905c3de2d00  mov     qword ptr [nt!CcVacbFreeList+0x8 (fffff802<code>3fd62ac8)],rax   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CcSetFileSizesEx</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!CcSetFileSizesEx+0x34a:   fffff802</code>3fb50f7c 0f851f2f0f00    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x2876 (fffff802</code>3fc43ea1)<br>  fffff802<code>3fb50f82 483930          cmp     qword ptr [rax],rsi   fffff802</code>3fb50f85 0f85162f0f00    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x2876 (fffff802</code>3fc43ea1)<br>  fffff802<code>3fb50f8b 488908          mov     qword ptr [rax],rcx   fffff802</code>3fb50f8e 48894108        mov     qword ptr [rcx+8],rax<br>  fffff802<code>3fb50f92 488b050f1c2100  mov     rax,qword ptr [nt!CcLazyWriterCursor+0x8 (fffff802</code>3fd62ba8)]<br>  fffff802<code>3fb50f99 48894608        mov     qword ptr [rsi+8],rax   fffff802</code>3fb50f9d 4c892e          mov     qword ptr [rsi],r13<br>  fffff802<code>3fb50fa0 4c3928          cmp     qword ptr [rax],r13   fffff802</code>3fb50fa3 0f85f12e0f00    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x286f (fffff802</code>3fc43e9a)<br>  fffff802<code>3fb50fa9 488930          mov     qword ptr [rax],rsi   fffff802</code>3fb50fac 33d2            xor     edx,edx<br>  fffff802<code>3fb50fae 410fb6c8        movzx   ecx,r8b   fffff802</code>3fb50fb2 488935ef1b2100  mov     qword ptr [nt!CcLazyWriterCursor+0x8 (fffff802<code>3fd62ba8)],rsi   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CmRenameKey -win8</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!CmRenameKey+0x3d6:   fffff802</code>3ffab0ca 0f84da080000    je      nt!CmRenameKey+0xcb6 (fffff802<code>3ffab9aa)   fffff802</code>3ffab0d0 488b4748        mov     rax,qword ptr [rdi+48h]<br>  fffff802<code>3ffab0d4 498d4c2420      lea     rcx,[r12+20h]   fffff802</code>3ffab0d9 4805c8000000    add     rax,0C8h<br>  fffff802<code>3ffab0df 488b5008        mov     rdx,qword ptr [rax+8]   fffff802</code>3ffab0e3 488901          mov     qword ptr [rcx],rax<br>  fffff802<code>3ffab0e6 48895108        mov     qword ptr [rcx+8],rdx   fffff802</code>3ffab0ea 483902          cmp     qword ptr [rdx],rax<br>  nt!CmRenameKey+0x3f9:<br>  fffff802<code>3ffab0ed 7407            je      nt!CmRenameKey+0x402 (fffff802</code>3ffab0f6)<br>  fffff802<code>3ffab0ef b903000000      mov     ecx,3   fffff802</code>3ffab0f4 cd29            int     29h<br>  fffff802<code>3ffab0f6 48890a          mov     qword ptr [rdx],rcx   fffff802</code>3ffab0f9 48894808        mov     qword ptr [rax+8],rcx</p>
<p>  nt!CmRenameKey+0x4d5:<br>  fffff802<code>3ffab1c9 e84e3eafff      call    nt!KiCheckForKernelApcDelivery (fffff802</code>3fa9f01c)<br>  fffff802<code>3ffab1ce 488b45c7        mov     rax,qword ptr [rbp-39h]   fffff802</code>3ffab1d2 4989442438      mov     qword ptr [r12+38h],rax<br>  fffff802<code>3ffab1d7 498b4e08        mov     rcx,qword ptr [r14+8]   fffff802</code>3ffab1db 498d4720        lea     rax,[r15+20h]<br>  fffff802<code>3ffab1df 4c8930          mov     qword ptr [rax],r14   fffff802</code>3ffab1e2 48894808        mov     qword ptr [rax+8],rcx<br>  fffff802<code>3ffab1e6 4c3931          cmp     qword ptr [rcx],r14   nt!CmRenameKey+0x4f5:   fffff802</code>3ffab1e9 7407            je      nt!CmRenameKey+0x4fe (fffff802<code>3ffab1f2)   fffff802</code>3ffab1eb b903000000      mov     ecx,3<br>  fffff802<code>3ffab1f0 cd29            int     29h   fffff802</code>3ffab1f2 488901          mov     qword ptr [rcx],rax<br>  fffff802<code>3ffab1f5 488bcf          mov     rcx,rdi   fffff802</code>3ffab1f8 49894608        mov     qword ptr [r14+8],rax</p>
<p>  nt!CmRenameKey+0x548:<br>  fffff802<code>3ffab23c 488b4308        mov     rax,qword ptr [rbx+8]   fffff802</code>3ffab240 49891f          mov     qword ptr [r15],rbx<br>  fffff802<code>3ffab243 49894708        mov     qword ptr [r15+8],rax   fffff802</code>3ffab247 483918          cmp     qword ptr [rax],rbx<br>  fffff802<code>3ffab24a 7407            je      nt!CmRenameKey+0x55f (fffff802</code>3ffab253)<br>  fffff802<code>3ffab24c b903000000      mov     ecx,3   fffff802</code>3ffab251 cd29            int     29h<br>  fffff802<code>3ffab253 4c8938          mov     qword ptr [rax],r15   nt!CmRenameKey+0x562:   fffff802</code>3ffab256 4c897b08        mov     qword ptr [rbx+8],r15<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  三处</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>ExAllocatePoolWithTag-  win8</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!ExAllocatePoolWithTag+0x9a2:<br>  fffff802<code>3fceb9de 4883c114        add     rcx,14h   fffff802</code>3fceb9e2 48c1e104        shl     rcx,4<br>  fffff802<code>3fceb9e6 4803cd          add     rcx,rbp   fffff802</code>3fceb9e9 488b4108        mov     rax,qword ptr [rcx+8]<br>  fffff802<code>3fceb9ed 48890e          mov     qword ptr [rsi],rcx   fffff802</code>3fceb9f0 48894608        mov     qword ptr [rsi+8],rax<br>  fffff802<code>3fceb9f4 483908          cmp     qword ptr [rax],rcx   fffff802</code>3fceb9f7 0f85c40b0000    jne     nt!ExFreePool+0x47a (fffff802<code>3fcec5c1)   nt!ExAllocatePoolWithTag+0x9c1:   fffff802</code>3fceb9fd 83bc24e800000000 cmp     dword ptr [rsp+0E8h],0<br>  fffff802<code>3fceba05 488930          mov     qword ptr [rax],rsi   fffff802</code>3fceba08 48897108        mov     qword ptr [rcx+8],rsi<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>ExFreePoolWithTag - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!ExFreePoolWithTag+0xdc2:<br>  fffff802<code>3fceadd1 488b4208        mov     rax,qword ptr [rdx+8]   fffff802</code>3fceadd5 488911          mov     qword ptr [rcx],rdx<br>  fffff802<code>3fceadd8 48894108        mov     qword ptr [rcx+8],rax   fffff802</code>3fceaddc 483910          cmp     qword ptr [rax],rdx<br>  fffff802<code>3fceaddf 0f853e1c0000    jne     nt!ExFreePool+0x945 (fffff802</code>3fceca23)<br>  fffff802<code>3fceade5 488b7db7        mov     rdi,qword ptr [rbp-49h]   fffff802</code>3fceade9 488908          mov     qword ptr [rax],rcx<br>  fffff802<code>3fceadec 48894a08        mov     qword ptr [rdx+8],rcx   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>ExQueueWorkItem - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure>   fffff802</code>3fb2f815 488b4b20        mov     rcx,qword ptr [rbx+20h]<br>  kd&gt;<br>  nt!ExQueueWorkItem+0x2b9:<br>  fffff802<code>3fb2f819 488d4318        lea     rax,[rbx+18h]   fffff802</code>3fb2f81d 48894f08        mov     qword ptr [rdi+8],rcx<br>  fffff802<code>3fb2f821 488907          mov     qword ptr [rdi],rax   fffff802</code>3fb2f824 483901          cmp     qword ptr [rcx],rax<br>  fffff802<code>3fb2f827 0f85c7a81400    jne     nt! ?? ::FNODOBFM::</code>string’+0x4d031 (fffff802<code>3fc7a0f4)   fffff802</code>3fb2f82d 488939          mov     qword ptr [rcx],rdi<br>  fffff802<code>3fb2f830 48897808        mov     qword ptr [rax+8],rdi   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>ExRegisterCallback</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!ExRegisterCallback+0x8b:   fffff802</code>3fbc4707 0f8265420b00    jb      nt! ?? ::FNODOBFM::<code>string&#39;+0x4b076 (fffff802</code>3fc78972)<br>  fffff802<code>3fbc470d 807e2000        cmp     byte ptr [rsi+20h],0   fffff802</code>3fbc4711 745e            je      nt!ExRegisterCallback+0xf5 (fffff802<code>3fbc4771)   fffff802</code>3fbc4713 488d4610        lea     rax,[rsi+10h]<br>  fffff802<code>3fbc4717 40b501          mov     bpl,1   fffff802</code>3fbc471a 488b4808        mov     rcx,qword ptr [rax+8]<br>  fffff802<code>3fbc471e 488903          mov     qword ptr [rbx],rax   fffff802</code>3fbc4721 48894b08        mov     qword ptr [rbx+8],rcx<br>  nt!ExRegisterCallback+0xa9:<br>  fffff802<code>3fbc4725 483901          cmp     qword ptr [rcx],rax   fffff802</code>3fbc4728 7552            jne     nt!ExRegisterCallback+0x100 (fffff802<code>3fbc477c)   fffff802</code>3fbc472a 488919          mov     qword ptr [rcx],rbx<br>  fffff802<code>3fbc472d 48895808        mov     qword ptr [rax+8],rbx   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>ExpSetTimer</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!ExpSetTimer+0x3db:   fffff802</code>3fae32eb 4c8b4208        mov     r8,qword ptr [rdx+8]<br>  fffff802<code>3fae32ef 488910          mov     qword ptr [rax],rdx   fffff802</code>3fae32f2 4c894008        mov     qword ptr [rax+8],r8<br>  fffff802<code>3fae32f6 493910          cmp     qword ptr [r8],rdx   fffff802</code>3fae32f9 0f850b7a1900    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x4dca0 (fffff802</code>3fc7ad0a)<br>  fffff802<code>3fae32ff 498900          mov     qword ptr [r8],rax   fffff802</code>3fae3302 48894208        mov     qword ptr [rdx+8],rax</p>
  <figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">- IoSetIoCompletio<span class="symbol">nEx2</span> - wi<span class="symbol">n8</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>  nt!IoSetIoCompletionEx2+0xd6:<br>  fffff802<code>3fadb5e6 488d4318        lea     rax,[rbx+18h]   fffff802</code>3fadb5ea 41f6c702        test    r15b,2<br>  fffff802<code>3fadb5ee 0f8564f61600    jne     nt! ?? ::FNODOBFM::</code>string’+0xb068 (fffff802<code>3fc4ac58)   fffff802</code>3fadb5f4 488b4808        mov     rcx,qword ptr [rax+8]<br>  fffff802<code>3fadb5f8 488907          mov     qword ptr [rdi],rax   fffff802</code>3fadb5fb 48894f08        mov     qword ptr [rdi+8],rcx<br>  fffff802<code>3fadb5ff 483901          cmp     qword ptr [rcx],rax   fffff802</code>3fadb602 0f8573f61600    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0xb08f (fffff802</code>3fc4ac7b)<br>  kd&gt;<br>  nt!IoSetIoCompletionEx2+0xf8:<br>  fffff802<code>3fadb608 488939          mov     qword ptr [rcx],rdi   fffff802</code>3fadb60b 48897808        mov     qword ptr [rax+8],rdi</p>
<p>  nt!IoSetIoCompletionEx2+0x42d:<br>  fffff802<code>3fadb932 72e1            jb      nt!IoSetIoCompletionEx2+0x410 (fffff802</code>3fadb915)<br>  fffff802<code>3fadb934 488b8c24b0000000 mov     rcx,qword ptr [rsp+0B0h]   fffff802</code>3fadb93c e991fcffff      jmp     nt!IoSetIoCompletionEx2+0xc2 (fffff802<code>3fadb5d2)   fffff802</code>3fadb941 ff4304          inc     dword ptr [rbx+4]<br>  fffff802<code>3fadb944 488d4318        lea     rax,[rbx+18h]   fffff802</code>3fadb948 41f6c402        test    r12b,2<br>  fffff802<code>3fadb94c 0f85e3f41600    jne     nt! ?? ::FNODOBFM::</code>string’+0xb25d (fffff802<code>3fc4ae35)   fffff802</code>3fadb952 488b4808        mov     rcx,qword ptr [rax+8]<br>  nt!IoSetIoCompletionEx2+0x451:<br>  fffff802<code>3fadb956 488907          mov     qword ptr [rdi],rax   fffff802</code>3fadb959 48894f08        mov     qword ptr [rdi+8],rcx<br>  fffff802<code>3fadb95d 483901          cmp     qword ptr [rcx],rax   fffff802</code>3fadb960 0f85f2f41600    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0xb284 (fffff802</code>3fc4ae58)<br>  fffff802<code>3fadb966 488939          mov     qword ptr [rcx],rdi   fffff802</code>3fadb969 48897808        mov     qword ptr [rax+8],rdi<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  两处</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KeInsertQueueDpc</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!KeInsertQueueDpc+0x103:<br>  fffff802<code>3fb1e083 488b4f08        mov     rcx,qword ptr [rdi+8]   fffff802</code>3fb1e087 488938          mov     qword ptr [rax],rdi<br>  fffff802<code>3fb1e08a 48894808        mov     qword ptr [rax+8],rcx   fffff802</code>3fb1e08e 483939          cmp     qword ptr [rcx],rdi<br>  fffff802<code>3fb1e091 0f85831a1300    jne     nt! ?? ::FNODOBFM::</code>string’+0x1208e (fffff802<code>3fc4fb1a)   fffff802</code>3fb1e097 488901          mov     qword ptr [rcx],rax<br>  fffff802<code>3fb1e09a 48894708        mov     qword ptr [rdi+8],rax   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KeStartThread - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!KeStartThread+0x23c:   fffff802</code>3fadbfa8 0f82302a0c00    jb      nt! ?? ::FNODOBFM::<code>string&#39;+0xe095 (fffff802</code>3fb9e9de)<br>  fffff802<code>3fadbfae 488b4e08        mov     rcx,qword ptr [rsi+8]   fffff802</code>3fadbfb2 488d87f8020000  lea     rax,[rdi+2F8h]<br>  fffff802<code>3fadbfb9 488930          mov     qword ptr [rax],rsi   fffff802</code>3fadbfbc 48894808        mov     qword ptr [rax+8],rcx<br>  fffff802<code>3fadbfc0 483931          cmp     qword ptr [rcx],rsi   fffff802</code>3fadbfc3 0f854c2a0c00    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0xe0cc (fffff802</code>3fb9ea15)<br>  fffff802<code>3fadbfc9 488901          mov     qword ptr [rcx],rax   nt!KeStartThread+0x260:   fffff802</code>3fadbfcc 48894608        mov     qword ptr [rsi+8],rax</p>
<p>  nt!KeStartThread+0x341:<br>  fffff802<code>3fadc0ad 488d8338020000  lea     rax,[rbx+238h]   fffff802</code>3fadc0b4 488d15c51b2700  lea     rdx,[nt!KiProcessListHead (fffff802<code>3fd4dc80)]   fffff802</code>3fadc0bb 488910          mov     qword ptr [rax],rdx<br>  fffff802<code>3fadc0be 48894808        mov     qword ptr [rax+8],rcx   fffff802</code>3fadc0c2 483911          cmp     qword ptr [rcx],rdx<br>  fffff802<code>3fadc0c5 0f85ee280c00    jne     nt! ?? ::FNODOBFM::</code>string’+0xe070 (fffff802<code>3fb9e9b9)   fffff802</code>3fadc0cb 488901          mov     qword ptr [rcx],rax<br>  fffff802<code>3fadc0ce 44853daf5f2f00  test    dword ptr [nt!PerfGlobalGroupMask+0x4 (fffff802</code>3fdd2084)],r15d<br>  nt!KeStartThread+0x369:<br>  fffff802<code>3fadc0d5 488905ac1b2700  mov     qword ptr [nt!KiProcessListHead+0x8 (fffff802</code>3fd4dc88)],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KiAddThreadToScbQueue- win8</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!KiAddThreadToScbQueue+0x49:<br>  fffff802<code>3fba0331 4883c206        add     rdx,6   fffff802</code>3fba0335 48c1e204        shl     rdx,4<br>  fffff802<code>3fba0339 4803d3          add     rdx,rbx   fffff802</code>3fba033c 488b4208        mov     rax,qword ptr [rdx+8]<br>  fffff802<code>3fba0340 488911          mov     qword ptr [rcx],rdx   fffff802</code>3fba0343 48894108        mov     qword ptr [rcx+8],rax<br>  fffff802<code>3fba0347 483910          cmp     qword ptr [rax],rdx   fffff802</code>3fba034a 0f85f02a0b00    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x1741c (fffff802</code>3fc52e40)<br>  nt!KiAddThreadToScbQueue+0x68:<br>  fffff802<code>3fba0350 488908          mov     qword ptr [rax],rcx   fffff802</code>3fba0353 48894a08        mov     qword ptr [rdx+8],rcx<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KiInsertQueueApc - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!KiInsertQueueApc+0x47:<br>  fffff802<code>3fb4bce7 4803c8          add     rcx,rax   fffff802</code>3fb4bcea 488b4108        mov     rax,qword ptr [rcx+8]<br>  fffff802<code>3fb4bcee 483bc1          cmp     rax,rcx   fffff802</code>3fb4bcf1 0f850a030000    jne     nt!KiInsertQueueApc+0x360 (fffff802<code>3fb4c001)   fffff802</code>3fb4bcf7 4c8b00          mov     r8,qword ptr [rax]<br>  fffff802<code>3fb4bcfa 488d4a10        lea     rcx,[rdx+10h]   fffff802</code>3fb4bcfe 4c8901          mov     qword ptr [rcx],r8<br>  fffff802<code>3fb4bd01 48894108        mov     qword ptr [rcx+8],rax   nt!KiInsertQueueApc+0x65:   fffff802</code>3fb4bd05 49394008        cmp     qword ptr [r8+8],rax<br>  fffff802<code>3fb4bd09 0f85fb4e1000    jne     nt! ?? ::FNODOBFM::</code>string’+0x145d0 (fffff802<code>3fc50c0a)   fffff802</code>3fb4bd0f 49894808        mov     qword ptr [r8+8],rcx<br>  fffff802`3fb4bd13 488908          mov     qword ptr [rax],rcx</p>
<p>  nt!KiInsertQueueApc+0x1cd:<br>  fffff802<code>3fb4be6d 4c8d4210        lea     r8,[rdx+10h]   fffff802</code>3fb4be71 490fbec1        movsx   rax,r9b<br>  fffff802<code>3fb4be75 48c1e004        shl     rax,4   fffff802</code>3fb4be79 4803c8          add     rcx,rax<br>  fffff802<code>3fb4be7c 488b4108        mov     rax,qword ptr [rcx+8]   fffff802</code>3fb4be80 498908          mov     qword ptr [r8],rcx<br>  fffff802<code>3fb4be83 49894008        mov     qword ptr [r8+8],rax   fffff802</code>3fb4be87 483908          cmp     qword ptr [rax],rcx<br>  nt!KiInsertQueueApc+0x1ea:<br>  fffff802<code>3fb4be8a 0f85734d1000    jne     nt! ?? ::FNODOBFM::</code>string’+0x145c9 (fffff802<code>3fc50c03)   fffff802</code>3fb4be90 4c8900          mov     qword ptr [rax],r8<br>  fffff802<code>3fb4be93 4c894108        mov     qword ptr [rcx+8],r8   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  两处</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KiQueueReadyThread - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!KiQueueReadyThread+0xf3:   fffff802</code>3fb353c3 c3              ret<br>  fffff802<code>3fb353c4 488b4108        mov     rax,qword ptr [rcx+8]   fffff802</code>3fb353c8 48890b          mov     qword ptr [rbx],rcx<br>  fffff802<code>3fb353cb 48894308        mov     qword ptr [rbx+8],rax   fffff802</code>3fb353cf 483908          cmp     qword ptr [rax],rcx<br>  fffff802<code>3fb353d2 0f855ac31100    jne     nt! ?? ::FNODOBFM::</code>string’+0x1544f (fffff802<code>3fc51732)   fffff802</code>3fb353d8 488918          mov     qword ptr [rax],rbx<br>  fffff802<code>3fb353db 48895908        mov     qword ptr [rcx+8],rbx   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>MiInsertNewProcess - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!MiInsertNewProcess+0x4a:   fffff802</code>3fad10fa 488bd1          mov     rdx,rcx<br>  fffff802<code>3fad10fd 498710          xchg    rdx,qword ptr [r8]   fffff802</code>3fad1100 4885d2          test    rdx,rdx<br>  fffff802<code>3fad1103 0f85c0000000    jne     nt!MiInsertNewProcess+0x119 (fffff802</code>3fad11c9)<br>  fffff802<code>3fad1109 488b0d08612700  mov     rcx,qword ptr [nt!MmProcessList+0x8 (fffff802</code>3fd47218)]<br>  fffff802<code>3fad1110 488d8778050000  lea     rax,[rdi+578h]   fffff802</code>3fad1117 488d15f2602700  lea     rdx,[nt!MmProcessList (fffff802<code>3fd47210)]   fffff802</code>3fad111e 488910          mov     qword ptr [rax],rdx<br>  nt!MiInsertNewProcess+0x71:<br>  fffff802<code>3fad1121 48894808        mov     qword ptr [rax+8],rcx   fffff802</code>3fad1125 483911          cmp     qword ptr [rcx],rdx<br>  fffff802<code>3fad1128 0f8558451800    jne     nt! ?? ::FNODOBFM::</code>string’+0x1ad34 (fffff802<code>3fc55686)   fffff802</code>3fad112e 488901          mov     qword ptr [rcx],rax<br>  fffff802<code>3fad1131 488905e0602700  mov     qword ptr [nt!MmProcessList+0x8 (fffff802</code>3fd47218)],rax</p>
<p>  nt!MiInsertNewProcess+0x91:<br>  fffff802<code>3fad1141 488d8730030000  lea     rax,[rdi+330h]   fffff802</code>3fad1148 488b5108        mov     rdx,qword ptr [rcx+8]<br>  fffff802<code>3fad114c 488908          mov     qword ptr [rax],rcx   fffff802</code>3fad114f 48895008        mov     qword ptr [rax+8],rdx<br>  fffff802<code>3fad1153 48390a          cmp     qword ptr [rdx],rcx   fffff802</code>3fad1156 0f8531451800    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x1ad3b (fffff802</code>3fc5568d)<br>  fffff802<code>3fad115c 488902          mov     qword ptr [rdx],rax   fffff802</code>3fad115f 48894108        mov     qword ptr [rcx+8],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  两处</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>PnpRequestDeviceAction - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!PnpRequestDeviceAction+0xad:<br>  fffff802<code>3fb81ff1 f0480fba2f00    lock bts qword ptr [rdi],0   fffff802</code>3fb81ff7 0f82d1a60c00    jb      nt! ?? ::FNODOBFM::<code>string&#39;+0xcefe (fffff802</code>3fc4c6ce)<br>  fffff802<code>3fb81ffd 488b0504d71c00  mov     rax,qword ptr [nt!PnpEnumerationRequestList+0x8 (fffff802</code>3fd4f708)]<br>  fffff802<code>3fb82004 488d0df5d61c00  lea     rcx,[nt!PnpEnumerationRequestList (fffff802</code>3fd4f700)]<br>  fffff802<code>3fb8200b 48894608        mov     qword ptr [rsi+8],rax   fffff802</code>3fb8200f 48890e          mov     qword ptr [rsi],rcx<br>  fffff802<code>3fb82012 483908          cmp     qword ptr [rax],rcx   fffff802</code>3fb82015 0f85c1a60c00    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0xcf0c (fffff802</code>3fc4c6dc)<br>  nt!PnpRequestDeviceAction+0xd7:<br>  fffff802<code>3fb8201b 488930          mov     qword ptr [rax],rsi   fffff802</code>3fb8201e 488935e3d61c00  mov     qword ptr [nt!PnpEnumerationRequestList+0x8 (fffff802<code>3fd4f708)],rsi   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>PspInsertProcess - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!PspInsertProcess+0xa0:   fffff802</code>3fe8ec9c 0f82e7010000    jb      nt!PspInsertProcess+0x28d (fffff802<code>3fe8ee89)   fffff802</code>3fe8eca2 488b0d6f3fe8ff  mov     rcx,qword ptr [nt!PsActiveProcessHead+0x8 (fffff802<code>3fd12c18)]   fffff802</code>3fe8eca9 488d87e8020000  lea     rax,[rdi+2E8h]<br>  fffff802<code>3fe8ecb0 488d15593fe8ff  lea     rdx,[nt!PsActiveProcessHead (fffff802</code>3fd12c10)]<br>  fffff802<code>3fe8ecb7 488910          mov     qword ptr [rax],rdx   fffff802</code>3fe8ecba 48894808        mov     qword ptr [rax+8],rcx<br>  fffff802<code>3fe8ecbe 483911          cmp     qword ptr [rcx],rdx   fffff802</code>3fe8ecc1 0f85cfa81f00    jne     nt! ?? ::NNGAKEGL::<code>string&#39;+0x46b22 (fffff802</code>40089596)<br>  nt!PspInsertProcess+0xcb:<br>  fffff802<code>3fe8ecc7 488901          mov     qword ptr [rcx],rax   fffff802</code>3fe8ecca 488905473fe8ff  mov     qword ptr [nt!PsActiveProcessHead+0x8 (fffff802<code>3fd12c18)],rax   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>PspInsertThread - win8</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!PspInsertThread+0x243:   fffff802</code>3feab2b3 83cb01          or      ebx,1<br>  fffff802<code>3feab2b6 895c2450        mov     dword ptr [rsp+50h],ebx   fffff802</code>3feab2ba 498db630060000  lea     rsi,[r14+630h]<br>  fffff802<code>3feab2c1 f0480fba2e00    lock bts qword ptr [rsi],0   fffff802</code>3feab2c7 0f824416f6ff    jb      nt! ?? ::NNGAKEGL::<code>string&#39;+0x46149 (fffff802</code>3fe0c911)<br>  fffff802<code>3feab2cd 498d8f00040000  lea     rcx,[r15+400h]   fffff802</code>3feab2d4 498d8670040000  lea     rax,[r14+470h]<br>  fffff802<code>3feab2db 488b5008        mov     rdx,qword ptr [rax+8]   nt!PspInsertThread+0x26f:   fffff802</code>3feab2df 488901          mov     qword ptr [rcx],rax<br>  fffff802<code>3feab2e2 48895108        mov     qword ptr [rcx+8],rdx   fffff802</code>3feab2e6 483902          cmp     qword ptr [rdx],rax<br>  fffff802<code>3feab2e9 0f853016f6ff    jne     nt! ?? ::NNGAKEGL::</code>string’+0x46157 (fffff802<code>3fe0c91f)   fffff802</code>3feab2ef 48890a          mov     qword ptr [rdx],rcx<br>  fffff802`3feab2f2 48894808        mov     qword ptr [rax+8],rcx<br>  <figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 小总结<span class="number">1</span></span><br><span class="line"></span><br><span class="line">InsertHeadList 和 InsertTailList 的汇编结构非常类似，相同点如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>…<br>mov        [rcx], rax<br>mov        [rcx+8], rdx<br>; 修改 entry 的 Flink 和 Blink</p>
<p>cmp<br>jne<br>; 判断，不相等则跳转，在后面的练习中提到</p>
<p>mov        [rax+8], rcx<br>mov        [rdx], rax<br>; 比照修改 entry 时链表中项的排列顺序，修改影响到的指针<br>; InsertHeadList 插入头部，就需要修改 ListHead-&gt;Flink 和 Flink-&gt;Blink<br>; InsertTailList 插入尾部，则需要修改 ListHead-&gt;Blink 和 Blink-&gt;Flink<br>; 而这部分在汇编上的体现是一样的，因为都在修改 entry 的 Flink 和 Blink 时决定了</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">所以区分 <span class="keyword">InsertHeadList </span>和 InertTailList 的方式只有第一步：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>mov        rax, [rdx]<br>; 如果时这样，那么 rax 就是 ListHead-&gt;Flink， rdx 是 LiskHead<br>; 后面加上上一部分的汇编，则是 InsertHeadList</p>
<p>mov        rdx, [rax+8]<br>; 这样则 rbx 是 ListHead-&gt;Blink，rax 是 ListHead<br>; 加上上一部分则是 InsertTailList</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">另外 ListHead 并不会总是保存在寄存器中，可能出现直接引用内存的情况。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### <span class="number">4</span></span><br><span class="line"></span><br><span class="line">&gt;  在下面函数中重复前面练习，指出 RemoveHeadList 在何处内联。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>BOOLEAN IsListEmpty(PLIST_ENTRY ListHead){<br>    return (BOOLEAN)(ListHead-&gt;Flink == ListHead);<br>}</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">对应汇编：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>// x86<br>mov        eax,[esi]<br>cmp        eax, esi</p>
<p>/ x64<br>mov        rax, [rbx]<br>cmp        rax, rbx</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>PLIST_ENTRY RemoveHeadList(PLIST_ENTRY ListHead){<br>    PLIST_ENTRY Flink;<br>    PLIST_ENTRY Entry;<br>    Entry = ListHead-&gt;Flink;<br>    Flink = Entry-&gt;Flink;<br>    ListHead-&gt;Flink = Flink;<br>    Flink-&gt;Blink = ListHead;<br>    return Entry;<br>}</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">对应汇编：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>// x86<br>mov        eax, [esi]<br>mov        ecx, [eax]<br>mov        [esi], ecx<br>mov        [ecx+4], esi</p>
<p>// x64<br>mov        rax, [rbx]<br>mov        rcx, [rax]<br>mov        [rbx], rcx<br>mov        [rcx+8], rbx</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">此处开始，练习在 win8 x64 下进行</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>AlpcpFlushResourcesPort</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>  nt!AlpcpFlushResourcesPort+0x29:<br>  fffff802<code>3fe86da9 0f82a9fc1e00    jb      nt! ?? ::NNGAKEGL::</code>string’+0x30412 (fffff802<code>40076a58)   fffff802</code>3fe86daf 4883cbff        or      rbx,0FFFFFFFFFFFFFFFFh<br>  fffff802<code>3fe86db3 498b36          mov     rsi,qword ptr [r14]   fffff802</code>3fe86db6 493bf6          cmp     rsi,r14<br>  fffff802<code>3fe86db9 7524            jne     nt!AlpcpFlushResourcesPort+0x5f (fffff802</code>3fe86ddf)<br>  …<br>  nt!AlpcpFlushResourcesPort+0x49:<br>  fffff802<code>3fe86dc9 488b5c2430      mov     rbx,qword ptr [rsp+30h]   fffff802</code>3fe86dce 488b742438      mov     rsi,qword ptr [rsp+38h]<br>  fffff802<code>3fe86dd3 488b7c2440      mov     rdi,qword ptr [rsp+40h]   fffff802</code>3fe86dd8 4883c420        add     rsp,20h<br>  fffff802<code>3fe86ddc 415e            pop     r14   fffff802</code>3fe86dde c3              ret<br>  fffff802<code>3fe86ddf 488b06          mov     rax,qword ptr [rsi]   fffff802</code>3fe86de2 4c397608        cmp     qword ptr [rsi+8],r14<br>  nt!AlpcpFlushResourcesPort+0x66:<br>  fffff802<code>3fe86de6 0f857afc1e00    jne     nt! ?? ::NNGAKEGL::</code>string’+0x30420 (fffff802<code>40076a66)   fffff802</code>3fe86dec 48397008        cmp     qword ptr [rax+8],rsi<br>  fffff802<code>3fe86df0 0f8570fc1e00    jne     nt! ?? ::NNGAKEGL::</code>string’+0x30420 (fffff802<code>40076a66)   fffff802</code>3fe86df6 498906          mov     qword ptr [r14],rax<br>  fffff802<code>3fe86df9 4c897008        mov     qword ptr [rax+8],r14   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CcDeleteMbcb</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!CcDeleteMbcb+0x12d:   fffff802</code>3fb7c525 440f22c0        mov     cr8,rax<br>  fffff802<code>3fb7c529 4c8d7e10        lea     r15,[rsi+10h]   fffff802</code>3fb7c52d 498b3f          mov     rdi,qword ptr [r15]<br>  fffff802<code>3fb7c530 493bff          cmp     rdi,r15   fffff802</code>3fb7c533 746d            je      nt!CcDeleteMbcb+0x1aa (fffff802<code>3fb7c5a2)   fffff802</code>3fb7c535 488b0f          mov     rcx,qword ptr [rdi]<br>  fffff802<code>3fb7c538 488b4708        mov     rax,qword ptr [rdi+8]   fffff802</code>3fb7c53c 48397908        cmp     qword ptr [rcx+8],rdi<br>  nt!CcDeleteMbcb+0x148:<br>  fffff802<code>3fb7c540 0f851e010000    jne     nt!CcDeleteMbcb+0x26c (fffff802</code>3fb7c664)<br>  fffff802<code>3fb7c546 483938          cmp     qword ptr [rax],rdi   fffff802</code>3fb7c549 0f8515010000    jne     nt!CcDeleteMbcb+0x26c (fffff802<code>3fb7c664)   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CcGetVacbMiss</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!CcGetVacbMiss+0x2a4:   fffff802</code>3fb4d8f4 5e              pop     rsi<br>  fffff802<code>3fb4d8f5 5d              pop     rbp   fffff802</code>3fb4d8f6 c3              ret<br>  fffff802<code>3fb4d8f7 488b02          mov     rax,qword ptr [rdx]   fffff802</code>3fb4d8fa 488d4dd8        lea     rcx,[rbp-28h]<br>  fffff802<code>3fb4d8fe 48394a08        cmp     qword ptr [rdx+8],rcx   fffff802</code>3fb4d902 0f8525900f00    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x5dc7 (fffff802</code>3fc4692d)<br>  fffff802<code>3fb4d908 48395008        cmp     qword ptr [rax+8],rdx   nt!CcGetVacbMiss+0x2bc:   fffff802</code>3fb4d90c 0f851b900f00    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x5dc7 (fffff802</code>3fc4692d)<br>  fffff802<code>3fb4d912 488945d8        mov     qword ptr [rbp-28h],rax   fffff802</code>3fb4d916 488d4dd8        lea     rcx,[rbp-28h]<br>  fffff802<code>3fb4d91a 48894808        mov     qword ptr [rax+8],rcx   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CmpLazyCommitWorker</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!CmpLazyCommitWorker+0x118:   fffff802</code>3ffae81c 65488b1c2588010000 mov   rbx,qword ptr gs:[188h]<br>  fffff802<code>3ffae825 f0410fba3600    lock btr dword ptr [r14],0   fffff802</code>3ffae82b 7208            jb      nt!CmpLazyCommitWorker+0x131 (fffff802<code>3ffae835)   fffff802</code>3ffae82d 498bce          mov     rcx,r14<br>  fffff802<code>3ffae830 e85375b3ff      call    nt!ExpAcquireFastMutexContended (fffff802</code>3fae5d88)<br>  fffff802<code>3ffae835 48891d0c2edbff  mov     qword ptr [nt!CmpTransactionListLock+0x8 (fffff802</code>3fd61648)],rbx<br>  fffff802<code>3ffae83c 488b1d5d2edbff  mov     rbx,qword ptr [nt!CmpLazyCommitListHead (fffff802</code>3fd616a0)]<br>  fffff802<code>3ffae843 488b03          mov     rax,qword ptr [rbx]   nt!CmpLazyCommitWorker+0x142:   fffff802</code>3ffae846 4c397b08        cmp     qword ptr [rbx+8],r15<br>  fffff802<code>3ffae84a 0f850c030000    jne     nt!CmpLazyCommitWorker+0x458 (fffff802</code>3ffaeb5c)<br>  fffff802<code>3ffae850 48395808        cmp     qword ptr [rax+8],rbx   fffff802</code>3ffae854 0f8502030000    jne     nt!CmpLazyCommitWorker+0x458 (fffff802<code>3ffaeb5c)   fffff802</code>3ffae85a 4889053f2edbff  mov     qword ptr [nt!CmpLazyCommitListHead (fffff802<code>3fd616a0)],rax   fffff802</code>3ffae861 4c897808        mov     qword ptr [rax+8],r15</p>
<p>  nt!CmpLazyCommitWorker+0x2a2:<br>  fffff802<code>3ffae9a6 e8dd73b3ff      call    nt!ExpAcquireFastMutexContended (fffff802</code>3fae5d88)<br>  fffff802<code>3ffae9ab 48891d962cdbff  mov     qword ptr [nt!CmpTransactionListLock+0x8 (fffff802</code>3fd61648)],rbx<br>  fffff802<code>3ffae9b2 488b45f0        mov     rax,qword ptr [rbp-10h]   fffff802</code>3ffae9b6 488d55f0        lea     rdx,[rbp-10h]<br>  fffff802<code>3ffae9ba 488b08          mov     rcx,qword ptr [rax]   fffff802</code>3ffae9bd 48395008        cmp     qword ptr [rax+8],rdx<br>  fffff802<code>3ffae9c1 0f858e010000    jne     nt!CmpLazyCommitWorker+0x451 (fffff802</code>3ffaeb55)<br>  fffff802<code>3ffae9c7 48394108        cmp     qword ptr [rcx+8],rax   nt!CmpLazyCommitWorker+0x2c7:   fffff802</code>3ffae9cb 0f8584010000    jne     nt!CmpLazyCommitWorker+0x451 (fffff802<code>3ffaeb55)   fffff802</code>3ffae9d1 48894df0        mov     qword ptr [rbp-10h],rcx<br>  fffff802<code>3ffae9d5 488d55f0        lea     rdx,[rbp-10h]   fffff802</code>3ffae9d9 48895108        mov     qword ptr [rcx+8],rdx<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  两处</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>ExAllocatePoolWithTag</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!ExAllocatePoolWithTag+0x421:<br>  fffff802<code>3fceb459 488d542440      lea     rdx,[rsp+40h]   fffff802</code>3fceb45e 49875500        xchg    rdx,qword ptr [r13]<br>  fffff802<code>3fceb462 4885d2          test    rdx,rdx   fffff802</code>3fceb465 0f85b3030000    jne     nt!ExAllocatePoolWithTag+0x7e4 (fffff802<code>3fceb81e)   fffff802</code>3fceb46b 48391b          cmp     qword ptr [rbx],rbx<br>  fffff802<code>3fceb46e 0f8433060000    je      nt!ExAllocatePoolWithTag+0xa6b (fffff802</code>3fcebaa7)<br>  fffff802<code>3fceb474 4c8b03          mov     r8,qword ptr [rbx]   fffff802</code>3fceb477 498b00          mov     rax,qword ptr [r8]<br>  kd&gt;<br>  nt!ExAllocatePoolWithTag+0x442:<br>  fffff802<code>3fceb47a 4c8b4808        mov     r9,qword ptr [rax+8]   fffff802</code>3fceb47e 4d3bc8          cmp     r9,r8<br>  fffff802<code>3fceb481 0f8594100000    jne     nt!ExFreePool+0x3d3 (fffff802</code>3fcec51b)<br>  fffff802<code>3fceb487 498b4008        mov     rax,qword ptr [r8+8]   fffff802</code>3fceb48b 4c3900          cmp     qword ptr [rax],r8<br>  fffff802<code>3fceb48e 0f8587100000    jne     nt!ExFreePool+0x3d3 (fffff802</code>3fcec51b)<br>  fffff802<code>3fceb494 498b00          mov     rax,qword ptr [r8]   fffff802</code>3fceb497 49395808        cmp     qword ptr [r8+8],rbx<br>  nt!ExAllocatePoolWithTag+0x463:<br>  fffff802<code>3fceb49b 0f8573100000    jne     nt!ExFreePool+0x3cc (fffff802</code>3fcec514)<br>  fffff802<code>3fceb4a1 4c394008        cmp     qword ptr [rax+8],r8   fffff802</code>3fceb4a5 0f8569100000    jne     nt!ExFreePool+0x3cc (fffff802<code>3fcec514)   fffff802</code>3fceb4ab 448ba424d0000000 mov     r12d,dword ptr [rsp+0D0h]<br>  fffff802<code>3fceb4b3 488903          mov     qword ptr [rbx],rax   fffff802</code>3fceb4b6 48895808        mov     qword ptr [rax+8],rbx<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>FsRtlNotifyCompleteIrpList</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!FsRtlNotifyCompleteIrpList+0x20:<br>  fffff802<code>3fe3bbd0 66214158        and     word ptr [rcx+58h],ax   fffff802</code>3fe3bbd4 83617c00        and     dword ptr [rcx+7Ch],0<br>  fffff802<code>3fe3bbd8 8bf2            mov     esi,edx   fffff802</code>3fe3bbda 488bf9          mov     rdi,rcx<br>  fffff802<code>3fe3bbdd 488d5940        lea     rbx,[rcx+40h]   fffff802</code>3fe3bbe1 488b03          mov     rax,qword ptr [rbx]<br>  fffff802<code>3fe3bbe4 488b0b          mov     rcx,qword ptr [rbx]   fffff802</code>3fe3bbe7 488b10          mov     rdx,qword ptr [rax]<br>  nt!FsRtlNotifyCompleteIrpList+0x3a:<br>  fffff802<code>3fe3bbea 4881e9a8000000  sub     rcx,0A8h   fffff802</code>3fe3bbf1 48395808        cmp     qword ptr [rax+8],rbx<br>  fffff802<code>3fe3bbf5 754b            jne     nt!FsRtlNotifyCompleteIrpList+0x92 (fffff802</code>3fe3bc42)<br>  fffff802<code>3fe3bbf7 48394208        cmp     qword ptr [rdx+8],rax   fffff802</code>3fe3bbfb 7545            jne     nt!FsRtlNotifyCompleteIrpList+0x92 (fffff802<code>3fe3bc42)   fffff802</code>3fe3bbfd 488913          mov     qword ptr [rbx],rdx<br>  fffff802<code>3fe3bc00 48895a08        mov     qword ptr [rdx+8],rbx   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>IopInitializeBootDrivers</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KiProcessDisconnectList</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!KiProcessDisconnectList:   fffff802</code>3fbf3fb0 fff3            push    rbx<br>  fffff802<code>3fbf3fb2 4883ec20        sub     rsp,20h   fffff802</code>3fbf3fb6 488bd9          mov     rbx,rcx<br>  fffff802<code>3fbf3fb9 488b03          mov     rax,qword ptr [rbx]   fffff802</code>3fbf3fbc 483bc3          cmp     rax,rbx<br>  fffff802<code>3fbf3fbf 7435            je      nt!KiProcessDisconnectList+0x46 (fffff802</code>3fbf3ff6)<br>  fffff802<code>3fbf3fc1 488b08          mov     rcx,qword ptr [rax]   fffff802</code>3fbf3fc4 48395808        cmp     qword ptr [rax+8],rbx<br>  nt!KiProcessDisconnectList+0x18:<br>  fffff802<code>3fbf3fc8 7525            jne     nt!KiProcessDisconnectList+0x3f (fffff802</code>3fbf3fef)<br>  fffff802<code>3fbf3fca 48394108        cmp     qword ptr [rcx+8],rax   fffff802</code>3fbf3fce 751f            jne     nt!KiProcessDisconnectList+0x3f (fffff802<code>3fbf3fef)   fffff802</code>3fbf3fd0 48890b          mov     qword ptr [rbx],rcx<br>  fffff802<code>3fbf3fd3 48895908        mov     qword ptr [rcx+8],rbx   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>PnpDeviceCompletionQueueGetCompletedRequest</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!PnpDeviceCompletionQueueGetCompletedRequest+0x49:   fffff802</code>3fbc45f9 488b1d78df1800  mov     rbx,qword ptr [nt!PnpDeviceCompletionQueue+0x18 (fffff802<code>3fd52578)]   fffff802</code>3fbc4600 488d0d71df1800  lea     rcx,[nt!PnpDeviceCompletionQueue+0x18 (fffff802<code>3fd52578)]   fffff802</code>3fbc4607 488b03          mov     rax,qword ptr [rbx]<br>  fffff802<code>3fbc460a 48394b08        cmp     qword ptr [rbx+8],rcx   fffff802</code>3fbc460e 755c            jne     nt!PnpDeviceCompletionQueueGetCompletedRequest+0xbc (fffff802<code>3fbc466c)   fffff802</code>3fbc4610 48395808        cmp     qword ptr [rax+8],rbx<br>  fffff802<code>3fbc4614 7556            jne     nt!PnpDeviceCompletionQueueGetCompletedRequest+0xbc (fffff802</code>3fbc466c)<br>  fffff802<code>3fbc4616 4889055bdf1800  mov     qword ptr [nt!PnpDeviceCompletionQueue+0x18 (fffff802</code>3fd52578)],rax<br>  nt!PnpDeviceCompletionQueueGetCompletedRequest+0x6d:<br>  fffff802<code>3fbc461d 48894808        mov     qword ptr [rax+8],rcx   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>RtlDestroyAtomTable</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>RtlEmptyAtomTable</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!RtlEmptyAtomTable+0x64:   fffff802</code>40006834 488bcf          mov     rcx,rdi<br>  fffff802<code>40006837 498906          mov     qword ptr [r14],rax   fffff802</code>4000683a 4c892b          mov     qword ptr [rbx],r13<br>  fffff802<code>4000683d e8e6cae9ff      call    nt!RtlpFreeHandleForAtom (fffff802</code>3fea3328)<br>  fffff802<code>40006842 488d7310        lea     rsi,[rbx+10h]   fffff802</code>40006846 483936          cmp     qword ptr [rsi],rsi<br>  fffff802<code>40006849 7428            je      nt!RtlEmptyAtomTable+0xa3 (fffff802</code>40006873)<br>  fffff802<code>4000684b 488b0e          mov     rcx,qword ptr [rsi]   nt!RtlEmptyAtomTable+0x7e:   fffff802</code>4000684e 488b01          mov     rax,qword ptr [rcx]<br>  fffff802<code>40006851 48397108        cmp     qword ptr [rcx+8],rsi   fffff802</code>40006855 0f85a1000000    jne     nt!RtlEmptyAtomTable+0x12c (fffff802<code>400068fc)   fffff802</code>4000685b 48394808        cmp     qword ptr [rax+8],rcx<br>  fffff802<code>4000685f 0f8597000000    jne     nt!RtlEmptyAtomTable+0x12c (fffff802</code>400068fc)<br>  fffff802<code>40006865 488906          mov     qword ptr [rsi],rax   fffff802</code>40006868 48897008        mov     qword ptr [rax+8],rsi<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>RtlpFreeAllAtom</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!RtlpFreeAllAtom+0x7b:<br>  fffff802<code>3fad5a7b 488b0b          mov     rcx,qword ptr [rbx]   fffff802</code>3fad5a7e 488b01          mov     rax,qword ptr [rcx]<br>  fffff802<code>3fad5a81 48395908        cmp     qword ptr [rcx+8],rbx   fffff802</code>3fad5a85 7514            jne     nt!RtlpFreeAllAtom+0x9b (fffff802<code>3fad5a9b)   fffff802</code>3fad5a87 48394808        cmp     qword ptr [rax+8],rcx<br>  fffff802<code>3fad5a8b 750e            jne     nt!RtlpFreeAllAtom+0x9b (fffff802</code>3fad5a9b)<br>  fffff802<code>3fad5a8d 488903          mov     qword ptr [rbx],rax   fffff802</code>3fad5a90 48895808        mov     qword ptr [rax+8],rbx<br>  <figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">#### <span class="number">5</span></span><br><span class="line"></span><br><span class="line">&gt; 在下面函数中重复前面练习，指出 RemoveTaillList 在何处内联。</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>PLIST_ENTRY RemoveTailList(PLIST_ENTRY ListHead){<br>    PLIST_ENTRY Blink;<br>    PLISTENTRY Entry;<br>    Entry = ListHead-&gt;Blink<br>    Blink = Entry-&gt;Blink;<br>    ListHead-&gt;Blink = Blink;<br>    Blink-&gt;Flink = ListHead;<br>    return Entry;<br>}</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">对应汇编：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>// x86<br>mov        ebx, [edi+4]<br>mov     eax, [ebx+4]<br>mov        [edi+4], eax<br>mov        [eax], edi</p>
<p>// x64<br>mov        rsi, [rdi+8]<br>mov        rax, [rsi+8]<br>mov        [rdi+8], rax<br>mov        [rax], rdi</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>BootApplicationPersistentDataProcess</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CmpCallCallBacks</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CmpDelayCloseWorker</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>  nt!CmpDelayCloseWorker+0xc7:<br>  fffff802<code>3fe55847 0fb6c3          movzx   eax,bl   fffff802</code>3fe5584a 890500c0f0ff    mov     dword ptr [nt!CmpDelayedCloseTableLock+0x30 (fffff802<code>3fd61850)],eax   fffff802</code>3fe55850 443b052993e9ff  cmp     r8d,dword ptr [nt!CmpDelayedCloseSize (fffff802<code>3fceeb80)]   fffff802</code>3fe55857 0f8689000000    jbe     nt!CmpDelayCloseWorker+0x166 (fffff802<code>3fe558e6)   fffff802</code>3fe5585d 488b0504c0f0ff  mov     rax,qword ptr [nt!CmpDelayedLRUListHead+0x8 (fffff802<code>3fd61868)]   fffff802</code>3fe55864 488b4808        mov     rcx,qword ptr [rax+8]<br>  fffff802<code>3fe55868 4c8d8828ffffff  lea     r9,[rax-0D8h]   fffff802</code>3fe5586f 483910          cmp     qword ptr [rax],rdx<br>  nt!CmpDelayCloseWorker+0xf2:<br>  fffff802<code>3fe55872 0f8543052000    jne     nt! ?? ::NNGAKEGL::</code>string’+0x9b81 (fffff802<code>40055dbb)   fffff802</code>3fe55878 483901          cmp     qword ptr [rcx],rax<br>  fffff802<code>3fe5587b 0f853a052000    jne     nt! ?? ::NNGAKEGL::</code>string’+0x9b81 (fffff802<code>40055dbb)   fffff802</code>3fe55881 48890de0bff0ff  mov     qword ptr [nt!CmpDelayedLRUListHead+0x8 (fffff802<code>3fd61868)],rcx   fffff802</code>3fe55888 488911          mov     qword ptr [rcx],rdx<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>ObpCallPostOperationCallbacks</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!ObpCallPostOperationCallbacks+0x1d:<br>  fffff802<code>3fff597d 7464            je      nt!ObpCallPostOperationCallbacks+0x83 (fffff802</code>3fff59e3)<br>  fffff802<code>3fff597f 488b7708        mov     rsi,qword ptr [rdi+8]   fffff802</code>3fff5983 488b4608        mov     rax,qword ptr [rsi+8]<br>  fffff802<code>3fff5987 48393e          cmp     qword ptr [rsi],rdi   fffff802</code>3fff598a 7550            jne     nt!ObpCallPostOperationCallbacks+0x7c (fffff802<code>3fff59dc)   fffff802</code>3fff598c 483930          cmp     qword ptr [rax],rsi<br>  fffff802<code>3fff598f 754b            jne     nt!ObpCallPostOperationCallbacks+0x7c (fffff802</code>3fff59dc)<br>  fffff802<code>3fff5991 48894708        mov     qword ptr [rdi+8],rax   nt!ObpCallPostOperationCallbacks+0x35:   fffff802</code>3fff5995 488938          mov     qword ptr [rax],rdi<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>RaspAddCacheEntry，这里怀疑是作者写错了，函数汇编很短，只有一个 InsertHeadList</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!RaspAddCacheEntry:<br>  fffff802<code>400df280 488b01          mov     rax,qword ptr [rcx]   fffff802</code>400df283 48894a08        mov     qword ptr [rdx+8],rcx<br>  fffff802<code>400df287 488902          mov     qword ptr [rdx],rax   fffff802</code>400df28a 48394808        cmp     qword ptr [rax+8],rcx<br>  fffff802<code>400df28e 7513            jne     nt!RaspAddCacheEntry+0x23 (fffff802</code>400df2a3)<br>  fffff802<code>400df290 48895008        mov     qword ptr [rax+8],rdx   fffff802</code>400df294 488911          mov     qword ptr [rcx],rdx<br>  <figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 小总结<span class="number">2</span></span><br><span class="line"></span><br><span class="line">RemoveHeadList 和 RemoveTailList 都只接受一个 ListHead 参数，因此需要获取需要 Remove 的那个 entry 和它后面（RemoveHeadList）或者前面（removeTailList）的一项来方便后续操作，因此会获取两次 Flink 或者 Blink，特征如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>; RemoveHeadList<br>mov        rax, [rcx]<br>mov        rdx, [rax]</p>
<p>; 或者 RemoveTailList<br>mov        rax, [rcx+8]<br>mov        rdx, [rax+8]</p>
<p>; 以下是共通的，与小总结1一样<br>cmp<br>jne<br>cmp<br>jne</p>
<p>; 将 ListHead 与 Flink 或者 Blink 连接到一起<br>; 省略</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### <span class="number">6</span></span><br><span class="line"></span><br><span class="line">&gt; 在下面函数中重复前面练习，指出 RemoveEntryList 在何处内联。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>BOOLEAN RemoveEntryList(PLIST_ENTRY Entry){<br>    PLIST_ENTRY Blink;<br>    PLIST_ENTRY Flink;<br>    Flink = Entry-&gt;Flink;<br>    Blink = Entry-&gt;Blink;<br>    Blink-&gt;Flink = Flink;<br>    Flink-&gt;Blink = Blink;<br>    return (BOOLEAN)(Flink == Blink);<br>}</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">对应汇编：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>// x86<br>mov        edx, [ecx]<br>mov        eax, [ecx+4]<br>mov        [eax], edx<br>mov        [edx+4], eax</p>
<p>// x64<br>mov        rdx, [rcx]<br>mov        rax, [rcx+8]<br>mov        [rax], rdx<br>mov        [rdx+8], rax</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>#define CONTAINING_RECORD(address, type, field) ((type <em>)( <br>                                                (PCHAR)(address) - <br>                                                (ULONG_PTR)(&amp;((type</em>) 0)-&gt;field)))</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>AlpcSectionDeleteProcedure</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>  nt!AlpcSectionDeleteProcedure+0x68:<br>  fffff802<code>3fe84a88 0f828e32f8ff    jb      nt! ?? ::NNGAKEGL::</code>string’+0x2f67a (fffff802<code>3fe07d1c)   fffff802</code>3fe84a8e 488b07          mov     rax,qword ptr [rdi]<br>  fffff802<code>3fe84a91 483bc7          cmp     rax,rdi   fffff802</code>3fe84a94 0f8599000000    jne     nt!AlpcSectionDeleteProcedure+0x113 (fffff802<code>3fe84b33)   ...   nt!AlpcSectionDeleteProcedure+0xf8:   fffff802</code>3fe84b18 415f            pop     r15<br>  fffff802<code>3fe84b1a 415e            pop     r14   fffff802</code>3fe84b1c 5f              pop     rdi<br>  fffff802<code>3fe84b1d c3              ret   fffff802</code>3fe84b1e 488b5618        mov     rdx,qword ptr [rsi+18h]<br>  fffff802<code>3fe84b22 4c8bc6          mov     r8,rsi   fffff802</code>3fe84b25 e806020000      call    nt!AlpcDeleteBlobByHandle (fffff802<code>3fe84d30)   fffff802</code>3fe84b2a 4c897e10        mov     qword ptr [rsi+10h],r15<br>  nt!AlpcSectionDeleteProcedure+0x10e:<br>  fffff802<code>3fe84b2e e918ffffff      jmp     nt!AlpcSectionDeleteProcedure+0x2b (fffff802</code>3fe84a4b)<br>  fffff802<code>3fe84b33 488b4f08        mov     rcx,qword ptr [rdi+8]   fffff802</code>3fe84b37 48397808        cmp     qword ptr [rax+8],rdi<br>  fffff802<code>3fe84b3b 7522            jne     nt!AlpcSectionDeleteProcedure+0x13f (fffff802</code>3fe84b5f)<br>  fffff802<code>3fe84b3d 483939          cmp     qword ptr [rcx],rdi   fffff802</code>3fe84b40 751d            jne     nt!AlpcSectionDeleteProcedure+0x13f (fffff802<code>3fe84b5f)   fffff802</code>3fe84b42 488901          mov     qword ptr [rcx],rax<br>  fffff802<code>3fe84b45 48894808        mov     qword ptr [rax+8],rcx   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>AlpcpDeletePort</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!AlpcpDeletePort+0xf1:   fffff802</code>3fe871c9 48878f98010000  xchg    rcx,qword ptr [rdi+198h]<br>  fffff802<code>3fe871d0 4885c9          test    rcx,rcx   fffff802</code>3fe871d3 0f851d010000    jne     nt!AlpcpDeletePort+0x21e (fffff802<code>3fe872f6)   fffff802</code>3fe871d9 483937          cmp     qword ptr [rdi],rsi<br>  fffff802<code>3fe871dc 7443            je      nt!AlpcpDeletePort+0x149 (fffff802</code>3fe87221)<br>  fffff802<code>3fe871de f0480fba2dc801ecff00 lock bts qword ptr [nt!AlpcpPortListLock (fffff802</code>3fd473b0)],0<br>  fffff802<code>3fe871e8 0f821c010000    jb      nt!AlpcpDeletePort+0x232 (fffff802</code>3fe8730a)<br>  fffff802<code>3fe871ee 488b17          mov     rdx,qword ptr [rdi]   nt!AlpcpDeletePort+0x119:   fffff802</code>3fe871f1 488b4708        mov     rax,qword ptr [rdi+8]<br>  fffff802<code>3fe871f5 48397a08        cmp     qword ptr [rdx+8],rdi   fffff802</code>3fe871f9 0f85e5f21e00    jne     nt! ?? ::NNGAKEGL::<code>string&#39;+0x2fe4e (fffff802</code>400764e4)<br>  fffff802<code>3fe871ff 483938          cmp     qword ptr [rax],rdi   fffff802</code>3fe87202 0f85dcf21e00    jne     nt! ?? ::NNGAKEGL::<code>string&#39;+0x2fe4e (fffff802</code>400764e4)<br>  fffff802<code>3fe87208 488910          mov     qword ptr [rax],rdx   fffff802</code>3fe8720b 48894208        mov     qword ptr [rdx+8],rax</p>
<p>  ; 看过头了，第二个不是这个函数的，就留在这里吧<br>  nt!AlpcConnectionDestroyProcedure+0x3a:<br>  fffff802<code>3fe873d6 f0480fba2e00    lock bts qword ptr [rsi],0   fffff802</code>3fe873dc 0f82b4000000    jb      nt!AlpcConnectionDestroyProcedure+0xfa (fffff802<code>3fe87496)   fffff802</code>3fe873e2 488d4718        lea     rax,[rdi+18h]<br>  fffff802<code>3fe873e6 488b10          mov     rdx,qword ptr [rax]   fffff802</code>3fe873e9 488b4808        mov     rcx,qword ptr [rax+8]<br>  fffff802<code>3fe873ed 48394208        cmp     qword ptr [rdx+8],rax   fffff802</code>3fe873f1 0f85b6000000    jne     nt!AlpcConnectionDestroyProcedure+0x111 (fffff802<code>3fe874ad)   fffff802</code>3fe873f7 483901          cmp     qword ptr [rcx],rax<br>  nt!AlpcConnectionDestroyProcedure+0x5e:<br>  fffff802<code>3fe873fa 0f85ad000000    jne     nt!AlpcConnectionDestroyProcedure+0x111 (fffff802</code>3fe874ad)<br>  fffff802<code>3fe87400 4883cbff        or      rbx,0FFFFFFFFFFFFFFFFh   fffff802</code>3fe87404 488911          mov     qword ptr [rcx],rdx<br>  fffff802<code>3fe87407 48894a08        mov     qword ptr [rdx+8],rcx   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>AlpcpUnregisterCompletionListDatabase</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!AlpcpUnregisterCompletionListDatabase:   fffff802</code>3fe0c67c fff3            push    rbx<br>  fffff802<code>3fe0c67e 4883ec20        sub     rsp,20h   fffff802</code>3fe0c682 f0480fba2d34adf3ff00 lock bts qword ptr [nt!AlpcpCompletionListDatabase (fffff802<code>3fd473c0)],0   fffff802</code>3fe0c68c 488bd9          mov     rbx,rcx<br>  fffff802<code>3fe0c68f 723a            jb      nt!AlpcpUnregisterCompletionListDatabase+0x4f (fffff802</code>3fe0c6cb)<br>  fffff802<code>3fe0c691 488b13          mov     rdx,qword ptr [rbx]   fffff802</code>3fe0c694 488b4308        mov     rax,qword ptr [rbx+8]<br>  fffff802<code>3fe0c698 48395a08        cmp     qword ptr [rdx+8],rbx   nt!AlpcpUnregisterCompletionListDatabase+0x20:   fffff802</code>3fe0c69c 753b            jne     nt!AlpcpUnregisterCompletionListDatabase+0x5d (fffff802<code>3fe0c6d9)   fffff802</code>3fe0c69e 483918          cmp     qword ptr [rax],rbx<br>  fffff802<code>3fe0c6a1 7536            jne     nt!AlpcpUnregisterCompletionListDatabase+0x5d (fffff802</code>3fe0c6d9)<br>  fffff802<code>3fe0c6a3 488910          mov     qword ptr [rax],rdx   fffff802</code>3fe0c6a6 48894208        mov     qword ptr [rdx+8],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>AuthzBasepRemoveSecurityAttributeFromLists</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!AuthzBasepRemoveSecurityAttributeFromLists+0x17:<br>  fffff802<code>3ff410e7 4c8b08          mov     r9,qword ptr [rax]   fffff802</code>3ff410ea 4c8b4008        mov     r8,qword ptr [rax+8]<br>  fffff802<code>3ff410ee 49394108        cmp     qword ptr [r9+8],rax   fffff802</code>3ff410f2 754b            jne     nt!AuthzBasepRemoveSecurityAttributeFromLists+0x6f (fffff802<code>3ff4113f)   fffff802</code>3ff410f4 493900          cmp     qword ptr [r8],rax<br>  fffff802<code>3ff410f7 7546            jne     nt!AuthzBasepRemoveSecurityAttributeFromLists+0x6f (fffff802</code>3ff4113f)<br>  fffff802<code>3ff410f9 4d8908          mov     qword ptr [r8],r9   fffff802</code>3ff410fc 4d894108        mov     qword ptr [r9+8],r8</p>
<p>  nt!AuthzBasepRemoveSecurityAttributeFromLists+0x47:<br>  fffff802<code>3ff41117 7425            je      nt!AuthzBasepRemoveSecurityAttributeFromLists+0x6e (fffff802</code>3ff4113e)<br>  fffff802<code>3ff41119 4c8b02          mov     r8,qword ptr [rdx]   fffff802</code>3ff4111c 488b4208        mov     rax,qword ptr [rdx+8]<br>  fffff802<code>3ff41120 49395008        cmp     qword ptr [r8+8],rdx   fffff802</code>3ff41124 7520            jne     nt!AuthzBasepRemoveSecurityAttributeFromLists+0x76 (fffff802<code>3ff41146)   fffff802</code>3ff41126 483910          cmp     qword ptr [rax],rdx<br>  fffff802<code>3ff41129 751b            jne     nt!AuthzBasepRemoveSecurityAttributeFromLists+0x76 (fffff802</code>3ff41146)<br>  fffff802<code>3ff4112b 4c8900          mov     qword ptr [rax],r8   kd&gt;    nt!AuthzBasepRemoveSecurityAttributeFromLists+0x5e:   fffff802</code>3ff4112e 49894008        mov     qword ptr [r8+8],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  两处</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CcDeleteBcbs</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CcFindNextWorkQueueEntry</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!CcFindNextWorkQueueEntry+0x16:<br>  fffff802<code>3fb6944a 744d            je      nt!CcFindNextWorkQueueEntry+0x65 (fffff802</code>3fb69499)<br>  fffff802<code>3fb6944c 3c02            cmp     al,2   fffff802</code>3fb6944e 7537            jne     nt!CcFindNextWorkQueueEntry+0x53 (fffff802<code>3fb69487)   fffff802</code>3fb69450 488b4210        mov     rax,qword ptr [rdx+10h]<br>  fffff802<code>3fb69454 4c8990f0010000  mov     qword ptr [rax+1F0h],r10   fffff802</code>3fb6945b 488b0a          mov     rcx,qword ptr [rdx]<br>  fffff802<code>3fb6945e 488b4208        mov     rax,qword ptr [rdx+8]   fffff802</code>3fb69462 48395108        cmp     qword ptr [rcx+8],rdx<br>  nt!CcFindNextWorkQueueEntry+0x32:<br>  fffff802<code>3fb69466 0f8540ae0d00    jne     nt! ?? ::FNODOBFM::</code>string’+0x323a (fffff802<code>3fc442ac)   fffff802</code>3fb6946c 483910          cmp     qword ptr [rax],rdx<br>  fffff802<code>3fb6946f 0f8537ae0d00    jne     nt! ?? ::FNODOBFM::</code>string’+0x323a (fffff802<code>3fc442ac)   fffff802</code>3fb69475 488908          mov     qword ptr [rax],rcx<br>  fffff802<code>3fb69478 48894108        mov     qword ptr [rcx+8],rax   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CcLazyWriteScan</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!CcLazyWriteScan+0x55c:   fffff802</code>3fb68b70 0f84cf000000    je      nt!CcLazyWriteScan+0x631 (fffff802<code>3fb68c45)   fffff802</code>3fb68b76 488b0d23a01f00  mov     rcx,qword ptr [nt!CcLazyWriterCursor (fffff802<code>3fd62ba0)]   fffff802</code>3fb68b7d 488b0524a01f00  mov     rax,qword ptr [nt!CcLazyWriterCursor+0x8 (fffff802<code>3fd62ba8)]   fffff802</code>3fb68b84 48397908        cmp     qword ptr [rcx+8],rdi<br>  fffff802<code>3fb68b88 0f85cabb0d00    jne     nt! ?? ::FNODOBFM::</code>string’+0x36e4 (fffff802<code>3fc44758)   fffff802</code>3fb68b8e 483938          cmp     qword ptr [rax],rdi<br>  fffff802<code>3fb68b91 0f85c1bb0d00    jne     nt! ?? ::FNODOBFM::</code>string’+0x36e4 (fffff802<code>3fc44758)   fffff802</code>3fb68b97 488908          mov     qword ptr [rax],rcx<br>  nt!CcLazyWriteScan+0x586:<br>  fffff802`3fb68b9a 48894108        mov     qword ptr [rcx+8],rax</p>
<p>  nt!CcLazyWriteScan+0x66c:<br>  fffff802<code>3fb68c80 b905000000      mov     ecx,5   fffff802</code>3fb68c85 44883db4a01f00  mov     byte ptr [nt!LazyWriter+0x80 (fffff802<code>3fd62d40)],r15b   fffff802</code>3fb68c8c e843b2ffff      call    nt!KeReleaseQueuedSpinLock (fffff802<code>3fb63ed4)   fffff802</code>3fb68c91 e9d1fbffff      jmp     nt!CcLazyWriteScan+0x253 (fffff802<code>3fb68867)   fffff802</code>3fb68c96 488b0d039f1f00  mov     rcx,qword ptr [nt!CcLazyWriterCursor (fffff802<code>3fd62ba0)]   fffff802</code>3fb68c9d 488b05049f1f00  mov     rax,qword ptr [nt!CcLazyWriterCursor+0x8 (fffff802<code>3fd62ba8)]   fffff802</code>3fb68ca4 48397908        cmp     qword ptr [rcx+8],rdi<br>  fffff802<code>3fb68ca8 0f85d4ba0d00    jne     nt! ?? ::FNODOBFM::</code>string’+0x370e (fffff802<code>3fc44782)   nt!CcLazyWriteScan+0x69a:   fffff802</code>3fb68cae 483938          cmp     qword ptr [rax],rdi<br>  fffff802<code>3fb68cb1 0f85cbba0d00    jne     nt! ?? ::FNODOBFM::</code>string’+0x370e (fffff802<code>3fc44782)   fffff802</code>3fb68cb7 488908          mov     qword ptr [rax],rcx<br>  fffff802`3fb68cba 48894108        mov     qword ptr [rcx+8],rax</p>
<p>  nt!CcLazyWriteScan+0x7a1:<br>  fffff802<code>3fb68db5 294150          sub     dword ptr [rcx+50h],eax   fffff802</code>3fb68db8 ebe6            jmp     nt!CcLazyWriteScan+0x78c (fffff802<code>3fb68da0)   fffff802</code>3fb68dba 488b08          mov     rcx,qword ptr [rax]<br>  fffff802<code>3fb68dbd 4c394008        cmp     qword ptr [rax+8],r8   fffff802</code>3fb68dc1 756c            jne     nt!CcLazyWriteScan+0x81b (fffff802<code>3fb68e2f)   fffff802</code>3fb68dc3 48394108        cmp     qword ptr [rcx+8],rax<br>  fffff802<code>3fb68dc7 7566            jne     nt!CcLazyWriteScan+0x81b (fffff802</code>3fb68e2f)<br>  fffff802<code>3fb68dc9 48890da09e1f00  mov     qword ptr [nt!CcPostTickWorkQueue (fffff802</code>3fd62c70)],rcx<br>  nt!CcLazyWriteScan+0x7bc:<br>  fffff802`3fb68dd0 4c894108        mov     qword ptr [rcx+8],r8</p>
<p>  nt!CcLazyWriteScan+0x7d8:<br>  fffff802<code>3fb68dec 488901          mov     qword ptr [rcx],rax   fffff802</code>3fb68def 488945d7        mov     qword ptr [rbp-29h],rax<br>  fffff802<code>3fb68df3 e9d1f8ffff      jmp     nt!CcLazyWriteScan+0xb5 (fffff802</code>3fb686c9)<br>  fffff802<code>3fb68df8 488b01          mov     rax,qword ptr [rcx]   fffff802</code>3fb68dfb 488d55cf        lea     rdx,[rbp-31h]<br>  fffff802<code>3fb68dff 48395108        cmp     qword ptr [rcx+8],rdx   fffff802</code>3fb68e03 7531            jne     nt!CcLazyWriteScan+0x822 (fffff802<code>3fb68e36)   fffff802</code>3fb68e05 48394808        cmp     qword ptr [rax+8],rcx<br>  nt!CcLazyWriteScan+0x7f5:<br>  fffff802<code>3fb68e09 752b            jne     nt!CcLazyWriteScan+0x822 (fffff802</code>3fb68e36)<br>  fffff802<code>3fb68e0b 488d55cf        lea     rdx,[rbp-31h]   fffff802</code>3fb68e0f 488945cf        mov     qword ptr [rbp-31h],rax<br>  fffff802<code>3fb68e13 48895008        mov     qword ptr [rax+8],rdx   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  三处</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CcSetFileSizesEx</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!CcSetFileSizesEx+0x324:   fffff802</code>3fb50f56 0fbae119        bt      ecx,19h<br>  fffff802<code>3fb50f5a 0f82ec2e0f00    jb      nt! ?? ::FNODOBFM::</code>string’+0x2815 (fffff802<code>3fc43e4c)   fffff802</code>3fb50f60 0fbae118        bt      ecx,18h<br>  fffff802<code>3fb50f64 0f82e22e0f00    jb      nt! ?? ::FNODOBFM::</code>string’+0x2815 (fffff802<code>3fc43e4c)   fffff802</code>3fb50f6a 4881c688000000  add     rsi,88h<br>  fffff802<code>3fb50f71 488b0e          mov     rcx,qword ptr [rsi]   fffff802</code>3fb50f74 488b4608        mov     rax,qword ptr [rsi+8]<br>  fffff802<code>3fb50f78 48397108        cmp     qword ptr [rcx+8],rsi   nt!CcSetFileSizesEx+0x34a:   fffff802</code>3fb50f7c 0f851f2f0f00    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x2876 (fffff802</code>3fc43ea1)<br>  fffff802<code>3fb50f82 483930          cmp     qword ptr [rax],rsi   fffff802</code>3fb50f85 0f85162f0f00    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x2876 (fffff802</code>3fc43ea1)<br>  fffff802<code>3fb50f8b 488908          mov     qword ptr [rax],rcx   fffff802</code>3fb50f8e 48894108        mov     qword ptr [rcx+8],rax</p>
<p>  nt!CcSetFileSizesEx+0x45f:<br>  fffff802<code>3fb51092 0f82562c0f00    jb      nt! ?? ::FNODOBFM::</code>string’+0x2693 (fffff802<code>3fc43cee)   fffff802</code>3fb51098 0fbae018        bt      eax,18h<br>  fffff802<code>3fb5109c 0f824c2c0f00    jb      nt! ?? ::FNODOBFM::</code>string’+0x2693 (fffff802<code>3fc43cee)   fffff802</code>3fb510a2 4881c688000000  add     rsi,88h<br>  fffff802<code>3fb510a9 488b0e          mov     rcx,qword ptr [rsi]   fffff802</code>3fb510ac 488b4608        mov     rax,qword ptr [rsi+8]<br>  fffff802<code>3fb510b0 48397108        cmp     qword ptr [rcx+8],rsi   fffff802</code>3fb510b4 7554            jne     nt!CcSetFileSizesEx+0x4d7 (fffff802<code>3fb5110a)   nt!CcSetFileSizesEx+0x483:   fffff802</code>3fb510b6 483930          cmp     qword ptr [rax],rsi<br>  fffff802<code>3fb510b9 754f            jne     nt!CcSetFileSizesEx+0x4d7 (fffff802</code>3fb5110a)<br>  fffff802<code>3fb510bb 488908          mov     qword ptr [rax],rcx   fffff802</code>3fb510be 48894108        mov     qword ptr [rcx+8],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  两处</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CmShutdownSystem</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!CmShutdownSystem+0x2b0:<br>  fffff802<code>3ffa96b8 488b0e          mov     rcx,qword ptr [rsi]   fffff802</code>3ffa96bb 488b4608        mov     rax,qword ptr [rsi+8]<br>  fffff802<code>3ffa96bf 48397108        cmp     qword ptr [rcx+8],rsi   fffff802</code>3ffa96c3 0f8511020000    jne     nt!CmShutdownSystem+0x4d2 (fffff802<code>3ffa98da)   fffff802</code>3ffa96c9 483930          cmp     qword ptr [rax],rsi<br>  fffff802<code>3ffa96cc 0f8508020000    jne     nt!CmShutdownSystem+0x4d2 (fffff802</code>3ffa98da)<br>  fffff802<code>3ffa96d2 488908          mov     qword ptr [rax],rcx   fffff802</code>3ffa96d5 48894108        mov     qword ptr [rcx+8],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CmUnRegisterCallback</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!CmUnRegisterCallback+0x14a:<br>  fffff802<code>3ff86aee 44899c24d0000000 mov     dword ptr [rsp+0D0h],r11d   fffff802</code>3ff86af6 4439a424d0000000 cmp     dword ptr [rsp+0D0h],r12d<br>  fffff802<code>3ff86afe 75c9            jne     nt!CmUnRegisterCallback+0x125 (fffff802</code>3ff86ac9)<br>  fffff802<code>3ff86b00 65488b042588010000 mov   rax,qword ptr gs:[188h]   fffff802</code>3ff86b09 664401a8e4010000 add     word ptr [rax+1E4h],r13w<br>  fffff802<code>3ff86b11 f0490fba2f00    lock bts qword ptr [r15],0   fffff802</code>3ff86b17 0f8237fcffff    jb      nt! ?? ::NNGAKEGL::<code>string&#39;+0x5966 (fffff802</code>3ff86754)<br>  fffff802<code>3ff86b1d 488b0f          mov     rcx,qword ptr [rdi]   nt!CmUnRegisterCallback+0x17c:   fffff802</code>3ff86b20 488b4708        mov     rax,qword ptr [rdi+8]<br>  fffff802<code>3ff86b24 48397908        cmp     qword ptr [rcx+8],rdi   fffff802</code>3ff86b28 0f856afcffff    jne     nt! ?? ::NNGAKEGL::<code>string&#39;+0x59aa (fffff802</code>3ff86798)<br>  fffff802<code>3ff86b2e 483938          cmp     qword ptr [rax],rdi   fffff802</code>3ff86b31 0f8561fcffff    jne     nt! ?? ::NNGAKEGL::<code>string&#39;+0x59aa (fffff802</code>3ff86798)<br>  fffff802<code>3ff86b37 488908          mov     qword ptr [rax],rcx   fffff802</code>3ff86b3a 48894108        mov     qword ptr [rcx+8],rax<br>  <figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">- CmpC<span class="literal">all</span>C<span class="literal">all</span>Backs</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!CmUnRegisterCallback+0x346:<br>  fffff802<code>3ff86cea 488b0f          mov     rcx,qword ptr [rdi]   fffff802</code>3ff86ced 488b4708        mov     rax,qword ptr [rdi+8]<br>  fffff802<code>3ff86cf1 48397908        cmp     qword ptr [rcx+8],rdi   fffff802</code>3ff86cf5 7578            jne     nt!CmUnRegisterCallback+0x3cb (fffff802<code>3ff86d6f)   fffff802</code>3ff86cf7 483938          cmp     qword ptr [rax],rdi<br>  fffff802<code>3ff86cfa 7573            jne     nt!CmUnRegisterCallback+0x3cb (fffff802</code>3ff86d6f)<br>  fffff802<code>3ff86cfc 488908          mov     qword ptr [rax],rcx   fffff802</code>3ff86cff 48894108        mov     qword ptr [rcx+8],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>CmpPostApc</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!CmpPostApc+0x114:<br>  fffff802<code>3fe2fcb8 488b10          mov     rdx,qword ptr [rax]   fffff802</code>3fe2fcbb 488b4808        mov     rcx,qword ptr [rax+8]<br>  fffff802<code>3fe2fcbf 48394208        cmp     qword ptr [rdx+8],rax   fffff802</code>3fe2fcc3 7570            jne     nt!CmpPostApc+0x191 (fffff802<code>3fe2fd35)   fffff802</code>3fe2fcc5 483901          cmp     qword ptr [rcx],rax<br>  fffff802<code>3fe2fcc8 756b            jne     nt!CmpPostApc+0x191 (fffff802</code>3fe2fd35)<br>  fffff802<code>3fe2fcca 488911          mov     qword ptr [rcx],rdx   fffff802</code>3fe2fccd 48894a08        mov     qword ptr [rdx+8],rcx</p>
<p>  nt!CmpPostApc+0x148:<br>  fffff802<code>3fe2fcec c3              ret   fffff802</code>3fe2fced 488b09          mov     rcx,qword ptr [rcx]<br>  fffff802<code>3fe2fcf0 4883e920        sub     rcx,20h   fffff802</code>3fe2fcf4 488d4120        lea     rax,[rcx+20h]<br>  fffff802<code>3fe2fcf8 4c8b00          mov     r8,qword ptr [rax]   fffff802</code>3fe2fcfb 488b5008        mov     rdx,qword ptr [rax+8]<br>  fffff802<code>3fe2fcff 49394008        cmp     qword ptr [r8+8],rax   fffff802</code>3fe2fd03 753e            jne     nt!CmpPostApc+0x19f (fffff802<code>3fe2fd43)   kd&gt;    nt!CmpPostApc+0x161:   fffff802</code>3fe2fd05 483902          cmp     qword ptr [rdx],rax<br>  fffff802<code>3fe2fd08 7539            jne     nt!CmpPostApc+0x19f (fffff802</code>3fe2fd43)<br>  fffff802<code>3fe2fd0a 4c8902          mov     qword ptr [rdx],r8   fffff802</code>3fe2fd0d 49895008        mov     qword ptr [r8+8],rdx<br>  fffff802<code>3fe2fd11 488d5110        lea     rdx,[rcx+10h]   fffff802</code>3fe2fd15 4c8b02          mov     r8,qword ptr [rdx]<br>  fffff802<code>3fe2fd18 488b4208        mov     rax,qword ptr [rdx+8]   fffff802</code>3fe2fd1c 49395008        cmp     qword ptr [r8+8],rdx<br>  nt!CmpPostApc+0x17c:<br>  fffff802<code>3fe2fd20 751a            jne     nt!CmpPostApc+0x198 (fffff802</code>3fe2fd3c)<br>  fffff802<code>3fe2fd22 483910          cmp     qword ptr [rax],rdx   fffff802</code>3fe2fd25 7515            jne     nt!CmpPostApc+0x198 (fffff802<code>3fe2fd3c)   fffff802</code>3fe2fd27 4c8900          mov     qword ptr [rax],r8<br>  fffff802<code>3fe2fd2a 49894008        mov     qword ptr [r8+8],rax   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  三处，第二段包含连续的两处</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>ExFreePoolWithTag</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!ExFreePoolWithTag+0x9ad:   fffff802</code>3fcea9bc 0f8559040000    jne     nt!ExFreePoolWithTag+0xe0c (fffff802<code>3fceae1b)   fffff802</code>3fcea9c2 3c01            cmp     al,1<br>  fffff802<code>3fcea9c4 7426            je      nt!ExFreePoolWithTag+0x9dd (fffff802</code>3fcea9ec)<br>  fffff802<code>3fcea9c6 4d8b4610        mov     r8,qword ptr [r14+10h]   fffff802</code>3fcea9ca 498b5618        mov     rdx,qword ptr [r14+18h]<br>  fffff802<code>3fcea9ce 498d4610        lea     rax,[r14+10h]   fffff802</code>3fcea9d2 49394008        cmp     qword ptr [r8+8],rax<br>  fffff802<code>3fcea9d6 0f85f8040000    jne     nt!ExFreePoolWithTag+0xec5 (fffff802</code>3fceaed4)<br>  nt!ExFreePoolWithTag+0x9cd:<br>  fffff802<code>3fcea9dc 483902          cmp     qword ptr [rdx],rax   fffff802</code>3fcea9df 0f85ef040000    jne     nt!ExFreePoolWithTag+0xec5 (fffff802<code>3fceaed4)   fffff802</code>3fcea9e5 4c8902          mov     qword ptr [rdx],r8<br>  fffff802<code>3fcea9e8 49895008        mov     qword ptr [r8+8],rdx   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>ExQueueWorkItem</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!ExQueueWorkItem+0x13a:   fffff802</code>3fb2f69a 0f8465010000    je      nt!ExQueueWorkItem+0x2a5 (fffff802<code>3fb2f805)   fffff802</code>3fb2f6a0 488b7310        mov     rsi,qword ptr [rbx+10h]<br>  fffff802<code>3fb2f6a4 488bd6          mov     rdx,rsi   fffff802</code>3fb2f6a7 488b7608        mov     rsi,qword ptr [rsi+8]<br>  fffff802<code>3fb2f6ab 4c8b02          mov     r8,qword ptr [rdx]   fffff802</code>3fb2f6ae 49395008        cmp     qword ptr [r8+8],rdx<br>  fffff802<code>3fb2f6b2 0f8524030000    jne     nt!ExQueueWorkItem+0x487 (fffff802</code>3fb2f9dc)<br>  fffff802<code>3fb2f6b8 483916          cmp     qword ptr [rsi],rdx   nt!ExQueueWorkItem+0x15b:   fffff802</code>3fb2f6bb 0f851b030000    jne     nt!ExQueueWorkItem+0x487 (fffff802<code>3fb2f9dc)   fffff802</code>3fb2f6c1 4c8906          mov     qword ptr [rsi],r8<br>  fffff802<code>3fb2f6c4 49897008        mov     qword ptr [r8+8],rsi   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>ExTimerRundown</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!ExTimerRundown+0x13d:   fffff802</code>3fadad61 488b10          mov     rdx,qword ptr [rax]<br>  fffff802<code>3fadad64 488b4808        mov     rcx,qword ptr [rax+8]   fffff802</code>3fadad68 48394208        cmp     qword ptr [rdx+8],rax<br>  fffff802<code>3fadad6c 0f8595041a00    jne     nt! ?? ::FNODOBFM::</code>string’+0x4e227 (fffff802<code>3fc7b207)   fffff802</code>3fadad72 483901          cmp     qword ptr [rcx],rax<br>  fffff802<code>3fadad75 0f858c041a00    jne     nt! ?? ::FNODOBFM::</code>string’+0x4e227 (fffff802<code>3fc7b207)   fffff802</code>3fadad7b 488911          mov     qword ptr [rcx],rdx<br>  fffff802<code>3fadad7e 48894a08        mov     qword ptr [rdx+8],rcx   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>ExpDeleteTImer</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!ExpDeleteTimer+0x9c:   fffff802</code>3faca6d8 440f20c5        mov     rbp,cr8<br>  fffff802<code>3faca6dc 450f22c4        mov     cr8,r12   fffff802</code>3faca6e0 f7059a79300000002100 test dword ptr [nt!PerfGlobalGroupMask+0x4 (fffff802<code>3fdd2084)],210000h   fffff802</code>3faca6ea 0f85000a1b00    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x4e0a2 (fffff802</code>3fc7b0f0)<br>  fffff802<code>3faca6f0 f0480fba2b00    lock bts qword ptr [rbx],0   fffff802</code>3faca6f6 0f82020a1b00    jb      nt! ?? ::FNODOBFM::<code>string&#39;+0x4e0b0 (fffff802</code>3fc7b0fe)<br>  fffff802<code>3faca6fc 488b0f          mov     rcx,qword ptr [rdi]   fffff802</code>3faca6ff 488b4708        mov     rax,qword ptr [rdi+8]<br>  nt!ExpDeleteTimer+0xc7:<br>  fffff802<code>3faca703 48397908        cmp     qword ptr [rcx+8],rdi   fffff802</code>3faca707 0f85120a1b00    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x4e0d1 (fffff802</code>3fc7b11f)<br>  fffff802<code>3faca70d 483938          cmp     qword ptr [rax],rdi   fffff802</code>3faca710 0f85090a1b00    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x4e0d1 (fffff802</code>3fc7b11f)<br>  fffff802<code>3faca716 488908          mov     qword ptr [rax],rcx   fffff802</code>3faca719 48894108        mov     qword ptr [rcx+8],rax</p>
<p>  nt!ExpDeleteTimer+0x11d:<br>  fffff802<code>3faca759 f0480fba2dbd0a240000 lock bts qword ptr [nt!ExpWakeTimerLock (fffff802</code>3fd0b220)],0<br>  fffff802<code>3faca763 7266            jb      nt!ExpDeleteTimer+0x18f (fffff802</code>3faca7cb)<br>  fffff802<code>3faca765 498b16          mov     rdx,qword ptr [r14]   fffff802</code>3faca768 498b4608        mov     rax,qword ptr [r14+8]<br>  fffff802<code>3faca76c 4c397208        cmp     qword ptr [rdx+8],r14   fffff802</code>3faca770 7567            jne     nt!ExpDeleteTimer+0x19d (fffff802<code>3faca7d9)   fffff802</code>3faca772 4c3930          cmp     qword ptr [rax],r14<br>  fffff802<code>3faca775 7562            jne     nt!ExpDeleteTimer+0x19d (fffff802</code>3faca7d9)<br>  nt!ExpDeleteTimer+0x13b:<br>  fffff802<code>3faca777 488910          mov     qword ptr [rax],rdx   fffff802</code>3faca77a 48894208        mov     qword ptr [rdx+8],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>ExpSetTimer</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>IoDeleteDevice</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>IoUnregisterFsRegistrationChange</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>IopfCompleteRequest</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!IopfCompleteRequest+0x348:<br>  fffff802<code>3fb2e058 0f82650f0000    jb      nt!IopfCompleteRequest+0x12c3 (fffff802</code>3fb2efc3)<br>  fffff802<code>3fb2e05e 0fb64311        movzx   eax,byte ptr [rbx+11h]   fffff802</code>3fb2e062 3c02            cmp     al,2<br>  fffff802<code>3fb2e064 7521            jne     nt!IopfCompleteRequest+0x377 (fffff802</code>3fb2e087)<br>  fffff802<code>3fb2e066 488b0b          mov     rcx,qword ptr [rbx]   fffff802</code>3fb2e069 488b4308        mov     rax,qword ptr [rbx+8]<br>  fffff802<code>3fb2e06d 48395908        cmp     qword ptr [rcx+8],rbx   fffff802</code>3fb2e071 0f851e100000    jne     nt!IopfCompleteRequest+0x1399 (fffff802<code>3fb2f095)   nt!IopfCompleteRequest+0x367:   fffff802</code>3fb2e077 483918          cmp     qword ptr [rax],rbx<br>  fffff802<code>3fb2e07a 0f8515100000    jne     nt!IopfCompleteRequest+0x1399 (fffff802</code>3fb2f095)<br>  fffff802<code>3fb2e080 488908          mov     qword ptr [rax],rcx   fffff802</code>3fb2e083 48894108        mov     qword ptr [rcx+8],rax</p>
<p>  nt!IopfCompleteRequest+0x758:<br>  fffff802<code>3fb2e468 483bc7          cmp     rax,rdi   fffff802</code>3fb2e46b 0f848b030000    je      nt!IopfCompleteRequest+0xaea (fffff802<code>3fb2e7fc)   fffff802</code>3fb2e471 4c8b4710        mov     r8,qword ptr [rdi+10h]<br>  fffff802<code>3fb2e475 498b10          mov     rdx,qword ptr [r8]   fffff802</code>3fb2e478 498b4808        mov     rcx,qword ptr [r8+8]<br>  fffff802<code>3fb2e47c 4d8be0          mov     r12,r8   fffff802</code>3fb2e47f 48894dd7        mov     qword ptr [rbp-29h],rcx<br>  fffff802<code>3fb2e483 4c394208        cmp     qword ptr [rdx+8],r8   nt!IopfCompleteRequest+0x777:   fffff802</code>3fb2e487 0f859f070000    jne     nt!IopfCompleteRequest+0xf35 (fffff802<code>3fb2ec2c)   fffff802</code>3fb2e48d 4c3901          cmp     qword ptr [rcx],r8<br>  fffff802<code>3fb2e490 0f8596070000    jne     nt!IopfCompleteRequest+0xf35 (fffff802</code>3fb2ec2c)<br>  fffff802<code>3fb2e496 488911          mov     qword ptr [rcx],rdx   fffff802</code>3fb2e499 4532f6          xor     r14b,r14b<br>  fffff802`3fb2e49c 48894a08        mov     qword ptr [rdx+8],rcx</p>
<p>  nt!IopfCompleteRequest+0x80c:<br>  fffff802<code>3fb2e51c 4885c0          test    rax,rax   fffff802</code>3fb2e51f 7433            je      nt!IopfCompleteRequest+0x844 (fffff802<code>3fb2e554)   fffff802</code>3fb2e521 488d86d8000000  lea     rax,[rsi+0D8h]<br>  fffff802<code>3fb2e528 488b10          mov     rdx,qword ptr [rax]   fffff802</code>3fb2e52b 488b4808        mov     rcx,qword ptr [rax+8]<br>  fffff802<code>3fb2e52f 48394208        cmp     qword ptr [rdx+8],rax   fffff802</code>3fb2e533 0f858c080000    jne     nt!IopfCompleteRequest+0x10cd (fffff802<code>3fb2edc5)   fffff802</code>3fb2e539 483901          cmp     qword ptr [rcx],rax<br>  nt!IopfCompleteRequest+0x82c:<br>  fffff802<code>3fb2e53c 0f8583080000    jne     nt!IopfCompleteRequest+0x10cd (fffff802</code>3fb2edc5)<br>  fffff802<code>3fb2e542 488911          mov     qword ptr [rcx],rdx   fffff802</code>3fb2e545 48894a08        mov     qword ptr [rdx+8],rcx<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  三处</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KeDeregisterBugCheckCallback</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!KeDeregisterBugCheckCallback+0x4c:<br>  fffff802<code>3fbf0ee0 e80b57efff      call    nt!KxWaitForSpinLockAndAcquire (fffff802</code>3fae65f0)<br>  fffff802<code>3fbf0ee5 4032ff          xor     dil,dil   fffff802</code>3fbf0ee8 807b3801        cmp     byte ptr [rbx+38h],1<br>  fffff802<code>3fbf0eec 7520            jne     nt!KeDeregisterBugCheckCallback+0x7a (fffff802</code>3fbf0f0e)<br>  fffff802<code>3fbf0eee 488b0b          mov     rcx,qword ptr [rbx]   fffff802</code>3fbf0ef1 488b4308        mov     rax,qword ptr [rbx+8]<br>  fffff802<code>3fbf0ef5 40887b38        mov     byte ptr [rbx+38h],dil   fffff802</code>3fbf0ef9 48395908        cmp     qword ptr [rcx+8],rbx<br>  nt!KeDeregisterBugCheckCallback+0x69:<br>  fffff802<code>3fbf0efd 752e            jne     nt!KeDeregisterBugCheckCallback+0x99 (fffff802</code>3fbf0f2d)<br>  fffff802<code>3fbf0eff 483918          cmp     qword ptr [rax],rbx   fffff802</code>3fbf0f02 7529            jne     nt!KeDeregisterBugCheckCallback+0x99 (fffff802<code>3fbf0f2d)   fffff802</code>3fbf0f04 488908          mov     qword ptr [rax],rcx<br>  fffff802<code>3fbf0f07 40b701          mov     dil,1   fffff802</code>3fbf0f0a 48894108        mov     qword ptr [rcx+8],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KeDeregisterObjectNotification</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!KeDeregisterObjectNotification+0x39:<br>  fffff802<code>3fad4c49 8a4711          mov     al,byte ptr [rdi+11h]   fffff802</code>3fad4c4c 413ac7          cmp     al,r15b<br>  fffff802<code>3fad4c4f 7520            jne     nt!KeDeregisterObjectNotification+0x61 (fffff802</code>3fad4c71)<br>  fffff802<code>3fad4c51 488b0f          mov     rcx,qword ptr [rdi]   fffff802</code>3fad4c54 488b4708        mov     rax,qword ptr [rdi+8]<br>  fffff802<code>3fad4c58 48397908        cmp     qword ptr [rcx+8],rdi   fffff802</code>3fad4c5c 7545            jne     nt!KeDeregisterObjectNotification+0x93 (fffff802<code>3fad4ca3)   fffff802</code>3fad4c5e 483938          cmp     qword ptr [rax],rdi<br>  nt!KeDeregisterObjectNotification+0x51:<br>  fffff802<code>3fad4c61 7540            jne     nt!KeDeregisterObjectNotification+0x93 (fffff802</code>3fad4ca3)<br>  fffff802<code>3fad4c63 488908          mov     qword ptr [rax],rcx   fffff802</code>3fad4c66 48894108        mov     qword ptr [rcx+8],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KeRegisterObjectNotification</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!KeRegisterObjectNotification+0x119:<br>  fffff802<code>3fae3815 483bc7          cmp     rax,rdi   fffff802</code>3fae3818 750a            jne     nt!KeRegisterObjectNotification+0x128 (fffff802<code>3fae3824)   fffff802</code>3fae381a 4180bf830200000f cmp     byte ptr [r15+283h],0Fh<br>  fffff802<code>3fae3822 7470            je      nt!KeRegisterObjectNotification+0x198 (fffff802</code>3fae3894)<br>  fffff802<code>3fae3824 4c8b7710        mov     r14,qword ptr [rdi+10h]   fffff802</code>3fae3828 498bd6          mov     rdx,r14<br>  fffff802<code>3fae382b 4d8b7608        mov     r14,qword ptr [r14+8]   fffff802</code>3fae382f 4c8b02          mov     r8,qword ptr [rdx]<br>  nt!KeRegisterObjectNotification+0x136:<br>  fffff802<code>3fae3832 49395008        cmp     qword ptr [r8+8],rdx   fffff802</code>3fae3836 0f85d4000000    jne     nt!KeRegisterObjectNotification+0x214 (fffff802<code>3fae3910)   fffff802</code>3fae383c 493916          cmp     qword ptr [r14],rdx<br>  fffff802<code>3fae383f 0f85cb000000    jne     nt!KeRegisterObjectNotification+0x214 (fffff802</code>3fae3910)<br>  fffff802<code>3fae3845 4d8906          mov     qword ptr [r14],r8   fffff802</code>3fae3848 4d897008        mov     qword ptr [r8+8],r14<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KeRemoveQueueApc</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!KeRemoveQueueApc+0x63:<br>  fffff802<code>3fad62a3 5f              pop     rdi   fffff802</code>3fad62a4 c3              ret<br>  fffff802<code>3fad62a5 480fbe4650      movsx   rax,byte ptr [rsi+50h]   fffff802</code>3fad62aa c6465200        mov     byte ptr [rsi+52h],0<br>  fffff802<code>3fad62ae 4c8d4e10        lea     r9,[rsi+10h]   fffff802</code>3fad62b2 498b09          mov     rcx,qword ptr [r9]<br>  fffff802<code>3fad62b5 4c8b84c748020000 mov     r8,qword ptr [rdi+rax*8+248h]   fffff802</code>3fad62bd 498b4108        mov     rax,qword ptr [r9+8]<br>  kd&gt;<br>  nt!KeRemoveQueueApc+0x81:<br>  fffff802<code>3fad62c1 4c394908        cmp     qword ptr [rcx+8],r9   fffff802</code>3fad62c5 7529            jne     nt!KeRemoveQueueApc+0xb0 (fffff802<code>3fad62f0)   fffff802</code>3fad62c7 4c3908          cmp     qword ptr [rax],r9<br>  fffff802<code>3fad62ca 7524            jne     nt!KeRemoveQueueApc+0xb0 (fffff802</code>3fad62f0)<br>  fffff802<code>3fad62cc 488908          mov     qword ptr [rax],rcx   fffff802</code>3fad62cf 48894108        mov     qword ptr [rcx+8],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KeRemoveQueueDpc</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KiCancelTimer</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!KiCancelTimer+0xbf:<br>  fffff802<code>3fb2280f f0480fba2e00    lock bts qword ptr [rsi],0   fffff802</code>3fb22815 0f820f010000    jb      nt!KiCancelTimer+0x1e0 (fffff802<code>3fb2292a)   fffff802</code>3fb2281b 0fb64303        movzx   eax,byte ptr [rbx+3]<br>  fffff802<code>3fb2281f 84c0            test    al,al   fffff802</code>3fb22821 0f88b5000000    js      nt!KiCancelTimer+0x18c (fffff802<code>3fb228dc)   fffff802</code>3fb22827 488b4b20        mov     rcx,qword ptr [rbx+20h]<br>  fffff802<code>3fb2282b 488b4328        mov     rax,qword ptr [rbx+28h]   fffff802</code>3fb2282f 488d5320        lea     rdx,[rbx+20h]<br>  nt!KiCancelTimer+0xe3:<br>  fffff802<code>3fb22833 4d8d4710        lea     r8,[r15+10h]   fffff802</code>3fb22837 4d8bcf          mov     r9,r15<br>  fffff802<code>3fb2283a 49c1e005        shl     r8,5   fffff802</code>3fb2283e 48395108        cmp     qword ptr [rcx+8],rdx<br>  fffff802<code>3fb22842 0f858d000000    jne     nt!KiCancelTimer+0x185 (fffff802</code>3fb228d5)<br>  fffff802<code>3fb22848 483910          cmp     qword ptr [rax],rdx   fffff802</code>3fb2284b 0f8584000000    jne     nt!KiCancelTimer+0x185 (fffff802<code>3fb228d5)   fffff802</code>3fb22851 488908          mov     qword ptr [rax],rcx<br>  nt!KiCancelTimer+0x104:<br>  fffff802<code>3fb22854 48894108        mov     qword ptr [rcx+8],rax   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KeTerminateThread</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!KeTerminateThread+0x93:   fffff802</code>3fada337 4c8da3f8020000  lea     r12,[rbx+2F8h]<br>  fffff802<code>3fada33e 49390424        cmp     qword ptr [r12],rax   fffff802</code>3fada342 0f841b010000    je      nt!KeTerminateThread+0x1bf (fffff802<code>3fada463)   fffff802</code>3fada348 8bf7            mov     esi,edi<br>  fffff802<code>3fada34a f0410fba2f07    lock bts dword ptr [r15],7   fffff802</code>3fada350 0f82d7adfaff    jb      nt! ?? ::FNODOBFM::<code>string&#39;+0xd7d3 (fffff802</code>3fa8512d)<br>  fffff802<code>3fada356 498b0c24        mov     rcx,qword ptr [r12]   fffff802</code>3fada35a 498b442408      mov     rax,qword ptr [r12+8]<br>  nt!KeTerminateThread+0xbb:<br>  fffff802<code>3fada35f 4c396108        cmp     qword ptr [rcx+8],r12   fffff802</code>3fada363 0f853c020000    jne     nt!KeTerminateThread+0x301 (fffff802<code>3fada5a5)   fffff802</code>3fada369 4c3920          cmp     qword ptr [rax],r12<br>  fffff802<code>3fada36c 0f8533020000    jne     nt!KeTerminateThread+0x301 (fffff802</code>3fada5a5)<br>  fffff802<code>3fada372 488908          mov     qword ptr [rax],rcx   fffff802</code>3fada375 41bc7fffffff    mov     r12d,0FFFFFF7Fh<br>  fffff802`3fada37b 48894108        mov     qword ptr [rcx+8],rax</p>
<p>  nt!KeTerminateThread+0x1f2:<br>  fffff802<code>3fada496 498d8738020000  lea     rax,[r15+238h]   fffff802</code>3fada49d 488b10          mov     rdx,qword ptr [rax]<br>  fffff802<code>3fada4a0 488b4808        mov     rcx,qword ptr [rax+8]   fffff802</code>3fada4a4 48394208        cmp     qword ptr [rdx+8],rax<br>  fffff802<code>3fada4a8 0f8578acfaff    jne     nt! ?? ::FNODOBFM::</code>string’+0xd7cc (fffff802<code>3fa85126)   fffff802</code>3fada4ae 483901          cmp     qword ptr [rcx],rax<br>  fffff802<code>3fada4b1 0f856facfaff    jne     nt! ?? ::FNODOBFM::</code>string’+0xd7cc (fffff802<code>3fa85126)   fffff802</code>3fada4b7 488911          mov     qword ptr [rcx],rdx<br>  nt!KeTerminateThread+0x216:<br>  fffff802<code>3fada4ba 48894a08        mov     qword ptr [rdx+8],rcx   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KiDeliverApc</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!KiDeliverApc+0x10c:   fffff802</code>3fb58e3c 7556            jne     nt!KiDeliverApc+0x164 (fffff802<code>3fb58e94)   fffff802</code>3fb58e3e 488b0a          mov     rcx,qword ptr [rdx]<br>  fffff802<code>3fb58e41 488b4208        mov     rax,qword ptr [rdx+8]   fffff802</code>3fb58e45 48395108        cmp     qword ptr [rcx+8],rdx<br>  fffff802<code>3fb58e49 0f854a020000    jne     nt!KiDeliverApc+0x36e (fffff802</code>3fb59099)<br>  fffff802<code>3fb58e4f 483910          cmp     qword ptr [rax],rdx   fffff802</code>3fb58e52 0f8541020000    jne     nt!KiDeliverApc+0x36e (fffff802<code>3fb59099)   fffff802</code>3fb58e58 488908          mov     qword ptr [rax],rcx<br>  nt!KiDeliverApc+0x12b:<br>  fffff802`3fb58e5b 48894108        mov     qword ptr [rcx+8],rax</p>
<p>  nt!KiDeliverApc+0x171:<br>  fffff802<code>3fb58ea1 6683bbe401000000 cmp     word ptr [rbx+1E4h],0   fffff802</code>3fb58ea9 0f8586010000    jne     nt!KiDeliverApc+0x303 (fffff802<code>3fb59035)   fffff802</code>3fb58eaf 488b0a          mov     rcx,qword ptr [rdx]<br>  fffff802<code>3fb58eb2 488b4208        mov     rax,qword ptr [rdx+8]   fffff802</code>3fb58eb6 48395108        cmp     qword ptr [rcx+8],rdx<br>  fffff802<code>3fb58eba 0f85cb010000    jne     nt!KiDeliverApc+0x360 (fffff802</code>3fb5908b)<br>  fffff802<code>3fb58ec0 483910          cmp     qword ptr [rax],rdx   fffff802</code>3fb58ec3 0f85c2010000    jne     nt!KiDeliverApc+0x360 (fffff802<code>3fb5908b)   nt!KiDeliverApc+0x199:   fffff802</code>3fb58ec9 488908          mov     qword ptr [rax],rcx<br>  fffff802`3fb58ecc 48894108        mov     qword ptr [rcx+8],rax</p>
<p>  nt!KiDeliverApc+0x266:<br>  fffff802<code>3fb58f98 488b4128        mov     rax,qword ptr [rcx+28h]   fffff802</code>3fb58f9c 488945f0        mov     qword ptr [rbp-10h],rax<br>  fffff802<code>3fb58fa0 488b4130        mov     rax,qword ptr [rcx+30h]   fffff802</code>3fb58fa4 488945e8        mov     qword ptr [rbp-18h],rax<br>  fffff802<code>3fb58fa8 488b4138        mov     rax,qword ptr [rcx+38h]   fffff802</code>3fb58fac 48894550        mov     qword ptr [rbp+50h],rax<br>  fffff802<code>3fb58fb0 488b11          mov     rdx,qword ptr [rcx]   fffff802</code>3fb58fb3 488b4108        mov     rax,qword ptr [rcx+8]<br>  nt!KiDeliverApc+0x285:<br>  fffff802<code>3fb58fb7 48394a08        cmp     qword ptr [rdx+8],rcx   fffff802</code>3fb58fbb 0f85d1000000    jne     nt!KiDeliverApc+0x367 (fffff802<code>3fb59092)   fffff802</code>3fb58fc1 483908          cmp     qword ptr [rax],rcx<br>  fffff802<code>3fb58fc4 0f85c8000000    jne     nt!KiDeliverApc+0x367 (fffff802</code>3fb59092)<br>  fffff802<code>3fb58fca 488910          mov     qword ptr [rax],rdx   fffff802</code>3fb58fcd 48894208        mov     qword ptr [rdx+8],rax<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KiExecuteAllDpcs</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!KiExecuteAllDpcs+0xa9:<br>  fffff802<code>3faed3a9 83f801          cmp     eax,1   fffff802</code>3faed3ac 7f15            jg      nt!KiExecuteAllDpcs+0xc3 (fffff802<code>3faed3c3)   fffff802</code>3faed3ae 66f04321946fdc2d0000 lock and word ptr [r15+r13*2+2DDCh],dx<br>  fffff802<code>3faed3b8 8b4318          mov     eax,dword ptr [rbx+18h]   fffff802</code>3faed3bb 85c0            test    eax,eax<br>  fffff802<code>3faed3bd 0f84d619fbff    je      nt! ?? ::FNODOBFM::</code>string’+0x14ab8 (fffff802<code>3fa9ed99)   fffff802</code>3faed3c3 488b11          mov     rdx,qword ptr [rcx]<br>  fffff802<code>3faed3c6 488b4108        mov     rax,qword ptr [rcx+8]   nt!KiExecuteAllDpcs+0xca:   fffff802</code>3faed3ca 48394a08        cmp     qword ptr [rdx+8],rcx<br>  fffff802<code>3faed3ce 0f85d9020000    jne     nt!KiExecuteAllDpcs+0x3ad (fffff802</code>3faed6ad)<br>  fffff802<code>3faed3d4 483908          cmp     qword ptr [rax],rcx   fffff802</code>3faed3d7 0f85d0020000    jne     nt!KiExecuteAllDpcs+0x3ad (fffff802<code>3faed6ad)   fffff802</code>3faed3dd 488910          mov     qword ptr [rax],rdx<br>  fffff802<code>3faed3e0 48894208        mov     qword ptr [rdx+8],rax   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KiExpireTimerTable</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KiFindReadyThread</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!KiFindReadyThread+0x5e:   fffff802</code>3fa9f32e 488b8760060000  mov     rax,qword ptr [rdi+660h]<br>  fffff802<code>3fa9f335 49858238020000  test    qword ptr [r10+238h],rax   fffff802</code>3fa9f33c 744f            je      nt!KiFindReadyThread+0xbd (fffff802<code>3fa9f38d)   fffff802</code>3fa9f33e 4c8b01          mov     r8,qword ptr [rcx]<br>  fffff802<code>3fa9f341 488b5108        mov     rdx,qword ptr [rcx+8]   fffff802</code>3fa9f345 49394808        cmp     qword ptr [r8+8],rcx<br>  fffff802<code>3fa9f349 7568            jne     nt!KiFindReadyThread+0xe3 (fffff802</code>3fa9f3b3)<br>  fffff802<code>3fa9f34b 48390a          cmp     qword ptr [rdx],rcx   nt!KiFindReadyThread+0x7e:   fffff802</code>3fa9f34e 7563            jne     nt!KiFindReadyThread+0xe3 (fffff802<code>3fa9f3b3)   fffff802</code>3fa9f350 4c8902          mov     qword ptr [rdx],r8<br>  fffff802<code>3fa9f353 49895008        mov     qword ptr [r8+8],rdx   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KiFlushQueueApc</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KiInsertTimerTable</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>KiProcessExpiredTimerList</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!KiProcessExpiredTimerList+0x338:   fffff802</code>3fb239d8 7521            jne     nt!KiProcessExpiredTimerList+0x35b (fffff802<code>3fb239fb)   fffff802</code>3fb239da 488b0b          mov     rcx,qword ptr [rbx]<br>  fffff802<code>3fb239dd 488b4308        mov     rax,qword ptr [rbx+8]   fffff802</code>3fb239e1 48395908        cmp     qword ptr [rcx+8],rbx<br>  fffff802<code>3fb239e5 0f85c3010000    jne     nt!KiProcessExpiredTimerList+0x50e (fffff802</code>3fb23bae)<br>  fffff802<code>3fb239eb 483918          cmp     qword ptr [rax],rbx   fffff802</code>3fb239ee 0f85ba010000    jne     nt!KiProcessExpiredTimerList+0x50e (fffff802<code>3fb23bae)   fffff802</code>3fb239f4 488908          mov     qword ptr [rax],rcx<br>  nt!KiProcessExpiredTimerList+0x357:<br>  fffff802`3fb239f7 48894108        mov     qword ptr [rcx+8],rax</p>
<p>  nt!KiProcessExpiredTimerList+0x3f3:<br>  fffff802<code>3fb23a93 488b7320        mov     rsi,qword ptr [rbx+20h]   fffff802</code>3fb23a97 4533e4          xor     r12d,r12d<br>  fffff802<code>3fb23a9a f00fba2e07      lock bts dword ptr [rsi],7   fffff802</code>3fb23a9f 0f823d010000    jb      nt!KiProcessExpiredTimerList+0x550 (fffff802<code>3fb23be2)   fffff802</code>3fb23aa5 0fb64311        movzx   eax,byte ptr [rbx+11h]<br>  fffff802<code>3fb23aa9 3c02            cmp     al,2   fffff802</code>3fb23aab 7525            jne     nt!KiProcessExpiredTimerList+0x432 (fffff802<code>3fb23ad2)   fffff802</code>3fb23aad 488b0b          mov     rcx,qword ptr [rbx]<br>  nt!KiProcessExpiredTimerList+0x410:<br>  fffff802<code>3fb23ab0 488b4308        mov     rax,qword ptr [rbx+8]   fffff802</code>3fb23ab4 48395908        cmp     qword ptr [rcx+8],rbx<br>  fffff802<code>3fb23ab8 0f854c010000    jne     nt!KiProcessExpiredTimerList+0x578 (fffff802</code>3fb23c0a)<br>  fffff802<code>3fb23abe 483918          cmp     qword ptr [rax],rbx   fffff802</code>3fb23ac1 0f8543010000    jne     nt!KiProcessExpiredTimerList+0x578 (fffff802<code>3fb23c0a)   fffff802</code>3fb23ac7 488908          mov     qword ptr [rax],rcx<br>  fffff802<code>3fb23aca 48894108        mov     qword ptr [rcx+8],rax   <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">  </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>MiDeleteVIrtualAddresses</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!MiDeleteVirtualAddresses+0x8f6:   fffff802</code>3fb3bde6 0f85f3030000    jne     nt!MiDeleteVirtualAddresses+0xcf4 (fffff802<code>3fb3c1df)   fffff802</code>3fb3bdec 803d42a1200000  cmp     byte ptr [nt!MiWsData+0x35 (fffff802<code>3fd45f35)],0   fffff802</code>3fb3bdf3 0f859a030000    jne     nt!MiDeleteVirtualAddresses+0xca8 (fffff802<code>3fb3c193)   fffff802</code>3fb3bdf9 49833c2400      cmp     qword ptr [r12],0<br>  fffff802<code>3fb3bdfe 0f848f030000    je      nt!MiDeleteVirtualAddresses+0xca8 (fffff802</code>3fb3c193)<br>  fffff802<code>3fb3be04 498b0c24        mov     rcx,qword ptr [r12]   fffff802</code>3fb3be08 498b442408      mov     rax,qword ptr [r12+8]<br>  fffff802<code>3fb3be0d 4c396108        cmp     qword ptr [rcx+8],r12   nt!MiDeleteVirtualAddresses+0x921:   fffff802</code>3fb3be11 0f85e9bc1200    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x36698 (fffff802</code>3fc67b00)<br>  fffff802<code>3fb3be17 4c3920          cmp     qword ptr [rax],r12   fffff802</code>3fb3be1a 0f85e0bc1200    jne     nt! ?? ::FNODOBFM::<code>string&#39;+0x36698 (fffff802</code>3fc67b00)<br>  fffff802<code>3fb3be20 488908          mov     qword ptr [rax],rcx   fffff802</code>3fb3be23 48894108        mov     qword ptr [rcx+8],rax<br>  <figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">- NtNotifyChangeMultipleKeys</span><br><span class="line"></span><br><span class="line">- ObRegisterCallbacks</span><br><span class="line"></span><br><span class="line">- ObUnRegisterCallbacks</span><br><span class="line"></span><br><span class="line">#### 小总结<span class="number">3</span></span><br><span class="line"></span><br><span class="line">RemoveEntryList 需要获取 Entry 的 Flink 和 Blink，而且最后 Flink 和 Blink 会连接到一起，特征：</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>mov        rcx, [r12]<br>mov        rax, [r12+8]</p>
<p>; 同以上小总结<br>cmp<br>jne<br>cmp<br>jne</p>
<p>; 连接 Flink 和 Blink<br>mov        [rax], rcx<br>mov        [rcx+8], rax</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### <span class="number">7</span> --</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### <span class="number">8</span></span><br><span class="line"></span><br><span class="line">结构是 cmp 然后 jne 到一个位置，Insert 时会出现一次，Remove 时出现两次，这个位置的内容是</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>mov        ecx, 3<br>int        29h</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">除此之外，mov 密集出现且两个操作数中一个是 [reg] 或 [reg+<span class="number">8</span>] 而另一个是 reg 的情况是链表操作的可能性较大。</span><br><span class="line"></span><br><span class="line">出现 cmp jne 的原因：</span><br><span class="line"></span><br><span class="line">InsertHeadList 中，检查的是 Flink 的 Blink 是否是 ListHead；InsertTailList 检查 Blink 的 Flink 是否是 ListhHead。</span><br><span class="line"></span><br><span class="line">R<span class="function"><span class="title">emoveHeadList</span> 中，检查 Entry-&gt;</span>B<span class="function"><span class="title">link</span> 是否是 ListHead 以及 Flink-&gt;</span>B<span class="function"><span class="title">link</span> 是否是 Entry；RemoveTailList 中，检查 Entry-&gt;</span>F<span class="function"><span class="title">link</span> 是否是 ListHead 以及 Blink-&gt;</span>Flink 是否是 Entry。</span><br><span class="line"></span><br><span class="line">R<span class="function"><span class="title">emoveEntryList</span> 中，检查 Flink-&gt;</span>B<span class="function"><span class="title">link</span> 是否是 Entry 以及 Blink-&gt;</span>Flink 是否是 Entry。</span><br><span class="line"></span><br><span class="line">观察之后，可以发现检查的是：从与获取相反的方向能否验证获取的结果。以 R<span class="function"><span class="title">emoveHeadList</span> 为例，它通过 ListHead-&gt;</span>F<span class="function"><span class="title">link</span> 获取 Entry，然后通过 Entry-&gt;</span>F<span class="function"><span class="title">link</span> 获取 Flink。所以检查的就是 Flink 的Blink 是否是 Entry 以及 Entry-&gt;</span>Blink 是否是 ListHead。正常情况下这些检查应该总是满足的，但是在链表损坏时就可能不满足这样的条件。当链表损坏时，会进行``mov ecx,<span class="number">3</span>``和``int <span class="number">29</span>h``。</span><br><span class="line"></span><br><span class="line">查询发现 int <span class="number">29</span>h 的描述，[__fastfail](https:<span class="comment">//learn.microsoft.com/en-us/cpp/intrinsics/fastfail?view=msvc-170)。简单来说，这个函数会终结调用的进程，函数原型如下：</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>void __fastfail(Unsigned int code);</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">其中 <span class="meta">code</span> 是失败原因。在 x64 中，<span class="meta">code</span> 参数由 ecx 传递，因此这个函数在原因为 <span class="number">3</span> 时就会编译为：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>mov        ecx, 3<br>int        29h</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">然后我们查看这个原因 <span class="number">3</span> 是什么，文档中说明了这个原因在 winnt<span class="selector-class">.h</span> 或者 wdm<span class="selector-class">.h</span> 中，查看 wdm<span class="selector-class">.h</span> 可以发现：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>#define FAST_FAIL_CORRUPT_LIST_ENTRY           3</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">原因是链表损坏，和我们的推测一致。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 9 --</span></span><br><span class="line"></span><br><span class="line">先查文档，[AuxKlibQueryModuleInformation <span class="keyword">function</span> (aux_klib.h)](https:<span class="regexp">//</span>learn.microsoft.com<span class="regexp">/en-us/</span>windows-hardware<span class="regexp">/drivers/</span>ddi<span class="regexp">/aux_klib/</span>nf-aux_klib-auxklibquerymoduleinformation)，然后发现没这个符号，回头再说。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 10 --</span></span><br><span class="line"></span><br><span class="line">KeInsertQueueDpc</span><br><span class="line"></span><br><span class="line">KiRetireDpcList</span><br><span class="line"></span><br><span class="line">KiExecuteDpc</span><br><span class="line"></span><br><span class="line">KiExecuteAllDpcs</span><br><span class="line"></span><br><span class="line"><span class="comment">### 3.3.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 1</span></span><br><span class="line"></span><br><span class="line">&gt; 阅读某些在线论坛后，你注意到有些人认为 PsCreateSystemThread 会在调用进程的上下文中创建线程，也就是说他们认为如果在 IOCTL 处理程序中调用 PsCreateSystemThread 的话，新线程会运行在请求服务的用户模式应用程序上下文中。写一个在 IOCTL 处理函数中调用 PsCreateSystemThread 的驱动程序来验证这一点。然后，使用非 NULL 的 ProcessHandle，确定其上下文是否有改变。</span><br><span class="line"></span><br><span class="line">其实这个问题文档里已经说了。。[PsCreateSystemThread <span class="keyword">function</span> (wdm.h) - Windows drivers | Microsoft Learn](https:<span class="regexp">//</span>learn.microsoft.com<span class="regexp">/en-us/</span>windows-hardware<span class="regexp">/drivers/</span>ddi<span class="regexp">/wdm/</span>nf-wdm-pscreatesystemthread)</span><br><span class="line"></span><br><span class="line">不过还是写了一下，内容在 github 仓库里。</span><br><span class="line"></span><br><span class="line">在 Windbg 里可以看到输出（KdPrint）：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>3.3.1(1): DriverEntry<br>3.3.1(1): Run in the system process<br>3.3.1(1): Run in the current process<br>3.3.1(1): Process: FFFFBA0A21A840C0<br>3.3.1(1): Process: FFFFBA0A2C2F1080</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">可能是因为 PsCreateSystemThread 是异步的并且慢于 KdPrint，导致信息没有按顺序输出，不过也可以看出执行的线程属于两个不同的进程，使用``dt _EPROCESS &lt;addr&gt;``查看两个进程的 UniqueProcessId，可以发现第一个进程 PID 是 <span class="number">4</span>，也就是系统进程，而第二个进程是 <span class="number">16</span>d4。查看第二个进程的 PEB，确定确实是我们运行的 client 进程。或者使用``!process &lt;addr&gt;``直接可以看到映像名。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 2</span></span><br><span class="line"></span><br><span class="line">&gt; 尽可能多地阅读内核映像调用 PsCreateSystemThread 的部分，确定其中是否有传入 ProcessHandle 参数为非 NULL 值的情况。解释这些例程的目的，对尽可能多的函数重复这个练习。</span><br><span class="line"></span><br><span class="line">ProcessHandle 非 NULL 的原因是需要访问创建进程的地址空间，而且是用户地址空间。</span><br><span class="line"></span><br><span class="line">在 IDA 里加载 ntoskrnl.exe，然后找到 PsCreateSystemThread，x 一下就可以找到它的交叉引用，使用 IDAPython 可以筛选出调用时 r9 为 <span class="number">0</span> 即 ProcessHandle 为 null 的情况（来自[matteomalvica.com](https:<span class="regexp">//</span>www.matteomalvica.com<span class="regexp">/blog/</span><span class="number">2021</span><span class="regexp">/02/</span><span class="number">11</span><span class="regexp">/practical-re-win-solutions-ch3-system-threads/</span>)）：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ps1  = idc.get_name_ea_simple(“PsCreateSystemThread”)<br>ps2 = idc.get_name_ea_simple(“PsCreateSystemThreadEx”)</p>
<p>def filterXrf(targetFunction):<br>    for addr in CodeRefsTo(targetFunction, 0):<br>        funcName  = get_func_name(addr)<br>        func = ida_funcs.get_func(addr)<br>        funcStart = func.start_ea<br>        funcEnd = func.end_ea<br>        print(“Calling function: %s at 0x%x %s - function start 0x%x “ % (funcName,addr, idc.generate_disasm_line(addr, 0),funcStart))<br>        cur_addr  = addr</p>
<pre><code>    while(cur_addr &gt; funcStart):
        cur_asm = idc.generate_disasm_line(cur_addr, 0)
        if &quot;xor     r9d, r9d&quot; in cur_asm:
            break
        if &quot;r9&quot; in cur_asm:
            print(&quot;0x%x %s&quot; % (cur_addr, idc.generate_disasm_line(cur_addr, 0)))
            break
        cur_addr = idc.prev_head(cur_addr)
</code></pre>
<p>filterXrf(ps1)<br>filterXrf(ps2)</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">下条件断点：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>bp nt!PsCreateSystemThread “.if @r9 != 0x0  {.printf &quot;Found NON-NULL call to PsCreateSystemThread with Process Handle value of 0x%p \n&quot;,r9} .else {gc}”</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### <span class="number">3.3</span><span class="number">.2</span></span><br><span class="line"></span><br><span class="line">#### <span class="number">1</span></span><br><span class="line"></span><br><span class="line">&gt; 解释如何确定 ExpWorkerThread 是负责 work item  出队的系统进程。提示：最简单的方法就是写一个驱动程序。</span><br><span class="line"></span><br><span class="line">这里编程就是插入一个 WorkItem，在它执行的 Routine 里面查看调用者就可以。可以使用[Stack Trace](https:<span class="comment">//learn.microsoft.com/en-us/windows-hardware/drivers/debugger/examining-the-stack-trace)，不过我这里就直接触发一个断点（``DbgBreakPoint``），然后用 Windbg  k 一下就可以了。调用栈：</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>5: kd&gt; k</p>
<h1 id="Child-SP-RetAddr-Call-Site"><a href="#Child-SP-RetAddr-Call-Site" class="headerlink" title="Child-SP          RetAddr               Call Site"></a>Child-SP          RetAddr               Call Site</h1><p>00 ffffda82<code>7c0e6ad0 fffff807</code>3de99645     3_3_2_1_Driver!WorkItemRoutine+0xe [C:\Users\admin\source\repos\PraticalReverseEngineering\3.3.2(1)\Driver.cpp @ 78]<br>01 ffffda82<code>7c0e6b00 fffff807</code>3de52b65     nt!IopProcessWorkItem+0x135<br>02 ffffda82<code>7c0e6b70 fffff807</code>3de71d25     nt!ExpWorkerThread+0x105<br>03 ffffda82<code>7c0e6c10 fffff807</code>3e000628     nt!PspSystemThreadStartup+0x55<br>04 ffffda82<code>7c0e6c60 00000000</code>00000000     nt!KiStartSystemThread+0x28</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">可以看到 ExpWorkerThread。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 2</span></span><br><span class="line"></span><br><span class="line">&gt; 研究 IoAllocateWorkItem、IoInitializeWorkItem、IoQueueWorkItem、IopQueueWorkItemProlog 和 ExQueueWorkItem，解释它们是如何工作的。</span><br><span class="line"></span><br><span class="line">先看文档，[System Worker Threads](https:<span class="regexp">//</span>learn.microsoft.com<span class="regexp">/en-us/</span>windows-hardware<span class="regexp">/drivers/</span>kernel/system-worker-threads)，根据文档，使用 Work Item 分为三步：分配空间和初始化一个``IO_WORKITEM``结构（此过程使用 IoAllocateWorkItem 或 IoInitializeWorkItem）；指定 callback，将 WorkItem 入队（使用 IoQueueWorkItem）；不需要 WorkItem 后进行释放（对应第一步使用 IoFreeWorkItem 或者 IoUninitializeWorkItem）。</span><br><span class="line"></span><br><span class="line">- IoAllocateWorkItem，[文档](https:<span class="regexp">//</span>learn.microsoft.com<span class="regexp">/en-us/</span>windows-hardware<span class="regexp">/drivers/</span>ddi<span class="regexp">/wdm/</span>nf-wdm-ioinitializeworkitem)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>  7: kd&gt; uf Ioallocateworkitem<br>  nt!IoAllocateWorkItem:<br>  fffff807<code>3df417a0 4053            push    rbx   fffff807</code>3df417a2 4883ec20        sub     rsp,20h<br>  fffff807<code>3df417a6 488bd9          mov     rbx,rcx   fffff807</code>3df417a9 ba58000000      mov     edx,58h<br>  fffff807<code>3df417ae b900020000      mov     ecx,200h   fffff807</code>3df417b3 e89860ecff      call    nt!IopVerifierExAllocatePool (fffff807<code>3de07850)   fffff807</code>3df417b8 4885c0          test    rax,rax<br>  fffff807<code>3df417bb 7423            je      nt!IoAllocateWorkItem+0x40 (fffff807</code>3df417e0)  Branch</p>
<p>  nt!IoAllocateWorkItem+0x1d:<br>  fffff807<code>3df417bd 4883603800      and     qword ptr [rax+38h],0   fffff807</code>3df417c2 488d0d477df5ff  lea     rcx,[nt!IopProcessWorkItem (fffff807<code>3de99510)]   fffff807</code>3df417c9 48895828        mov     qword ptr [rax+28h],rbx<br>  fffff807<code>3df417cd c7404001000000  mov     dword ptr [rax+40h],1   fffff807</code>3df417d4 48832000        and     qword ptr [rax],0<br>  fffff807<code>3df417d8 48894810        mov     qword ptr [rax+10h],rcx   fffff807</code>3df417dc 48894018        mov     qword ptr [rax+18h],rax</p>
<p>  nt!IoAllocateWorkItem+0x40:<br>  fffff807<code>3df417e0 4883c420        add     rsp,20h   fffff807</code>3df417e4 5b              pop     rbx<br>  fffff807<code>3df417e5 c3              ret   <figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">``</span>nt!IopVerifierExAllocatePool<span class="string">``</span> 检查是否开启了验证（<span class="string">``</span>nt!ViVerifierEnabled<span class="string">``</span>），是则进行验证。随后调用<span class="string">``</span>ExAllocatePoolWithTag<span class="string">``</span>，在我的机器上，第一个参数<span class="string">``</span>POOL_TYPE<span class="string">``</span>为 <span class="number">200</span>h（<span class="string">``</span>NonPagedPoolNx<span class="string">``</span>），第二个参数 <span class="string">``</span>NumberOfBytes<span class="string">``</span> 为 <span class="number">58</span>h，（<span class="string">``</span>sizeof(_IO_WORKITEM)<span class="string">``</span>），第三个参数 <span class="string">``</span><span class="built_in">Tag</span><span class="string">``</span> 为 <span class="number">20206</span>F49h，是<span class="string">``</span>Io&lt;space&gt;&lt;space&gt;<span class="string">``</span>。这样就在非分页池中分配了一个 <span class="string">``</span>_IO_WORKITEM<span class="string">``</span>结构。</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!_IO_WORKITEM      +0x000 WorkItem         : _WORK_QUEUE_ITEM      +0x000 WorkItem.List            ; _LIST_ENTRY    ; 0      +0x010 WorkItem.WorkerRoutine; Ptr64        void; IopProcessWorkItem      +0x018 WorkItem.Parameter    ; Ptr64 void ; WorkItem      +0x020 Routine          : Ptr64     void          +0x028 IoObject         : Ptr64 Void            ; DeviceObject      +0x030 Context          : Ptr64 Void            ; 0      +0x038 WorkOnBehalfThread : Ptr64 _ETHREAD    ; 0      +0x040 Type             : Uint4B                ; 1      +0x044 ActivityId       : _GUID   <figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  随后设置结构中的各个字段，具体如注释。</span><br><span class="line"></span><br><span class="line">- IoInitializeWorkItem，[文档](https:<span class="regexp">//</span>learn.microsoft.com<span class="regexp">/en-us/</span>windows-hardware<span class="regexp">/drivers/</span>ddi<span class="regexp">/wdm/</span>nf-wdm-ioinitializeworkitem)，调用该函数之前需要自己分配一个空间用于存放 WorkItem</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!IoInitializeWorkItem:   fffff807</code>3df778f0 4883ec38        sub     rsp,38h<br>  fffff807<code>3df778f4 0fb701          movzx   eax,word ptr [rcx]   fffff807</code>3df778f7 41ba03000000    mov     r10d,3<br>  fffff807<code>3df778fd 66412bc2        sub     ax,r10w   fffff807</code>3df77901 458d42fe        lea     r8d,[r10-2]<br>  fffff807<code>3df77905 66413bc0        cmp     ax,r8w   fffff807</code>3df77909 0f87af7b1100    ja      nt!IoInitializeWorkItem+0x117bce (fffff807`3e08f4be)  Branch</p>
<p>  nt!IoInitializeWorkItem+0x1f:<br>  fffff807<code>3df7790f 4883623800      and     qword ptr [rdx+38h],0   fffff807</code>3df77914 488d05f51bf2ff  lea     rax,[nt!IopProcessWorkItem (fffff807<code>3de99510)]   fffff807</code>3df7791b 44894240        mov     dword ptr [rdx+40h],r8d<br>  fffff807<code>3df7791f 48894a28        mov     qword ptr [rdx+28h],rcx   fffff807</code>3df77923 48832200        and     qword ptr [rdx],0<br>  fffff807<code>3df77927 48894210        mov     qword ptr [rdx+10h],rax   fffff807</code>3df7792b 48895218        mov     qword ptr [rdx+18h],rdx<br>  fffff807<code>3df7792f 4883c438        add     rsp,38h   fffff807</code>3df77933 c3              ret<br>  <figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  有点区别但不大，都是进行一些检查，然后设置 IO_WORKITEM 结构的成员。</span><br><span class="line"></span><br><span class="line">- IoQueueWorkItem，[文档](https:<span class="regexp">//</span>learn.microsoft.com<span class="regexp">/en-us/</span>windows-hardware<span class="regexp">/drivers/</span>ddi<span class="regexp">/wdm/</span>nf-wdm-ioqueueworkitem)，将 WorkItem.Type 设置为 <span class="number">0</span>，Context 存在 r8， QueueType 存在 rbx，然后调用 IopQueueWorkItemProlog。</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!IoQueueWorkItem:<br>  fffff807<code>3df41950 4053            push    rbx   fffff807</code>3df41952 4883ec20        sub     rsp,20h<br>  fffff807<code>3df41956 83614000        and     dword ptr [rcx+40h],0   fffff807</code>3df4195a 418bd8          mov     ebx,r8d<br>  fffff807<code>3df4195d 4d8bc1          mov     r8,r9   fffff807</code>3df41960 e8f784edff      call    nt!IopQueueWorkItemProlog (fffff807<code>3de19e5c)   fffff807</code>3df41965 8bd3            mov     edx,ebx<br>  fffff807<code>3df41967 488bc8          mov     rcx,rax   nt!IoQueueWorkItem+0x1a:   fffff807</code>3df4196a e839000000      call    nt!ExQueueWorkItemFromIo (fffff807<code>3df419a8)   fffff807</code>3df4196f 4883c420        add     rsp,20h<br>  fffff807<code>3df41973 5b              pop     rbx   fffff807</code>3df41974 c3              ret<br>  <figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="operator">-</span> <span class="variable">IopQueueWorkItemProlog</span>，增加 <span class="built_in">DeviceObject</span> 的引用计数，把 <span class="built_in">Context</span> 存到 <span class="variable">WorkItem</span><span class="operator">.</span><span class="built_in">Context</span>，<span class="variable">WorkerRoutine</span> 存到 <span class="variable">WorkItem</span><span class="operator">.</span><span class="variable">WorkerRoutine</span>。除此之外就是一些检查。</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  nt!IopQueueWorkItemProlog:<br>  fffff807<code>3de19e5c 488bc4          mov     rax,rsp   fffff807</code>3de19e5f 48895810        mov     qword ptr [rax+10h],rbx<br>  fffff807<code>3de19e63 48896818        mov     qword ptr [rax+18h],rbp   fffff807</code>3de19e67 48897020        mov     qword ptr [rax+20h],rsi<br>  fffff807<code>3de19e6b 57              push    rdi   fffff807</code>3de19e6c 4883ec20        sub     rsp,20h<br>  fffff807<code>3de19e70 83600800        and     dword ptr [rax+8],0   fffff807</code>3de19e74 498bf0          mov     rsi,r8<br>  fffff807<code>3de19e77 488bea          mov     rbp,rdx   fffff807</code>3de19e7a 488bd9          mov     rbx,rcx<br>  fffff807<code>3de19e7d e896db0700      call    nt!IopIsActivityTracingEnabled (fffff807</code>3de97a18)<br>  fffff807<code>3de19e82 84c0            test    al,al   fffff807</code>3de19e84 0f852c712000    jne     nt!IopQueueWorkItemProlog+0x20715a (fffff807`3e020fb6)  Branch</p>
<p>  nt!IopQueueWorkItemProlog+0x2e:<br>  fffff807<code>3de19e8a 0f57c0          xorps   xmm0,xmm0   fffff807</code>3de19e8d 0f114344        movups  xmmword ptr [rbx+44h],xmm0</p>
<p>  nt!IopQueueWorkItemProlog+0x35:<br>  fffff807<code>3de19e91 658b0425ac320000 mov     eax,dword ptr gs:[32ACh]   fffff807</code>3de19e99 a901000100      test    eax,10001h<br>  fffff807<code>3de19e9e 742f            je      nt!IopQueueWorkItemProlog+0x73 (fffff807</code>3de19ecf)  Branch</p>
<p>  nt!IopQueueWorkItemProlog+0x44:<br>  fffff807<code>3de19ea0 488b4b28        mov     rcx,qword ptr [rbx+28h]   fffff807</code>3de19ea4 ba44666c74      mov     edx,746C6644h<br>  fffff807<code>3de19ea9 e8c2f0ffff      call    nt!ObfReferenceObjectWithTag (fffff807</code>3de18f70)<br>  fffff807<code>3de19eae 48896b20        mov     qword ptr [rbx+20h],rbp   fffff807</code>3de19eb2 488bc3          mov     rax,rbx<br>  fffff807<code>3de19eb5 488b6c2440      mov     rbp,qword ptr [rsp+40h]   fffff807</code>3de19eba 48897330        mov     qword ptr [rbx+30h],rsi<br>  fffff807<code>3de19ebe 488b5c2438      mov     rbx,qword ptr [rsp+38h]   fffff807</code>3de19ec3 488b742448      mov     rsi,qword ptr [rsp+48h]<br>  fffff807<code>3de19ec8 4883c420        add     rsp,20h   fffff807</code>3de19ecc 5f              pop     rdi<br>  fffff807<code>3de19ecd c3              ret   <figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- ExQueueWorkItem，[文档](https:<span class="regexp">//</span>learn.microsoft.com<span class="regexp">/en-us/</span>windows-hardware<span class="regexp">/drivers/</span>ddi<span class="regexp">/wdm/</span>nf-wdm-exqueueworkitem)，与上面函数不同，它不特定于某个 DevcieObject。</span><br><span class="line"></span><br></pre></td></tr></table></figure>   nt!ExQueueWorkItem:   fffff807</code>3de54130 48895c2408      mov     qword ptr [rsp+8],rbx<br>  fffff807<code>3de54135 57              push    rdi   fffff807</code>3de54136 4883ec30        sub     rsp,30h<br>  fffff807<code>3de5413a 4863da          movsxd  rbx,edx   fffff807</code>3de5413d 488bf9          mov     rdi,rcx<br>  fffff807<code>3de54140 8bd3            mov     edx,ebx   fffff807</code>3de54142 e861000000      call    nt!ExpValidateWorkItem (fffff807<code>3de541a8)   fffff807</code>3de54147 8bcb            mov     ecx,ebx<br>  nt!ExQueueWorkItem+0x19:<br>  fffff807<code>3de54149 e83a000000      call    nt!ExpTypeToPriority (fffff807</code>3de54188)<br>  fffff807<code>3de5414e 4c8b050b86aa00  mov     r8,qword ptr [nt!PspSystemPartition (fffff807</code>3e8fc760)]<br>  fffff807<code>3de54155 4183c9ff        or      r9d,0FFFFFFFFh   fffff807</code>3de54159 8364242000      and     dword ptr [rsp+20h],0<br>  fffff807<code>3de5415e 488bd7          mov     rdx,rdi   fffff807</code>3de54161 498b4810        mov     rcx,qword ptr [r8+10h]<br>  fffff807<code>3de54165 448bc0          mov     r8d,eax   fffff807</code>3de54168 e813dfffff      call    nt!ExpQueueWorkItem (fffff807<code>3de52080)   nt!ExQueueWorkItem+0x3d:   fffff807</code>3de5416d 84c0            test    al,al<br>  fffff807<code>3de5416f 0f845dcb1d00    je      nt!ExQueueWorkItem+0x1dcba2 (fffff807</code>3e030cd2)<br>  fffff807<code>3de54175 488b5c2440      mov     rbx,qword ptr [rsp+40h]   fffff807</code>3de5417a 4883c430        add     rsp,30h<br>  fffff807<code>3de5417e 5f              pop     rdi   fffff807</code>3de5417f c3              ret<br>  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">可以看到 ExpQueueWorkItem 接受的参数，rcx 是一个系统中的位置，应该是 WorkItem 的队列，rdx 是 WorkItem。据此猜测 ExpQueueWorkItem 将 WorkItem 插入队列。着急下班于是就结束了。</span><br><span class="line"></span><br><span class="line">然而第二天，我去验证书上所说的内容，尝试通过 (_ENODE *)Prcb-&gt;ParentNote 找到这个队列（PspSystemPartition），发现并找不到。一番查找后，发现了两篇文章（[[原创\]win10 1909逆向（win10内存分区浅析）](<span class="link">https://bbs.pediy.com/thread-266152.htm)、</span>[<span class="string">Work Items &amp; System Worker Threads</span>](https://www.matteomalvica.com/blog/2021/03/10/practical-re-win-solutions-ch3-work-items/)）都介绍了 SystemPartition，这里就不献丑了。简单来说，从 Windows 10  引入内存分区开始，这个 Queue 就不再保存在 ENODE 中，而是保存在系统分区中。</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  dx -r0 @$queue = ((nt!_EX_PARTITION*)(<em>(nt!_EPARTITION</em>*)&amp;nt!PspSystemPartition)-&gt;ExPartition)-&gt;WorkQueues[0][1],d</p>
<pre><code>
#### 3

&gt; Work item 和系统线程在功能上几乎是相同的，解释为什么 DPC 常将 work item 入队来处理请求，而从不调用 PsCreateSystemThread

work item 相对来说是比较轻量级的，PspCreateSystemThread 开销比较大，不适合在 DPC 的 DISPATCH_LEVEL 调用。

#### 4

&gt; 写一个驱动程序以美剧出系统中所有的 work item，并解释这个过程中你需要克服的难点。

咕咕咕

### 3.3.3 -

#### 1 未完成

&gt; 编写使用内核模式和用户模式 APC 的驱动。

KeIntializeApc 和 KeInsertQueueApc 包含在 ntoskrnl 中，如果使用 C++，需要在这两个函数前指定``extern &quot;C&quot;``。

APC 参考文章：

- [Inside NT&#39;s Asynchronous Procedure Call | Dr Dobb&#39;s (drdobbs.com)](https://www.drdobbs.com/inside-nts-asynchronous-procedure-call/184416590)

- [小Win，点一份APC（Apc机制详解）（一） | Anhkgg&#39;Lab ](https://anhkgg.com/win-apc-analyze1/)
- [APC Series: User APC Internals · Low Level Pleasure (repnz.github.io)](https://repnz.github.io/posts/apc/kernel-user-apc-api/)

其中 Low Level Pleasure 这篇文章提到了 User APC 也分 Special 和 Normal，具体没有说明。

实现见工程。可以发现，KernelRoutine 总是运行在 APC_LEVEL，而 NormalRoutine（如果有）则运行在 PASSIVE_LEVEL



#### 2

&gt; 编写一个驱动程序以美剧一个进程中所有线程上所有的用户模式和内核模式 APC。提示：执行枚举是要考虑到 IRQL 级别。



### 3.3.4



### x64后门程序
</code></pre>
</div><div class="article-licensing box"><div class="licensing-title"><p>《逆向工程实战》 习题</p><p><a href="http://example.com/2022/07/12/practical-reverse-engineering/">http://example.com/2022/07/12/practical-reverse-engineering/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>lll</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022-07-12</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022-10-16</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/windows/">windows</a><a class="link-muted mr-2" rel="tag" href="/tags/notes/">notes</a><a class="link-muted mr-2" rel="tag" href="/tags/reverse-engineering/">reverse-engineering</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/10/06/etw/"><span class="level-item">A Primer On Event Tracing For Windows (ETW)</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="lll"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">lll</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">52</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">7</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">29</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/1klnd" target="_blank" rel="noopener">关注我</a></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/CTF/"><span class="level-start"><span class="level-item">CTF</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Powershell/"><span class="level-start"><span class="level-item">Powershell</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/metasploit/"><span class="level-start"><span class="level-item">metasploit</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/notes/"><span class="level-start"><span class="level-item">notes</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/python/"><span class="level-start"><span class="level-item">python</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/vulnhub/"><span class="level-start"><span class="level-item">vulnhub</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"><span class="level-start"><span class="level-item">漏洞复现</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-12T05:56:35.000Z">2022-07-12</time></p><p class="title"><a href="/2022/07/12/practical-reverse-engineering/">《逆向工程实战》 习题</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-10-06T08:39:18.000Z">2021-10-06</time></p><p class="title"><a href="/2021/10/06/etw/">A Primer On Event Tracing For Windows (ETW)</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-18T13:39:32.000Z">2021-09-18</time></p><p class="title"><a href="/2021/09/18/PE/">PE 结构</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-08-30T05:59:59.000Z">2021-08-30</time></p><p class="title"><a href="/2021/08/30/struts2/">Struts2 漏洞 S2-001</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-22T03:51:23.000Z">2021-07-22</time></p><p class="title"><a href="/2021/07/22/vulhub-debug/">vulhub-debug</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">九月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/09/"><span class="level-start"><span class="level-item">九月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/CTF/"><span class="tag">CTF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Windows/"><span class="tag">Windows</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Writeup/"><span class="tag">Writeup</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/blackhat/"><span class="tag">blackhat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cheetsheet/"><span class="tag">cheetsheet</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cpp/"><span class="tag">cpp</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/crypto/"><span class="tag">crypto</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/db/"><span class="tag">db</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dev/"><span class="tag">dev</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/environment/"><span class="tag">environment</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/etw/"><span class="tag">etw</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/flask/"><span class="tag">flask</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java/"><span class="tag">java</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/metasploit/"><span class="tag">metasploit</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/network/"><span class="tag">network</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/notes/"><span class="tag">notes</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pentest/"><span class="tag">pentest</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/php/"><span class="tag">php</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/powershell/"><span class="tag">powershell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/protocol/"><span class="tag">protocol</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwn/"><span class="tag">pwn</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redteam/"><span class="tag">redteam</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/reverse-engineering/"><span class="tag">reverse-engineering</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssr/"><span class="tag">ssr</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vulnhub/"><span class="tag">vulnhub</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/windows/"><span class="tag">windows</span><span class="tag">5</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><ul class="menu-list"><li><a class="level is-mobile" href="#练习解答"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">练习解答</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-3"><span class="level-left"><span class="level-item">1.1.1</span><span class="level-item">1.3</span></span></a></li><li><a class="level is-mobile" href="#1-4"><span class="level-left"><span class="level-item">1.1.2</span><span class="level-item">1,4</span></span></a></li><li><a class="level is-mobile" href="#1-7"><span class="level-left"><span class="level-item">1.1.3</span><span class="level-item">1.7</span></span></a></li></ul></li></ul><li><a class="level is-mobile" href="#Child-SP-RetAddr-Call-Site"><span class="level-left"><span class="level-item">2</span><span class="level-item">Child-SP          RetAddr               Call Site</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="panic" height="28"></a><p class="is-size-7"><span>&copy; 2022 lll</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>